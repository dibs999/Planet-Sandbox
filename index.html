<!doctype html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#1b2b3a" />
    <meta name="description" content="Planetensimulation – Siedeln, Handeln, Terraformen" />
    <link rel="manifest" href="manifest.json" />
    <title>Planet Sandbox - Siedeln, Handeln, Terraformen</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700;800&family=Work+Sans:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --paper: #f8efe0;
        --paper-2: #ead6b8;
        --ink: #1d1a16;
        --muted: #5a4e44;
        --navy: #1b2b3a;
        --ocean: #234b5c;
        --brass: #b18a55;
        --brass-light: #d8b97a;
        --copper: #c86b3c;
        --panel: rgba(255, 251, 242, 0.86);
        --panel-strong: rgba(255, 251, 242, 0.96);
        --stroke: rgba(29, 26, 22, 0.18);
        --shadow: 0 20px 45px rgba(19, 17, 15, 0.18);
        --shadow-soft: 0 12px 25px rgba(19, 17, 15, 0.12);
        --success: #2f7a4b;
        --warning: #c58f2a;
        --danger: #b6422a;
        --glow: rgba(177, 138, 85, 0.4);
      }

      [data-theme="dark"] {
        --paper: #0d1117;
        --paper-2: #161b22;
        --ink: #e6edf3;
        --muted: #8b949e;
        --navy: #58a6ff;
        --ocean: #79c0ff;
        --brass: #d29922;
        --brass-light: #e3b341;
        --copper: #f78166;
        --panel: rgba(22, 27, 34, 0.92);
        --panel-strong: rgba(22, 27, 34, 0.98);
        --stroke: rgba(240, 246, 252, 0.1);
        --shadow: 0 20px 45px rgba(0, 0, 0, 0.4);
        --shadow-soft: 0 12px 25px rgba(0, 0, 0, 0.3);
        --glow: rgba(88, 166, 255, 0.3);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Work Sans", system-ui, -apple-system, sans-serif;
        color: var(--ink);
        background: linear-gradient(160deg, var(--paper) 0%, var(--paper-2) 60%, #ccb28e 100%);
        min-height: 100vh;
        position: relative;
      }

      body::before {
        content: "";
        position: fixed;
        inset: 0;
        background-image:
          radial-gradient(circle, rgba(27, 43, 58, 0.08) 1px, transparent 1px),
          radial-gradient(circle, rgba(27, 43, 58, 0.06) 1px, transparent 1px),
          radial-gradient(circle, rgba(27, 43, 58, 0.05) 1px, transparent 1px);
        background-size: 160px 160px, 220px 220px, 240px 240px;
        background-position: 0 0, 40px 70px, 120px 40px;
        opacity: 0.5;
        pointer-events: none;
      }

      .page {
        max-width: 1180px;
        margin: 0 auto;
        padding: 32px 24px 80px;
        position: relative;
        z-index: 1;
      }

      .hero {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        gap: 16px;
        padding: 24px 24px;
        background: var(--panel);
        border: 1px solid var(--stroke);
        border-radius: 20px;
        box-shadow: var(--shadow);
        position: relative;
        overflow: hidden;
        margin-top: 16px;
      }

      .hero::after {
        content: "";
        position: absolute;
        inset: 0;
        background:
          radial-gradient(circle at 50% 50%, rgba(177, 138, 85, 0.12), transparent 70%);
        pointer-events: none;
      }

      .hero-text,
      .hero-visual {
        position: relative;
        z-index: 1;
        width: 100%;
      }

      .hero-text {
        max-width: 800px;
        margin: 0 auto;
      }

      .hero-text {
        max-width: 800px;
        margin: 0 auto;
      }

      .eyebrow {
        text-transform: uppercase;
        letter-spacing: 0.2em;
        font-size: 0.7rem;
        color: var(--navy);
        margin: 0 0 12px;
      }

      h1 {
        font-family: "Cinzel", serif;
        font-size: clamp(2.4rem, 3.4vw, 3.7rem);
        margin: 0 0 12px;
      }

      h2 {
        font-family: "Cinzel", serif;
        font-size: 1.7rem;
        margin: 0 0 12px;
      }

      h3 {
        margin: 0 0 8px;
        font-size: 0.95rem;
        text-transform: uppercase;
        letter-spacing: 0.09em;
        color: var(--navy);
      }

      p {
        margin: 0;
        line-height: 1.6;
      }

      .lead {
        font-size: 1.05rem;
        color: var(--muted);
        max-width: 720px;
        margin: 0 auto;
      }

      .hero-actions {
        width: 100%;
        max-width: 800px;
        margin: 0 auto;
      }

      .badge-row {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 16px;
        justify-content: center;
      }

      .badge {
        padding: 6px 14px;
        border-radius: 999px;
        background: rgba(27, 43, 58, 0.08);
        border: 1px solid rgba(27, 43, 58, 0.22);
        font-size: 0.85rem;
      }

      .callout {
        margin-top: 18px;
        padding: 12px 14px;
        border-radius: 12px;
        background: rgba(177, 138, 85, 0.12);
        border-left: 4px solid var(--brass);
        color: var(--muted);
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
      }

      section {
        margin-top: 24px;
        animation: fadeUp 0.7s ease both;
      }

      section:nth-of-type(2) {
        animation-delay: 0.1s;
      }

      section:nth-of-type(3) {
        animation-delay: 0.18s;
      }

      section:nth-of-type(4) {
        animation-delay: 0.26s;
      }

      section:nth-of-type(5) {
        animation-delay: 0.34s;
      }

      .grid-2 {
        display: grid;
        gap: 20px;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      }

      .grid-3 {
        display: grid;
        gap: 20px;
        grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      }

      .grid-4 {
        display: grid;
        gap: 16px;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      }

      .card {
        background: var(--panel);
        border: 1px solid var(--stroke);
        border-radius: 12px;
        padding: 14px;
        box-shadow: var(--shadow-soft);
      }

      .card strong {
        color: var(--navy);
      }

      ul,
      ol {
        margin: 0;
        padding-left: 22px;
        color: var(--muted);
      }

      li {
        margin-bottom: 6px;
      }

      .planet-diorama {
        position: relative;
        width: min(320px, 100%);
        aspect-ratio: 1;
        margin: 0 auto;
        display: grid;
        place-items: center;
      }

      .planet {
        width: 180px;
        height: 180px;
        border-radius: 50%;
        background:
          radial-gradient(circle at 30% 30%, #fff5e2 0%, #f1d4a5 40%, #b5905b 100%),
          radial-gradient(circle at 70% 70%, rgba(35, 75, 92, 0.5), transparent 55%);
        border: 2px solid rgba(29, 26, 22, 0.25);
        box-shadow: inset 0 0 30px rgba(29, 26, 22, 0.2);
      }

      .orbit {
        position: absolute;
        border: 1px dashed rgba(177, 138, 85, 0.45);
        border-radius: 50%;
      }

      .orbit-one {
        width: 220px;
        height: 220px;
      }

      .orbit-two {
        width: 270px;
        height: 270px;
      }

      .orbit-three {
        width: 320px;
        height: 320px;
      }

      .ring {
        position: absolute;
        width: 240px;
        height: 70px;
        border-radius: 50%;
        border: 1px solid rgba(27, 43, 58, 0.35);
        transform: rotate(-12deg);
      }

      .colony-dot {
        position: absolute;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--copper);
        box-shadow: 0 0 0 7px rgba(200, 107, 60, 0.18);
        top: 18%;
        left: 62%;
      }

      .colony-dot.second {
        top: 62%;
        left: 30%;
        background: var(--brass);
        box-shadow: 0 0 0 7px rgba(177, 138, 85, 0.18);
      }

      .colony-dot.third {
        top: 38%;
        left: 18%;
        background: var(--ocean);
        box-shadow: 0 0 0 7px rgba(35, 75, 92, 0.18);
      }

      .legend {
        margin-top: 10px;
        font-size: 0.85rem;
        color: var(--muted);
      }

      .kpi-grid {
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(3, 1fr);
      }

      @media (max-width: 768px) {
        .kpi-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      @media (max-width: 480px) {
        .kpi-grid {
          grid-template-columns: 1fr;
        }
      }

      .kpi-card {
        background: var(--panel-strong);
        border: 1px solid var(--stroke);
        border-radius: 12px;
        padding: 12px;
        box-shadow: var(--shadow-soft);
        transition: all 0.2s ease;
      }

      .kpi-card[data-kpi="supply"][style*="--value:"] {
        --value-num: attr(data-value);
      }

      .kpi-card.warning {
        border-color: var(--warning);
        background: rgba(197, 143, 42, 0.1);
      }

      .kpi-card.danger {
        border-color: var(--danger);
        background: rgba(220, 38, 38, 0.1);
      }

      .kpi-title {
        font-size: 0.72rem;
        text-transform: uppercase;
        letter-spacing: 0.16em;
        color: var(--navy);
      }

      .kpi-value {
        font-family: "Cinzel", serif;
        font-size: 1.6rem;
        margin: 6px 0 2px;
      }

      .kpi-sub {
        font-size: 0.85rem;
        color: var(--muted);
      }

      .kpi-meter {
        height: 6px;
        background: rgba(27, 43, 58, 0.15);
        border-radius: 999px;
        margin-top: 10px;
        overflow: hidden;
      }

      .kpi-meter span {
        display: block;
        height: 100%;
        width: var(--value, 50%);
        background: linear-gradient(90deg, var(--brass-light), var(--copper));
      }

      .resource-grid {
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        margin-top: 12px;
      }

      .resource-item {
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.85);
        display: grid;
        gap: 6px;
      }

      .resource-head {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.85rem;
      }

      .resource-name {
        display: flex;
        align-items: center;
        gap: 6px;
        color: var(--navy);
        font-weight: 600;
      }

      .resource-amount {
        font-family: "Cinzel", serif;
        font-size: 0.95rem;
      }

      .resource-meter {
        height: 6px;
        background: rgba(27, 43, 58, 0.15);
        border-radius: 999px;
        overflow: hidden;
      }

      .resource-meter span {
        display: block;
        height: 100%;
        width: var(--value, 40%);
        background: linear-gradient(90deg, var(--ocean), var(--brass));
      }

      .resource-meta {
        display: flex;
        justify-content: space-between;
        font-size: 0.72rem;
        color: var(--muted);
      }

      .resource-delta {
        font-weight: 600;
      }

      .resource-delta.positive {
        color: var(--success);
      }

      .resource-delta.negative {
        color: var(--danger);
      }

      .effects-list {
        display: grid;
        gap: 8px;
        margin-top: 12px;
      }

      .effect-item {
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.8);
        font-size: 0.85rem;
        display: flex;
        justify-content: space-between;
        gap: 10px;
      }

      .effect-item strong {
        color: var(--navy);
      }

      .effect-item span {
        color: var(--muted);
        font-size: 0.78rem;
      }

      .tabs {
        background: var(--panel);
        border: 1px solid var(--stroke);
        border-radius: 20px;
        padding: 18px;
        box-shadow: var(--shadow-soft);
      }

      .tablist {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      .tab-button {
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.8);
        color: var(--navy);
        padding: 8px 14px;
        border-radius: 999px;
        font-size: 0.9rem;
        cursor: pointer;
      }

      .tab-button[aria-selected="true"] {
        background: var(--navy);
        color: #fff;
        border-color: var(--navy);
      }

      .tab-panel {
        margin-top: 16px;
      }

      .tab-panel[hidden] {
        display: none;
      }

      .chip-row {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 10px;
      }

      .chip {
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid rgba(27, 43, 58, 0.25);
        background: rgba(27, 43, 58, 0.08);
        font-size: 0.78rem;
      }

      /* Auth */
      .auth-bar {
        display: flex;
        gap: 8px;
        align-items: center;
        justify-content: flex-end;
        margin-bottom: 8px;
      }

      .auth-user {
        font-size: 0.85rem;
        color: var(--muted);
      }

      .auth-btn {
        padding: 6px 10px;
        border-radius: 8px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.9);
        cursor: pointer;
        font-size: 0.85rem;
      }

      .auth-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 999;
        padding: 20px;
      }

      .auth-overlay.is-open {
        display: flex;
      }

      .auth-dialog {
        width: min(380px, 100%);
        background: var(--panel-strong);
        border-radius: 18px;
        border: 1px solid var(--stroke);
        box-shadow: var(--shadow);
        padding: 18px;
      }

      .auth-dialog h3 {
        margin: 0 0 12px;
      }

      .auth-form {
        display: grid;
        gap: 10px;
      }

      .auth-form label {
        font-size: 0.85rem;
        color: var(--muted);
      }

      .auth-form input {
        width: 100%;
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.92);
        font-size: 0.95rem;
      }

      .auth-error {
        color: var(--danger);
        font-size: 0.85rem;
        min-height: 1.2em;
      }

      .auth-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        margin-top: 8px;
      }

      .route-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 12px;
      }

      .route {
        display: flex;
        flex-direction: column;
        gap: 10px;
        padding: 10px 16px;
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.92);
        border: 1px solid var(--stroke);
        font-size: 0.9rem;
        position: relative;
      }

      .route-main {
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .route-title {
        font-weight: 600;
        font-size: 1rem;
        color: var(--navy);
      }

      .route-meta {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 10px;
      }

      .route-progress {
        flex: 1;
        height: 6px;
        background: rgba(27, 43, 58, 0.12);
        border-radius: 999px;
        overflow: hidden;
      }

      .route-progress span {
        display: block;
        height: 100%;
        background: linear-gradient(90deg, var(--brass), var(--copper));
        width: 0%;
        transition: width 0.3s ease;
      }

      .route-cargo {
        font-size: 0.75rem;
        color: var(--muted);
      }

      .route-status {
        font-size: 0.75rem;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid rgba(27, 43, 58, 0.2);
      }

      .steps {
        display: grid;
        gap: 16px;
        grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
      }

      .step {
        background: var(--panel);
        border: 1px solid var(--stroke);
        border-radius: 16px;
        padding: 16px;
        box-shadow: var(--shadow-soft);
      }

      .step-num {
        width: 34px;
        height: 34px;
        border-radius: 50%;
        background: var(--brass);
        color: #fff;
        font-weight: 600;
        display: grid;
        place-items: center;
        margin-bottom: 10px;
        box-shadow: 0 8px 18px rgba(177, 138, 85, 0.35);
      }

      .chain-map {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
        margin-top: 12px;
      }

      .chain-legend {
        display: flex;
        flex-wrap: wrap;
        gap: 14px;
        align-items: center;
        margin-top: 10px;
        font-size: 0.85rem;
        color: var(--muted);
      }

      .legend-dot {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 6px;
        background: var(--brass);
      }

      .legend-dot.good {
        background: #2f7a4b;
      }

      .legend-dot.warn {
        background: #c58f2a;
      }

      .legend-dot.bad {
        background: #b6422a;
      }

      .chain-node {
        padding: 8px 28px 8px 12px;
        border-radius: 12px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.85);
        font-size: 0.9rem;
        position: relative;
        cursor: pointer;
        text-align: left;
      }

      .chain-node[data-status="good"] {
        --status-color: #2f7a4b;
      }

      .chain-node[data-status="warn"] {
        --status-color: #c58f2a;
      }

      .chain-node[data-status="bad"] {
        --status-color: #b6422a;
      }

      .node-indicator {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--status-color, var(--brass));
        box-shadow: 0 0 0 3px rgba(27, 43, 58, 0.12);
      }

      .chain-node .node-tag {
        display: block;
        font-size: 0.7rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--muted);
        margin-top: 4px;
      }

      .chain-node[aria-expanded="true"] {
        background: var(--navy);
        border-color: var(--navy);
        color: #fff;
      }

      .chain-node[aria-expanded="true"] .node-tag {
        color: rgba(255, 255, 255, 0.7);
      }

      .chain-node[aria-expanded="true"] .node-indicator {
        box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.2);
      }

      .chain-node:focus-visible {
        outline: 2px solid var(--brass);
        outline-offset: 2px;
      }

      .chain-node[data-tooltip]::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 130%;
        left: 50%;
        transform: translateX(-50%);
        background: var(--navy);
        color: #fff;
        padding: 6px 8px;
        border-radius: 8px;
        font-size: 0.72rem;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease;
      }

      .chain-node[data-tooltip]::before {
        content: "";
        position: absolute;
        bottom: 112%;
        left: 50%;
        transform: translateX(-50%);
        border-width: 6px;
        border-style: solid;
        border-color: var(--navy) transparent transparent transparent;
        opacity: 0;
        transition: opacity 0.2s ease;
      }

      .chain-node[data-tooltip]:hover::after,
      .chain-node[data-tooltip]:hover::before {
        opacity: 1;
      }

      .chain-link {
        color: var(--brass);
        font-weight: 600;
      }

      .subchain-group {
        display: grid;
        gap: 10px;
        margin-top: 12px;
      }

      .subchain {
        display: none;
        padding: 12px;
        border-radius: 12px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.85);
      }

      .subchain.is-open {
        display: block;
      }

      .subchain h4 {
        margin: 0 0 8px;
        font-size: 0.95rem;
        color: var(--navy);
      }

      .subchain-grid {
        display: grid;
        gap: 8px;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      }

      .subchain-row {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        padding: 6px 8px;
        border-radius: 10px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.8);
        font-size: 0.85rem;
      }

      .subchain-label {
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
        font-size: 0.7rem;
      }

      .subchain-value {
        color: var(--navy);
        font-weight: 600;
      }

      .subchain-value.good {
        color: #2f7a4b;
      }

      .subchain-value.warn {
        color: #c58f2a;
      }

      .subchain-value.bad {
        color: #b6422a;
      }

      .tier-grid {
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        margin-top: 12px;
      }

      .tier {
        padding: 14px;
        border-radius: 14px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.88);
      }

      .tier span {
        display: block;
        font-size: 0.72rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
        margin-bottom: 6px;
      }

      .sector-panel {
        display: grid;
        gap: 18px;
        grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
        align-items: center;
      }

      .sector-map {
        position: relative;
        height: 180px;
        border-radius: 14px;
        border: 1px solid var(--stroke);
        background:
          linear-gradient(135deg, rgba(35, 75, 92, 0.15), transparent 50%),
          repeating-linear-gradient(0deg, rgba(29, 26, 22, 0.08), rgba(29, 26, 22, 0.08) 1px, transparent 1px, transparent 22px),
          repeating-linear-gradient(90deg, rgba(29, 26, 22, 0.08), rgba(29, 26, 22, 0.08) 1px, transparent 1px, transparent 22px);
        overflow: hidden;
      }

      .map-marker {
        position: absolute;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        box-shadow: 0 0 0 6px rgba(200, 107, 60, 0.18);
        background: var(--copper);
      }

      .map-marker.ore {
        top: 22%;
        left: 68%;
      }

      .map-marker.water {
        top: 55%;
        left: 32%;
        background: var(--ocean);
        box-shadow: 0 0 0 6px rgba(35, 75, 92, 0.18);
      }

      .map-marker.risk {
        top: 70%;
        left: 58%;
        background: var(--brass);
        box-shadow: 0 0 0 6px rgba(177, 138, 85, 0.18);
      }

      .stat-list {
        display: grid;
        gap: 8px;
        margin-top: 12px;
      }

      .stat-row {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.8);
        font-size: 0.9rem;
      }

      .stat-label {
        color: var(--muted);
      }

      .stat-value {
        color: var(--navy);
        font-weight: 600;
      }

      .ui-layout {
        border: 1px dashed rgba(29, 26, 22, 0.35);
        border-radius: 18px;
        padding: 16px;
        background: rgba(255, 255, 255, 0.72);
      }

      .ui-frame {
        display: grid;
        grid-template-rows: auto 1fr auto;
        border: 1px solid var(--stroke);
        border-radius: 14px;
        overflow: hidden;
      }

      .ui-top,
      .ui-bottom {
        padding: 10px 14px;
        background: rgba(27, 43, 58, 0.08);
        font-size: 0.85rem;
      }

      .ui-body {
        display: grid;
        grid-template-columns: 1fr 2.3fr 1fr;
        min-height: 200px;
      }

      .ui-panel {
        padding: 12px;
        border-right: 1px solid var(--stroke);
        font-size: 0.85rem;
      }

      .ui-panel:last-child {
        border-right: none;
        border-left: 1px solid var(--stroke);
      }

      .ui-center {
        display: grid;
        place-items: center;
        background: radial-gradient(circle at 50% 45%, rgba(27, 43, 58, 0.15), transparent 60%);
        color: var(--muted);
        font-size: 0.9rem;
        gap: 8px;
      }

      .timeline {
        position: relative;
        display: grid;
        gap: 16px;
        margin-top: 12px;
        padding-left: 8px;
      }

      .timeline::before {
        content: "";
        position: absolute;
        left: 7px;
        top: 4px;
        bottom: 4px;
        width: 2px;
        background: rgba(27, 43, 58, 0.2);
      }

      .timeline-item {
        position: relative;
        padding-left: 26px;
      }

      .timeline-dot {
        position: absolute;
        left: -1px;
        top: 6px;
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: var(--brass);
        box-shadow: 0 0 0 6px rgba(177, 138, 85, 0.2);
      }

      .timeline-card {
        background: rgba(255, 255, 255, 0.85);
        border: 1px solid var(--stroke);
        border-radius: 12px;
        padding: 10px 12px;
        font-size: 0.9rem;
        color: var(--muted);
      }

      .warning-grid {
        display: grid;
        gap: 12px;
        margin-top: 12px;
      }

      .warning-card {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 10px;
        align-items: center;
        padding: 12px;
        border-radius: 14px;
        border: 1px solid var(--stroke);
        background: rgba(200, 107, 60, 0.12);
      }

      .warning-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--copper);
        display: grid;
        place-items: center;
        color: #fff;
        font-weight: 700;
        font-size: 0.95rem;
      }

      .planet-gallery {
        display: grid;
        gap: 14px;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        margin-top: 12px;
      }

      .planet-card {
        display: grid;
        gap: 8px;
        padding: 12px;
        border-radius: 14px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.85);
        text-align: center;
      }

      .planet-card .seed-button {
        width: 100%;
      }

      .planet-note {
        margin: 0;
        font-size: 0.85rem;
        color: var(--muted);
      }

      .seed-tag {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
      }

      .planet-meta {
        display: grid;
        gap: 4px;
        margin-top: 6px;
        text-align: left;
        font-size: 0.78rem;
        color: var(--muted);
      }

      .meta-row {
        display: flex;
        justify-content: space-between;
        gap: 8px;
      }

      .meta-value {
        color: var(--navy);
        font-weight: 600;
      }

      .planet-mini {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        margin: 0 auto;
        border: 2px solid rgba(29, 26, 22, 0.25);
        box-shadow: inset 0 0 18px rgba(29, 26, 22, 0.2);
      }

      .planet-mini.desert {
        background: radial-gradient(circle at 30% 30%, #fff2d2, #d4a56b);
      }

      .planet-mini.ocean {
        background: radial-gradient(circle at 30% 30%, #d1f1ff, #3a6c89);
      }

      .planet-mini.ice {
        background: radial-gradient(circle at 30% 30%, #f5fbff, #9db6cc);
      }

      .planet-mini.ember {
        background: radial-gradient(circle at 30% 30%, #ffe0c2, #b04d2a);
      }

      .planet-mini.forest {
        background: radial-gradient(circle at 30% 30%, #e2f8dd, #3f6f4a);
      }

      .planet-mini.metal {
        background: radial-gradient(circle at 30% 30%, #f0f0f0, #6b7783);
      }

      .seed-form {
        display: grid;
        gap: 10px;
        margin-top: 12px;
      }

      .seed-input {
        width: 100%;
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.9);
        font-size: 0.95rem;
        font-family: inherit;
      }

      .seed-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .seed-button {
        border: 1px solid var(--navy);
        background: var(--navy);
        color: #fff;
        padding: 8px 12px;
        border-radius: 10px;
        font-size: 0.85rem;
        cursor: pointer;
      }

      .seed-button.secondary {
        background: rgba(27, 43, 58, 0.08);
        color: var(--navy);
        border-color: var(--stroke);
      }

      .seed-button.tiny {
        padding: 4px 10px;
        font-size: 0.7rem;
      }

      .seed-button.secondary.tiny {
        background: rgba(27, 43, 58, 0.05);
      }

      .seed-output {
        display: grid;
        gap: 8px;
        margin-top: 12px;
      }

      .seed-feedback {
        margin: 0;
        font-size: 0.85rem;
        color: var(--muted);
      }

      .seed-row {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.85);
        font-size: 0.85rem;
      }

      .seed-row strong {
        color: var(--navy);
      }

      .archive-list {
        display: grid;
        gap: 10px;
        margin-top: 12px;
      }

      .archive-item {
        display: grid;
        gap: 10px;
        grid-template-columns: minmax(0, 1fr) auto;
        padding: 12px;
        border-radius: 12px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.85);
      }

      .archive-item.is-favorite {
        border-color: rgba(177, 138, 85, 0.6);
        box-shadow: 0 10px 18px rgba(177, 138, 85, 0.2);
      }

      .archive-seed {
        font-family: "Cinzel", serif;
        font-size: 1rem;
      }

      .archive-badge {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
        margin-top: 4px;
      }

      .archive-item.is-favorite .archive-badge {
        color: var(--brass);
      }

      .archive-meta {
        font-size: 0.78rem;
        color: var(--muted);
        margin-top: 6px;
      }

      .archive-actions {
        display: grid;
        gap: 6px;
      }

      .archive-actions .seed-button {
        padding: 6px 10px;
        font-size: 0.78rem;
      }

      .favorite-toggle.is-favorite {
        background: var(--brass);
        border-color: var(--brass);
        color: #fff;
      }

      .archive-empty {
        margin-top: 12px;
        font-size: 0.85rem;
        color: var(--muted);
      }

      .challenge-grid {
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        margin-top: 12px;
      }

      .challenge-card {
        padding: 12px;
        border-radius: 14px;
        border: 1px solid var(--stroke);
        background: rgba(27, 43, 58, 0.06);
      }

      .idea-grid {
        display: grid;
        gap: 16px;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }

      .idea-card {
        padding: 16px;
        border-radius: 16px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.88);
        box-shadow: var(--shadow-soft);
      }

      @keyframes fadeUp {
        from {
          opacity: 0;
          transform: translateY(12px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @media (max-width: 960px) {
        .hero {
          padding: 32px 24px;
        }
        .sector-panel {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 760px) {
        .ui-body {
          grid-template-columns: 1fr;
        }
        .ui-panel {
          border-right: none;
          border-bottom: 1px solid var(--stroke);
        }
        .ui-panel:last-child {
          border-left: none;
        }
        .archive-item {
          grid-template-columns: 1fr;
        }
        .archive-actions {
          grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
        }
      }

      @media (prefers-reduced-motion: reduce) {
        section {
          animation: none;
        }
      }

      /* Theme Toggle */
      .theme-toggle {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        display: flex;
        gap: 8px;
        align-items: center;
        padding: 8px 14px;
        border-radius: 999px;
        background: var(--panel-strong);
        border: 1px solid var(--stroke);
        box-shadow: var(--shadow-soft);
        cursor: pointer;
        font-size: 0.85rem;
        color: var(--ink);
        transition: all 0.3s ease;
      }

      .theme-toggle:hover {
        transform: scale(1.05);
        box-shadow: var(--shadow);
      }

      .theme-toggle svg {
        width: 18px;
        height: 18px;
        fill: currentColor;
      }

      /* View System */
      .view-container {
        display: none;
      }

      .view-container.active {
        display: block;
      }

      .view-container.active section {
        display: block;
      }

      /* Body padding für Topbar */
      body {
        padding-top: 56px;
      }

      /* Responsive Topbar */
      @media (max-width: 1024px) {
        .topbar-nav button {
          padding: 6px 8px;
          font-size: 0.8rem;
        }
        
        .topbar-logo {
          font-size: 1rem;
        }
        
        .sim-time-compact {
          display: none;
        }
      }

      @media (max-width: 768px) {
        .topbar {
          flex-wrap: wrap;
          height: auto;
          min-height: 56px;
          padding: 8px 12px;
        }
        
        .topbar-left {
          flex: 1 1 100%;
          order: 1;
          margin-bottom: 8px;
        }
        
        .topbar-center {
          flex: 1 1 auto;
          order: 2;
        }
        
        .topbar-right {
          flex: 1 1 auto;
          order: 3;
          justify-content: flex-end;
        }
        
        .topbar-nav {
          flex-wrap: wrap;
          gap: 4px;
        }
        
        .topbar-nav button {
          padding: 4px 8px;
          font-size: 0.75rem;
        }
        
        .topbar-logo {
          font-size: 0.9rem;
        }
        
        .sim-controls-compact {
          padding: 2px 4px;
        }
        
        .sim-btn-compact {
          padding: 4px 6px;
          font-size: 0.75rem;
          min-width: 28px;
        }
        
        .planet-switcher-compact {
          padding: 4px 8px;
          font-size: 0.75rem;
        }
        
        .topbar-btn {
          padding: 4px 8px;
          font-size: 0.75rem;
        }
      }

      @media (max-width: 480px) {
        .topbar-nav-more {
          display: none;
        }
        
        .topbar-nav button:nth-child(n+6) {
          display: none;
        }
      }

      /* 3D Planet */
      .planet-3d-container {
        perspective: 1000px;
        width: 100%;
        max-width: 300px;
        margin: 0 auto;
      }

      .planet-3d {
        width: 200px;
        height: 200px;
        margin: 0 auto;
        border-radius: 50%;
        background: 
          radial-gradient(circle at 25% 25%, rgba(255,255,255,0.5) 0%, transparent 50%),
          radial-gradient(circle at 30% 30%, #fff5e2 0%, #f1d4a5 30%, #b5905b 70%, #5a4030 100%);
        box-shadow: 
          inset -30px -30px 60px rgba(0,0,0,0.4),
          inset 10px 10px 40px rgba(255,255,255,0.2),
          0 0 60px rgba(177, 138, 85, 0.3);
        animation: planetRotate 60s linear infinite;
        position: relative;
        overflow: hidden;
      }

      .planet-3d::before {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: 50%;
        background: 
          repeating-linear-gradient(
            0deg,
            transparent 0%,
            transparent 8%,
            rgba(139, 90, 43, 0.15) 8%,
            rgba(139, 90, 43, 0.15) 12%,
            transparent 12%
          );
        animation: planetRotate 120s linear infinite reverse;
      }

      .planet-3d::after {
        content: "";
        position: absolute;
        top: 20%;
        left: 15%;
        width: 25%;
        height: 20%;
        background: rgba(35, 75, 92, 0.4);
        border-radius: 40% 60% 50% 50%;
        filter: blur(3px);
      }

      .planet-3d .continent {
        position: absolute;
        background: rgba(90, 128, 60, 0.5);
        border-radius: 40% 60% 50% 70%;
        filter: blur(2px);
      }

      .planet-3d .continent:nth-child(1) { top: 35%; left: 50%; width: 30%; height: 25%; }
      .planet-3d .continent:nth-child(2) { top: 60%; left: 25%; width: 20%; height: 15%; }
      .planet-3d .continent:nth-child(3) { top: 15%; left: 60%; width: 15%; height: 12%; }

      .planet-3d .clouds {
        position: absolute;
        inset: -5%;
        border-radius: 50%;
        background: 
          radial-gradient(ellipse at 20% 30%, rgba(255,255,255,0.4) 0%, transparent 30%),
          radial-gradient(ellipse at 70% 60%, rgba(255,255,255,0.3) 0%, transparent 25%),
          radial-gradient(ellipse at 40% 80%, rgba(255,255,255,0.25) 0%, transparent 20%);
        animation: cloudRotate 45s linear infinite;
      }

      .planet-atmosphere {
        position: absolute;
        inset: -8px;
        border-radius: 50%;
        background: radial-gradient(circle, transparent 60%, rgba(135, 206, 235, 0.15) 80%, rgba(135, 206, 235, 0.3) 100%);
        pointer-events: none;
      }

      .planet-ring {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 320px;
        height: 80px;
        margin-left: -160px;
        margin-top: -40px;
        border: 2px solid rgba(177, 138, 85, 0.4);
        border-radius: 50%;
        transform: rotateX(75deg) rotateZ(-15deg);
        box-shadow: 
          0 0 0 8px rgba(177, 138, 85, 0.1),
          0 0 0 16px rgba(177, 138, 85, 0.05);
      }

      .terminator {
        position: absolute;
        inset: 0;
        border-radius: 50%;
        background: linear-gradient(90deg, rgba(0,0,0,0.5) 0%, transparent 50%, transparent 100%);
        animation: terminatorMove 30s linear infinite;
      }

      @keyframes planetRotate {
        from { transform: rotateY(0deg); }
        to { transform: rotateY(360deg); }
      }

      @keyframes cloudRotate {
        from { transform: rotateZ(0deg); }
        to { transform: rotateZ(360deg); }
      }

      @keyframes terminatorMove {
        from { transform: rotateY(0deg); }
        to { transform: rotateY(360deg); }
      }

      /* Research Tree */
      .research-tree {
        display: flex;
        flex-direction: column;
        gap: 24px;
        padding: 20px;
        background: var(--panel);
        border-radius: 20px;
        border: 1px solid var(--stroke);
        overflow-x: auto;
      }

      .research-tier {
        display: flex;
        gap: 16px;
        align-items: flex-start;
        flex-wrap: wrap;
      }

      .research-tier-label {
        writing-mode: vertical-rl;
        text-orientation: mixed;
        transform: rotate(180deg);
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.15em;
        color: var(--muted);
        padding: 8px 4px;
        background: rgba(27, 43, 58, 0.08);
        border-radius: 8px;
        min-height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .research-node {
        position: relative;
        padding: 12px 16px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.9);
        border: 2px solid var(--stroke);
        min-width: 140px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .research-node:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-soft);
      }

      .research-node.unlocked {
        border-color: var(--success);
        background: rgba(47, 122, 75, 0.1);
      }

      .research-node.available {
        border-color: var(--brass);
        background: rgba(177, 138, 85, 0.1);
      }

      .research-node.locked {
        opacity: 0.5;
        border-style: dashed;
      }

      .research-node .node-icon {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: var(--navy);
        color: #fff;
        display: grid;
        place-items: center;
        font-size: 0.9rem;
        margin-bottom: 6px;
      }

      .research-node .node-title {
        font-weight: 600;
        font-size: 0.85rem;
        color: var(--ink);
      }

      .research-node .node-cost {
        font-size: 0.75rem;
        color: var(--muted);
        margin-top: 4px;
      }

      .research-layout {
        display: grid;
        gap: 20px;
        grid-template-columns: minmax(240px, 0.35fr) minmax(0, 0.65fr);
        align-items: flex-start;
        margin-top: 20px;
      }

      .research-queue-panel {
        padding: 18px;
        border-radius: 18px;
        border: 1px solid var(--stroke);
        background: var(--panel-strong);
        box-shadow: var(--shadow-soft);
      }

      .research-queue-panel h3 {
        margin: 0 0 10px;
        font-size: 1rem;
        color: var(--navy);
      }

      .research-queue-points {
        font-size: 0.85rem;
        color: var(--muted);
      }

      .research-queue-list {
        margin-top: 10px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-height: 260px;
        overflow-y: auto;
      }

      .research-queue-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px;
        border-radius: 12px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.9);
      }

      .research-queue-item.active {
        border-color: var(--brass);
        box-shadow: 0 0 0 1px rgba(177, 138, 85, 0.3);
      }

      .research-queue-item .queue-info strong {
        display: block;
        font-size: 0.85rem;
        color: var(--navy);
      }

      .research-queue-item .queue-info span {
        font-size: 0.75rem;
        color: var(--muted);
      }

      .research-queue-item .queue-meta {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 4px;
      }

      .research-queue-item .queue-remaining {
        font-size: 0.75rem;
        color: var(--muted);
      }

      .research-deps {
        margin-top: 12px;
        padding: 16px;
        border-radius: 14px;
        border: 1px solid var(--stroke);
        background: var(--panel);
        min-height: 110px;
      }

      .research-deps strong {
        display: block;
        margin-bottom: 8px;
        font-size: 0.85rem;
        color: var(--navy);
      }

      .research-deps-list {
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-size: 0.8rem;
        color: var(--muted);
      }

      .research-deps-list .state-fulfilled {
        color: var(--success);
      }

      .research-deps-list .state-missing {
        color: var(--danger);
      }

      .research-node.queued {
        border-color: var(--copper);
        background: rgba(200, 214, 233, 0.35);
      }

      .research-node .node-status {
        position: absolute;
        top: -6px;
        right: -6px;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: var(--success);
        color: #fff;
        display: grid;
        place-items: center;
        font-size: 0.65rem;
      }

      .research-connector {
        position: absolute;
        height: 2px;
        background: var(--stroke);
        top: 50%;
        right: -18px;
        width: 16px;
      }

      /* Diplomacy Panel */
      .diplomacy-grid {
        display: grid;
        gap: 16px;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      }

      .faction-card {
        padding: 18px;
        border-radius: 16px;
        background: var(--panel);
        border: 1px solid var(--stroke);
        box-shadow: var(--shadow-soft);
      }

      .faction-header {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-bottom: 14px;
      }

      .faction-emblem {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: grid;
        place-items: center;
        font-size: 1.4rem;
        color: #fff;
      }

      .faction-emblem.tech { background: linear-gradient(135deg, #3a7bd5, #00d2ff); }
      .faction-emblem.eco { background: linear-gradient(135deg, #134e5e, #71b280); }
      .faction-emblem.corp { background: linear-gradient(135deg, #b8860b, #ffd700); }
      .faction-emblem.militant { background: linear-gradient(135deg, #8b0000, #dc143c); }

      .faction-info h4 {
        margin: 0 0 4px;
        font-size: 1rem;
      }

      .faction-info span {
        font-size: 0.8rem;
        color: var(--muted);
      }

      .faction-relations {
        margin: 12px 0;
      }

      .relation-bar {
        height: 8px;
        background: rgba(27, 43, 58, 0.15);
        border-radius: 999px;
        overflow: hidden;
        margin-top: 6px;
      }

      .relation-fill {
        height: 100%;
        border-radius: 999px;
        transition: width 0.5s ease;
      }

      .relation-fill.hostile { background: linear-gradient(90deg, var(--danger), #ff6b6b); }
      .relation-fill.neutral { background: linear-gradient(90deg, var(--warning), #ffd93d); }
      .relation-fill.friendly { background: linear-gradient(90deg, var(--success), #6bcb77); }
      .relation-fill.allied { background: linear-gradient(90deg, var(--navy), var(--ocean)); }

      .faction-treaties {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 10px;
      }

      .treaty-badge {
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 0.72rem;
        background: rgba(47, 122, 75, 0.15);
        color: var(--success);
        border: 1px solid rgba(47, 122, 75, 0.3);
      }

      .treaty-badge.pending {
        background: rgba(197, 143, 42, 0.15);
        color: var(--warning);
        border-color: rgba(197, 143, 42, 0.3);
      }

      /* Sankey / Flow Diagram */
      .flow-diagram {
        padding: 20px;
        background: var(--panel);
        border-radius: 18px;
        border: 1px solid var(--stroke);
        overflow-x: auto;
      }

      .flow-container {
        display: flex;
        gap: 40px;
        align-items: stretch;
        min-height: 300px;
        position: relative;
      }

      .flow-column {
        display: flex;
        flex-direction: column;
        gap: 12px;
        justify-content: center;
        min-width: 120px;
      }

      .flow-node {
        padding: 10px 14px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid var(--stroke);
        font-size: 0.85rem;
        text-align: center;
        position: relative;
      }

      .flow-node.source { border-left: 4px solid var(--ocean); }
      .flow-node.process { border-left: 4px solid var(--brass); }
      .flow-node.output { border-left: 4px solid var(--success); }
      .flow-node.consumer { border-left: 4px solid var(--copper); }

      .flow-node .flow-value {
        font-size: 0.7rem;
        color: var(--muted);
        margin-top: 4px;
      }

      .flow-paths {
        position: absolute;
        inset: 0;
        pointer-events: none;
        overflow: visible;
      }

      .flow-paths svg {
        width: 100%;
        height: 100%;
        overflow: visible;
      }

      .flow-path {
        fill: none;
        stroke: var(--brass);
        stroke-width: 2;
        opacity: 0.4;
      }

      /* Stats Dashboard */
      .stats-dashboard {
        display: grid;
        gap: 16px;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      }

      .stat-chart {
        padding: 16px;
        background: var(--panel);
        border-radius: 16px;
        border: 1px solid var(--stroke);
      }

      .stat-chart h4 {
        margin: 0 0 12px;
        font-size: 0.85rem;
        color: var(--navy);
      }

      .chart-area {
        height: 120px;
        display: flex;
        align-items: flex-end;
        gap: 4px;
        padding: 8px 0;
        border-bottom: 1px solid var(--stroke);
      }

      .chart-bar {
        flex: 1;
        background: linear-gradient(to top, var(--brass), var(--brass-light));
        border-radius: 4px 4px 0 0;
        min-height: 4px;
        transition: height 0.3s ease;
        position: relative;
      }

      .chart-bar:hover {
        opacity: 0.8;
      }

      .chart-bar::after {
        content: attr(data-value);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        font-size: 0.65rem;
        color: var(--muted);
        opacity: 0;
        transition: opacity 0.2s;
        white-space: nowrap;
      }

      .chart-bar:hover::after {
        opacity: 1;
      }

      .chart-labels {
        display: flex;
        justify-content: space-between;
        font-size: 0.7rem;
        color: var(--muted);
        margin-top: 6px;
      }

      .line-chart {
        height: 120px;
        position: relative;
        border-bottom: 1px solid var(--stroke);
      }

      .line-chart svg {
        width: 100%;
        height: 100%;
      }

      .line-chart .chart-line {
        fill: none;
        stroke: var(--ocean);
        stroke-width: 2;
      }

      .line-chart .chart-area-fill {
        fill: url(#chartGradient);
        opacity: 0.3;
      }

      /* Biome Gallery */
      .biome-gallery {
        display: grid;
        gap: 16px;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }

      .biome-card {
        padding: 16px;
        border-radius: 16px;
        border: 1px solid var(--stroke);
        background: var(--panel);
        text-align: center;
        transition: transform 0.2s ease;
      }

      .biome-card:hover {
        transform: translateY(-4px);
      }

      .biome-preview {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        margin: 0 auto 12px;
        border: 3px solid rgba(255,255,255,0.5);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      }

      .biome-preview.tundra { background: linear-gradient(135deg, #e8f4f8, #a8d8ea, #87ceeb); }
      .biome-preview.desert { background: linear-gradient(135deg, #ffecd2, #d4a574, #c19a6b); }
      .biome-preview.ocean { background: linear-gradient(135deg, #667db6, #0082c8, #0052d4); }
      .biome-preview.jungle { background: linear-gradient(135deg, #56ab2f, #134e5e, #0f4c3a); }
      .biome-preview.volcanic { background: linear-gradient(135deg, #ed4264, #ff6a00, #cc2b1d); }
      .biome-preview.plains { background: linear-gradient(135deg, #a8e063, #56ab2f, #78a845); }
      .biome-preview.mountain { background: linear-gradient(135deg, #757f9a, #d7dde8, #8e9eab); }
      .biome-preview.swamp { background: linear-gradient(135deg, #134e5e, #3a6073, #2c5530); }

      .biome-card h4 {
        margin: 0 0 6px;
        font-size: 0.95rem;
      }

      .biome-card p {
        font-size: 0.8rem;
        color: var(--muted);
        margin: 0 0 10px;
      }

      .biome-stats {
        display: flex;
        justify-content: center;
        gap: 12px;
        font-size: 0.75rem;
      }

      .biome-stats span {
        padding: 3px 8px;
        border-radius: 999px;
        background: rgba(27, 43, 58, 0.08);
      }

      /* Build Editor */
      .build-editor {
        display: grid;
        gap: 20px;
        grid-template-columns: 200px 1fr;
      }

      .build-palette {
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 420px;
        overflow-y: auto;
        padding-right: 4px;
      }

      .build-item {
        padding: 10px 12px;
        border-radius: 10px;
        background: var(--panel);
        border: 1px solid var(--stroke);
        cursor: grab;
        display: flex;
        gap: 10px;
        align-items: center;
        font-size: 0.85rem;
        transition: all 0.2s ease;
      }

      .build-item.is-locked {
        opacity: 0.45;
        cursor: not-allowed;
      }

      .build-item.is-locked:hover {
        background: var(--panel);
        border-color: var(--stroke);
      }

      .build-item .item-text {
        display: flex;
        flex-direction: column;
        gap: 2px;
        flex: 1;
      }

      .build-item .item-meta,
      .build-item .item-cost {
        font-size: 0.72rem;
        color: var(--muted);
      }

      .build-item .item-cost {
        margin-left: auto;
      }

      .build-item:hover {
        background: rgba(177, 138, 85, 0.15);
        border-color: var(--brass);
      }

      .build-item.selected {
        background: var(--navy);
        color: #fff;
        border-color: var(--navy);
      }

      .build-item .item-icon {
        width: 28px;
        height: 28px;
        border-radius: 6px;
        background: rgba(27, 43, 58, 0.1);
        display: grid;
        place-items: center;
      }

      .build-grid {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 2px;
        padding: 16px;
        background: var(--panel);
        border-radius: 16px;
        border: 1px solid var(--stroke);
        aspect-ratio: 16/10;
      }

      .build-cell {
        aspect-ratio: 1;
        background: rgba(27, 43, 58, 0.05);
        border: 1px solid rgba(27, 43, 58, 0.1);
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .build-cell:hover {
        background: rgba(177, 138, 85, 0.2);
        border-color: var(--brass);
      }

      .build-cell.occupied {
        background: var(--ocean);
        border-color: var(--navy);
      }

      .build-cell.radius {
        background: rgba(47, 122, 75, 0.15);
        border-color: rgba(47, 122, 75, 0.3);
      }

      /* Glossary Modal */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .modal-overlay.is-open {
        opacity: 1;
        visibility: visible;
      }

      .modal {
        background: var(--panel-strong);
        border-radius: 20px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow: hidden;
        box-shadow: var(--shadow);
        transform: scale(0.9) translateY(20px);
        transition: transform 0.3s ease;
      }

      .modal-overlay.is-open .modal {
        transform: scale(1) translateY(0);
      }

      .modal-header {
        padding: 18px 20px;
        border-bottom: 1px solid var(--stroke);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-header h3 {
        margin: 0;
        font-size: 1.1rem;
      }

      .modal-close {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: none;
        background: rgba(27, 43, 58, 0.1);
        cursor: pointer;
        display: grid;
        place-items: center;
        font-size: 1.2rem;
        color: var(--muted);
        transition: all 0.2s ease;
      }

      .modal-close:hover {
        background: var(--danger);
        color: #fff;
      }

      .modal-body {
        padding: 20px;
        overflow-y: auto;
        max-height: calc(80vh - 80px);
      }

      .glossary-search {
        width: 100%;
        padding: 10px 14px;
        border-radius: 10px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.8);
        font-size: 0.95rem;
        margin-bottom: 16px;
      }

      .glossary-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .glossary-item {
        padding: 12px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.6);
        border: 1px solid var(--stroke);
      }

      .glossary-item dt {
        font-weight: 600;
        color: var(--navy);
        margin-bottom: 4px;
      }

      .glossary-item dd {
        margin: 0;
        font-size: 0.9rem;
        color: var(--muted);
      }

      /* Achievements */
      .achievement-grid {
        display: grid;
        gap: 14px;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      }

      .achievement-card {
        padding: 16px;
        border-radius: 14px;
        background: var(--panel);
        border: 1px solid var(--stroke);
        text-align: center;
        position: relative;
        overflow: hidden;
      }

      .achievement-card.locked {
        opacity: 0.5;
        filter: grayscale(0.8);
      }

      .achievement-card.unlocked {
        border-color: var(--brass);
        box-shadow: 0 0 20px rgba(177, 138, 85, 0.2);
      }

      .achievement-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        margin: 0 auto 10px;
        display: grid;
        place-items: center;
        font-size: 1.5rem;
        background: linear-gradient(135deg, var(--brass), var(--copper));
        color: #fff;
        box-shadow: 0 4px 12px rgba(177, 138, 85, 0.3);
      }

      .achievement-card.locked .achievement-icon {
        background: rgba(27, 43, 58, 0.2);
        box-shadow: none;
      }

      .achievement-card h4 {
        margin: 0 0 6px;
        font-size: 0.9rem;
      }

      .achievement-card p {
        margin: 0;
        font-size: 0.78rem;
        color: var(--muted);
      }

      .achievement-rarity {
        position: absolute;
        top: 8px;
        right: 8px;
        padding: 3px 8px;
        border-radius: 999px;
        font-size: 0.65rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .achievement-rarity.common { background: rgba(27, 43, 58, 0.1); color: var(--muted); }
      .achievement-rarity.rare { background: rgba(88, 166, 255, 0.15); color: var(--navy); }
      .achievement-rarity.epic { background: rgba(138, 43, 226, 0.15); color: #8a2be2; }
      .achievement-rarity.legendary { background: rgba(255, 215, 0, 0.2); color: #b8860b; }

      .achievement-progress {
        margin-top: 10px;
        height: 4px;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 2px;
        overflow: hidden;
      }

      .achievement-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--brass), var(--copper));
        transition: width 0.3s ease;
        border-radius: 2px;
      }

      .achievement-progress-text {
        font-size: 0.7rem;
        color: var(--muted);
        margin-top: 4px;
        text-align: center;
      }

      /* Roadmap */
      .roadmap {
        position: relative;
        padding: 20px 0;
      }

      .roadmap::before {
        content: "";
        position: absolute;
        left: 50%;
        top: 0;
        bottom: 0;
        width: 4px;
        background: linear-gradient(to bottom, var(--brass), var(--ocean), var(--success));
        border-radius: 999px;
        transform: translateX(-50%);
      }

      .roadmap-phase {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        gap: 20px;
        align-items: center;
        margin-bottom: 30px;
      }

      .roadmap-phase:nth-child(odd) .phase-content { grid-column: 1; text-align: right; }
      .roadmap-phase:nth-child(odd) .phase-marker { grid-column: 2; }
      .roadmap-phase:nth-child(odd) .phase-details { grid-column: 3; }

      .roadmap-phase:nth-child(even) .phase-content { grid-column: 3; }
      .roadmap-phase:nth-child(even) .phase-marker { grid-column: 2; }
      .roadmap-phase:nth-child(even) .phase-details { grid-column: 1; text-align: right; }

      .phase-marker {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: var(--panel-strong);
        border: 4px solid var(--brass);
        display: grid;
        place-items: center;
        font-weight: 700;
        color: var(--navy);
        z-index: 1;
      }

      .phase-marker.completed {
        background: var(--success);
        border-color: var(--success);
        color: #fff;
      }

      .phase-marker.current {
        background: var(--brass);
        border-color: var(--brass);
        color: #fff;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%, 100% { box-shadow: 0 0 0 0 rgba(177, 138, 85, 0.5); }
        50% { box-shadow: 0 0 0 12px rgba(177, 138, 85, 0); }
      }

      .phase-content h4 {
        margin: 0 0 4px;
        font-size: 1rem;
      }

      .phase-content span {
        font-size: 0.8rem;
        color: var(--muted);
      }

      .phase-details {
        font-size: 0.85rem;
        color: var(--muted);
      }

      .phase-details ul {
        margin: 0;
        padding-left: 18px;
      }

      /* Community Seeds */
      .community-seeds {
        display: grid;
        gap: 14px;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      }

      .community-seed-card {
        padding: 16px;
        border-radius: 14px;
        background: var(--panel);
        border: 1px solid var(--stroke);
        position: relative;
      }

      .seed-author {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-bottom: 10px;
      }

      .author-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--navy), var(--ocean));
        color: #fff;
        display: grid;
        place-items: center;
        font-size: 0.8rem;
        font-weight: 600;
      }

      .author-info {
        flex: 1;
      }

      .author-info strong {
        display: block;
        font-size: 0.85rem;
      }

      .author-info span {
        font-size: 0.75rem;
        color: var(--muted);
      }

      .seed-difficulty {
        position: absolute;
        top: 12px;
        right: 12px;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 0.7rem;
        text-transform: uppercase;
      }

      .seed-difficulty.easy { background: rgba(47, 122, 75, 0.15); color: var(--success); }
      .seed-difficulty.medium { background: rgba(197, 143, 42, 0.15); color: var(--warning); }
      .seed-difficulty.hard { background: rgba(182, 66, 42, 0.15); color: var(--danger); }
      .seed-difficulty.extreme { background: rgba(138, 43, 226, 0.15); color: #8a2be2; }

      .community-seed-card .seed-code {
        font-family: "Cinzel", serif;
        font-size: 1.1rem;
        color: var(--navy);
        margin-bottom: 6px;
      }

      .community-seed-card .seed-desc {
        font-size: 0.85rem;
        color: var(--muted);
        margin-bottom: 10px;
      }

      .seed-stats {
        display: flex;
        gap: 12px;
        font-size: 0.8rem;
        color: var(--muted);
      }

      .seed-stats span {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      /* Soundtrack Player */
      .soundtrack-player {
        position: fixed;
        bottom: 80px;
        right: 20px;
        z-index: 999;
        padding: 12px 16px;
        border-radius: 16px;
        background: var(--panel-strong);
        border: 1px solid var(--stroke);
        box-shadow: var(--shadow);
        display: flex;
        gap: 12px;
        align-items: center;
        min-width: 240px;
      }

      .player-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: none;
        background: var(--navy);
        color: #fff;
        cursor: pointer;
        display: grid;
        place-items: center;
        transition: all 0.2s ease;
      }

      .player-btn:hover {
        transform: scale(1.1);
      }

      .player-info {
        flex: 1;
      }

      .player-track {
        font-size: 0.85rem;
        font-weight: 500;
        margin-bottom: 4px;
      }

      .player-progress {
        height: 4px;
        background: rgba(27, 43, 58, 0.15);
        border-radius: 999px;
        overflow: hidden;
      }

      .player-progress span {
        display: block;
        height: 100%;
        width: 35%;
        background: var(--brass);
        border-radius: 999px;
      }

      .player-volume {
        width: 24px;
        height: 24px;
        color: var(--muted);
        cursor: pointer;
      }

      /* Notifications */
      .notification-center {
        position: fixed;
        top: 70px;
        right: 20px;
        z-index: 1001;
        width: 320px;
        max-height: calc(100vh - 100px);
        overflow: hidden;
        border-radius: 16px;
        background: var(--panel-strong);
        border: 1px solid var(--stroke);
        box-shadow: var(--shadow);
        transform: translateX(120%);
        transition: transform 0.3s ease;
      }

      .notification-center.is-open {
        transform: translateX(0);
      }

      .notification-header {
        padding: 14px 16px;
        border-bottom: 1px solid var(--stroke);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .notification-header h4 {
        margin: 0;
        font-size: 0.95rem;
      }

      .notification-badge {
        padding: 2px 8px;
        border-radius: 999px;
        background: var(--danger);
        color: #fff;
        font-size: 0.75rem;
      }

      .notification-list {
        max-height: 400px;
        overflow-y: auto;
        padding: 8px;
      }

      .notification-item {
        padding: 12px;
        border-radius: 10px;
        margin-bottom: 6px;
        background: rgba(255, 255, 255, 0.5);
        border-left: 3px solid var(--brass);
        font-size: 0.85rem;
      }

      .notification-item.warning { border-color: var(--warning); }
      .notification-item.danger { border-color: var(--danger); }
      .notification-item.success { border-color: var(--success); }

      .notification-item time {
        display: block;
        font-size: 0.72rem;
        color: var(--muted);
        margin-top: 4px;
      }

      .notification-toggle {
        position: fixed;
        top: 20px;
        right: 80px;
        z-index: 1000;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 1px solid var(--stroke);
        background: var(--panel-strong);
        box-shadow: var(--shadow-soft);
        cursor: pointer;
        display: grid;
        place-items: center;
        font-size: 1.1rem;
      }

      .notification-toggle .badge {
        position: absolute;
        top: -4px;
        right: -4px;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: var(--danger);
        color: #fff;
        font-size: 0.7rem;
        display: grid;
        place-items: center;
      }

      /* Catastrophe Simulator */
      .catastrophe-sim {
        display: grid;
        gap: 20px;
        grid-template-columns: 1fr 1fr;
      }

      .catastrophe-controls {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .catastrophe-type {
        padding: 12px;
        border-radius: 12px;
        background: var(--panel);
        border: 2px solid var(--stroke);
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .catastrophe-type:hover,
      .catastrophe-type.selected {
        border-color: var(--danger);
        background: rgba(182, 66, 42, 0.1);
      }

      .catastrophe-type h4 {
        margin: 0 0 4px;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .catastrophe-type p {
        margin: 0;
        font-size: 0.8rem;
        color: var(--muted);
      }

      .catastrophe-preview {
        padding: 20px;
        border-radius: 16px;
        background: var(--panel);
        border: 1px solid var(--stroke);
        text-align: center;
      }

      .preview-comparison {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        margin-top: 16px;
      }

      .preview-state {
        padding: 14px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.6);
        border: 1px solid var(--stroke);
      }

      .preview-state h5 {
        margin: 0 0 10px;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
      }

      .preview-state .stat {
        display: flex;
        justify-content: space-between;
        font-size: 0.85rem;
        margin-bottom: 6px;
      }

      .preview-state .stat.negative {
        color: var(--danger);
      }

      .preview-state .stat.positive {
        color: var(--success);
      }

      /* Export Panel */
      .export-panel {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        padding: 16px;
        background: var(--panel);
        border-radius: 14px;
        border: 1px solid var(--stroke);
      }

      .export-btn {
        padding: 10px 18px;
        border-radius: 10px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.8);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
        transition: all 0.2s ease;
      }

      .export-btn:hover {
        background: var(--navy);
        color: #fff;
        border-color: var(--navy);
      }

      /* Multiplayer Concept */
      .multiplayer-modes {
        display: grid;
        gap: 16px;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }

      .mode-card {
        padding: 20px;
        border-radius: 16px;
        background: var(--panel);
        border: 1px solid var(--stroke);
        text-align: center;
      }

      .mode-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        margin: 0 auto 14px;
        display: grid;
        place-items: center;
        font-size: 1.6rem;
      }

      .mode-icon.coop { background: linear-gradient(135deg, var(--success), #6bcb77); color: #fff; }
      .mode-icon.pvp { background: linear-gradient(135deg, var(--danger), #ff6b6b); color: #fff; }
      .mode-icon.race { background: linear-gradient(135deg, var(--brass), var(--copper)); color: #fff; }
      .mode-icon.trade { background: linear-gradient(135deg, var(--ocean), var(--navy)); color: #fff; }

      .mode-card h4 {
        margin: 0 0 8px;
        font-size: 1rem;
      }

      .mode-card p {
        margin: 0 0 12px;
        font-size: 0.85rem;
        color: var(--muted);
      }

      .mode-features {
        text-align: left;
        font-size: 0.8rem;
      }

      .mode-features li {
        margin-bottom: 4px;
      }

      /* Modding Docs */
      .modding-docs {
        display: grid;
        gap: 16px;
      }

      .code-block {
        padding: 16px;
        border-radius: 12px;
        background: #1e1e1e;
        color: #d4d4d4;
        font-family: "Fira Code", "Consolas", monospace;
        font-size: 0.82rem;
        overflow-x: auto;
      }

      .code-block .keyword { color: #569cd6; }
      .code-block .string { color: #ce9178; }
      .code-block .number { color: #b5cea8; }
      .code-block .comment { color: #6a9955; }

      .api-endpoint {
        padding: 14px;
        border-radius: 12px;
        background: var(--panel);
        border: 1px solid var(--stroke);
        margin-bottom: 12px;
      }

      .api-endpoint .method {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-right: 10px;
      }

      .api-endpoint .method.get { background: rgba(47, 122, 75, 0.15); color: var(--success); }
      .api-endpoint .method.post { background: rgba(88, 166, 255, 0.15); color: var(--navy); }
      .api-endpoint .method.put { background: rgba(197, 143, 42, 0.15); color: var(--warning); }

      .api-endpoint .path {
        font-family: monospace;
        color: var(--navy);
      }

      .api-endpoint p {
        margin: 8px 0 0;
        font-size: 0.85rem;
        color: var(--muted);
      }

      /* Weather Animation */
      .weather-overlay {
        position: absolute;
        inset: 0;
        pointer-events: none;
        overflow: hidden;
        border-radius: inherit;
      }

      .weather-storm {
        position: absolute;
        width: 60px;
        height: 60px;
        background: radial-gradient(circle, rgba(139, 69, 19, 0.4), transparent 70%);
        border-radius: 50%;
        animation: stormMove 8s linear infinite;
      }

      .weather-storm:nth-child(1) { top: 20%; left: 10%; animation-delay: 0s; }
      .weather-storm:nth-child(2) { top: 50%; left: 60%; animation-delay: 3s; animation-duration: 10s; }
      .weather-storm:nth-child(3) { top: 70%; left: 30%; animation-delay: 5s; animation-duration: 12s; }

      @keyframes stormMove {
        0% { transform: translateX(0) scale(1); opacity: 0.5; }
        50% { transform: translateX(30px) scale(1.2); opacity: 0.8; }
        100% { transform: translateX(60px) scale(1); opacity: 0.5; }
      }

      .weather-rain {
        position: absolute;
        width: 2px;
        height: 15px;
        background: linear-gradient(to bottom, transparent, rgba(135, 206, 235, 0.6));
        animation: rainFall 0.8s linear infinite;
      }

      @keyframes rainFall {
        0% { transform: translateY(-20px); opacity: 0; }
        50% { opacity: 1; }
        100% { transform: translateY(180px); opacity: 0; }
      }

      /* Tutorial Overlay */
      .tutorial-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 3000;
        display: none;
      }

      .tutorial-overlay.is-active {
        display: block;
      }

      .tutorial-highlight {
        position: absolute;
        box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7);
        border-radius: 8px;
        pointer-events: none;
      }

      .tutorial-tooltip {
        position: absolute;
        padding: 16px 20px;
        border-radius: 14px;
        background: var(--panel-strong);
        box-shadow: var(--shadow);
        max-width: 300px;
      }

      .tutorial-tooltip h4 {
        margin: 0 0 8px;
        font-size: 1rem;
      }

      .tutorial-tooltip p {
        margin: 0 0 14px;
        font-size: 0.9rem;
        color: var(--muted);
      }

      .tutorial-nav {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
      }

      .tutorial-nav button {
        padding: 8px 14px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-size: 0.85rem;
      }

      .tutorial-nav .skip {
        background: transparent;
        color: var(--muted);
      }

      .tutorial-nav .next {
        background: var(--navy);
        color: #fff;
      }

      .tutorial-progress {
        display: flex;
        gap: 6px;
        margin-top: 12px;
      }

      .tutorial-progress span {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: rgba(27, 43, 58, 0.2);
      }

      .tutorial-progress span.active {
        background: var(--brass);
      }

      /* Event Overlay */
      .event-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 999;
        padding: 20px;
      }

      .event-overlay.is-open {
        display: flex;
      }

      .event-dialog {
        width: min(540px, 100%);
        background: var(--panel-strong);
        border-radius: 18px;
        border: 1px solid var(--stroke);
        box-shadow: var(--shadow);
        padding: 18px;
        position: relative;
      }

      .event-title {
        font-size: 1.2rem;
        margin: 0 0 10px;
        color: var(--navy);
      }

      .event-body {
        margin-bottom: 14px;
        color: var(--muted);
        line-height: 1.5;
      }

      .event-choices {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .event-choice {
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.92);
        text-align: left;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: transform 0.1s ease, box-shadow 0.2s ease;
      }

      .event-choice:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-soft);
      }

      @media (max-width: 768px) {
        .roadmap::before {
          left: 20px;
        }
        .roadmap-phase {
          grid-template-columns: auto 1fr;
        }
        .roadmap-phase .phase-marker { grid-column: 1 !important; grid-row: 1; }
        .roadmap-phase .phase-content { grid-column: 2 !important; grid-row: 1; text-align: left !important; }
        .roadmap-phase .phase-details { grid-column: 2 !important; grid-row: 2; text-align: left !important; }
        
        .build-editor {
          grid-template-columns: 1fr;
        }
        
        .catastrophe-sim {
          grid-template-columns: 1fr;
        }
        
        .floating-nav {
          flex-wrap: wrap;
          max-width: 90%;
        }

        .route-form {
          grid-template-columns: 1fr;
        }

        .research-layout {
          grid-template-columns: 1fr;
        }

        .route-editor-grid {
          grid-template-columns: 1fr;
        }

        .page {
          padding: 28px 16px 64px;
        }

        .hero {
          padding: 24px 16px;
          gap: 20px;
        }

        .planet-canvas-container {
          width: 250px;
          height: 250px;
        }

        .kpi-grid,
        .grid-2,
        .grid-3,
        .grid-4 {
          grid-template-columns: 1fr;
        }

        .resource-grid {
          grid-template-columns: 1fr;
        }

        .build-editor {
          grid-template-columns: 1fr;
        }

        .build-palette {
          flex-direction: row;
          overflow-x: auto;
          white-space: nowrap;
          gap: 10px;
        }

        .build-palette .build-item {
          min-width: 150px;
        }

        .route {
          padding: 12px;
        }

        .route-meta {
          flex-direction: column;
          align-items: flex-start;
        }
      }

      /* Toasts (statt alert) */
      .toast-container {
        position: fixed;
        left: 20px;
        bottom: 20px;
        z-index: 6000;
        display: grid;
        gap: 10px;
        width: min(420px, calc(100vw - 40px));
        pointer-events: none;
      }

      .toast {
        pointer-events: auto;
        display: grid;
        grid-template-columns: auto 1fr auto;
        gap: 10px;
        align-items: start;
        padding: 12px;
        border-radius: 14px;
        background: var(--panel-strong);
        border: 1px solid var(--stroke);
        box-shadow: var(--shadow-soft);
        transform: translateY(10px);
        opacity: 0;
        animation: toastIn 240ms ease forwards;
      }

      .toast .toast-icon {
        width: 28px;
        height: 28px;
        border-radius: 10px;
        display: grid;
        place-items: center;
        color: #fff;
        font-weight: 700;
        font-size: 0.9rem;
        margin-top: 1px;
      }

      .toast .toast-title {
        font-weight: 700;
        font-size: 0.9rem;
        color: var(--ink);
      }

      .toast .toast-message {
        margin-top: 2px;
        font-size: 0.85rem;
        color: var(--muted);
        line-height: 1.35;
      }

      .toast .toast-close {
        border: none;
        background: transparent;
        color: var(--muted);
        cursor: pointer;
        padding: 6px;
        border-radius: 10px;
      }

      .toast .toast-close:hover {
        background: rgba(27, 43, 58, 0.08);
        color: var(--ink);
      }

      .toast[data-type="success"] .toast-icon {
        background: var(--success);
      }

      .toast[data-type="warning"] .toast-icon {
        background: var(--warning);
      }

      .toast[data-type="danger"] .toast-icon {
        background: var(--danger);
      }

      .toast[data-type="info"] .toast-icon {
        background: var(--navy);
      }

      @keyframes toastIn {
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      @keyframes toastOut {
        to {
          transform: translateY(8px);
          opacity: 0;
        }
      }

      /* Sim Controls */
      /* Alte sim-controls entfernt - jetzt in Topbar integriert */

      /* Seed-getriebene Highlights */
      .biome-card.is-dominant {
        border-color: rgba(177, 138, 85, 0.65);
        box-shadow: 0 0 0 1px rgba(177, 138, 85, 0.15), var(--shadow-soft);
      }

      /* Time Display */
      .sim-time {
        font-family: "Cinzel", serif;
        font-size: 0.85rem;
        color: var(--navy);
        margin-left: 10px;
        padding-left: 10px;
        border-left: 1px solid var(--stroke);
        white-space: nowrap;
      }

      /* Command Palette */
      .command-palette-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 5000;
        display: none;
        align-items: flex-start;
        justify-content: center;
        padding-top: 15vh;
      }

      .command-palette-overlay.is-open {
        display: flex;
      }

      .command-palette {
        width: min(560px, 90vw);
        background: var(--panel-strong);
        border: 1px solid var(--stroke);
        border-radius: 16px;
        box-shadow: var(--shadow);
        overflow: hidden;
      }

      .command-input {
        width: 100%;
        padding: 16px 20px;
        border: none;
        border-bottom: 1px solid var(--stroke);
        background: transparent;
        font-size: 1rem;
        color: var(--ink);
        outline: none;
      }

      .command-input::placeholder {
        color: var(--muted);
      }

      .command-list {
        max-height: 320px;
        overflow-y: auto;
        padding: 8px;
      }

      .command-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 12px;
        border-radius: 10px;
        cursor: pointer;
        font-size: 0.9rem;
      }

      .command-item:hover,
      .command-item.is-selected {
        background: rgba(27, 43, 58, 0.08);
      }

      .command-item .cmd-icon {
        width: 28px;
        height: 28px;
        border-radius: 8px;
        background: var(--navy);
        color: #fff;
        display: grid;
        place-items: center;
        font-size: 0.85rem;
      }

      .command-item .cmd-label {
        flex: 1;
      }

      .command-item .cmd-shortcut {
        font-size: 0.75rem;
        padding: 3px 8px;
        border-radius: 6px;
        background: rgba(27, 43, 58, 0.08);
        color: var(--muted);
        font-family: monospace;
      }

      /* Settings Panel */
      .settings-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 4500;
        display: none;
        align-items: center;
        justify-content: center;
      }

      .settings-overlay.is-open {
        display: flex;
      }

      .settings-panel {
        width: min(480px, 90vw);
        max-height: 80vh;
        background: var(--panel-strong);
        border: 1px solid var(--stroke);
        border-radius: 20px;
        box-shadow: var(--shadow);
        overflow: hidden;
      }

      .settings-header {
        padding: 18px 20px;
        border-bottom: 1px solid var(--stroke);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .settings-header h3 {
        margin: 0;
        font-size: 1.1rem;
      }

      .settings-body {
        padding: 20px;
        overflow-y: auto;
        max-height: calc(80vh - 70px);
      }

      .setting-group {
        margin-bottom: 20px;
      }

      .setting-group h4 {
        margin: 0 0 12px;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
      }

      .setting-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid var(--stroke);
      }

      .setting-row:last-child {
        border-bottom: none;
      }

      .setting-label {
        font-size: 0.9rem;
      }

      .setting-control input[type="range"] {
        width: 120px;
        accent-color: var(--brass);
      }

      .setting-control input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: var(--brass);
      }

      .setting-control select {
        padding: 6px 10px;
        border-radius: 8px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.8);
        font-size: 0.85rem;
      }

      /* Dark Mode Starfield */
      [data-theme="dark"] body::before {
        background-image:
          radial-gradient(1px 1px at 20px 30px, white, transparent),
          radial-gradient(1px 1px at 40px 70px, rgba(255,255,255,0.8), transparent),
          radial-gradient(1px 1px at 50px 160px, rgba(255,255,255,0.6), transparent),
          radial-gradient(1px 1px at 90px 40px, white, transparent),
          radial-gradient(1px 1px at 130px 80px, rgba(255,255,255,0.7), transparent),
          radial-gradient(1.5px 1.5px at 160px 120px, white, transparent),
          radial-gradient(1px 1px at 200px 50px, rgba(255,255,255,0.5), transparent),
          radial-gradient(1px 1px at 220px 90px, white, transparent),
          radial-gradient(1px 1px at 260px 140px, rgba(255,255,255,0.6), transparent);
        background-size: 280px 180px;
        background-position: 0 0;
        opacity: 1;
        animation: starTwinkle 4s ease-in-out infinite alternate;
      }

      @keyframes starTwinkle {
        0% { opacity: 0.8; }
        100% { opacity: 1; }
      }

      /* Overlay System */
      .overlay-controls {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 12px;
      }

      .overlay-btn {
        padding: 6px 12px;
        border-radius: 999px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.8);
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .overlay-btn[aria-pressed="true"] {
        background: var(--navy);
        color: #fff;
        border-color: var(--navy);
      }

      .sector-map .overlay-layer {
        position: absolute;
        inset: 0;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s ease;
        border-radius: inherit;
      }

      .sector-map .overlay-layer.is-active {
        opacity: 1;
      }

      .overlay-layer.temp {
        background: linear-gradient(135deg, 
          rgba(59, 130, 246, 0.3) 0%, 
          rgba(34, 197, 94, 0.3) 40%, 
          rgba(234, 179, 8, 0.3) 70%, 
          rgba(239, 68, 68, 0.3) 100%);
      }

      .overlay-layer.emissions {
        background: radial-gradient(circle at 70% 30%, rgba(139, 69, 19, 0.5), transparent 50%),
                    radial-gradient(circle at 40% 60%, rgba(139, 69, 19, 0.3), transparent 40%);
      }

      .overlay-layer.risk {
        background: repeating-linear-gradient(
          45deg,
          transparent,
          transparent 20px,
          rgba(239, 68, 68, 0.15) 20px,
          rgba(239, 68, 68, 0.15) 40px
        );
      }

      .overlay-layer.water {
        background: radial-gradient(circle at 30% 50%, rgba(59, 130, 246, 0.4), transparent 50%),
                    radial-gradient(circle at 70% 70%, rgba(59, 130, 246, 0.3), transparent 40%);
      }

      /* Flow SVG Paths */
      .flow-diagram {
        position: relative;
      }

      .flow-svg {
        position: absolute;
        inset: 0;
        pointer-events: none;
        overflow: visible;
      }

      .flow-path {
        fill: none;
        stroke: var(--brass);
        stroke-width: 2;
        opacity: 0.4;
        transition: opacity 0.2s ease, stroke-width 0.2s ease;
      }

      .flow-path.is-highlighted {
        opacity: 0.9;
        stroke-width: 4;
      }

      .flow-node {
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .flow-node:hover {
        transform: scale(1.03);
        box-shadow: var(--shadow-soft);
        z-index: 10;
      }

      .flow-node.is-highlighted {
        border-color: var(--brass);
        box-shadow: 0 0 0 3px rgba(177, 138, 85, 0.3);
      }

      /* Build Grid: Building Icons */
      .build-cell.occupied {
        position: relative;
      }

      .build-cell .building-icon {
        position: absolute;
        inset: 2px;
        display: grid;
        place-items: center;
        font-size: 0.7rem;
        background: var(--panel);
        border-radius: 3px;
      }

      .build-cell[data-building="home"] { background: #4ade80; }
      .build-cell[data-building="solar"] { background: #fbbf24; }
      .build-cell[data-building="water"] { background: #60a5fa; }
      .build-cell[data-building="hydro"] { background: #34d399; }
      .build-cell[data-building="refinery"] { background: #f87171; }
      .build-cell[data-building="lab"] { background: #a78bfa; }
      .build-cell[data-building="spaceport"] { background: #818cf8; }

      .build-palette .build-item[data-action="delete"] {
        border-color: var(--danger);
        color: var(--danger);
      }

      .build-palette .build-item[data-action="delete"]:hover {
        background: rgba(182, 66, 42, 0.15);
      }

      /* Research Dependencies */
      .research-node[data-prereq] {
        position: relative;
      }

      .research-node .prereq-line {
        position: absolute;
        left: -20px;
        top: 50%;
        width: 18px;
        height: 2px;
        background: var(--stroke);
      }

      .research-progress {
        height: 4px;
        background: rgba(27, 43, 58, 0.15);
        border-radius: 999px;
        margin-top: 8px;
        overflow: hidden;
      }

      .research-progress span {
        display: block;
        height: 100%;
        background: linear-gradient(90deg, var(--brass), var(--copper));
        border-radius: 999px;
        width: 0%;
        transition: width 0.3s ease;
      }

      /* Diplomacy Interactive */
      .faction-actions {
        display: flex;
        gap: 8px;
        margin-top: 12px;
      }

      .faction-btn {
        flex: 1;
        padding: 8px 12px;
        border-radius: 10px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.8);
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .faction-btn:hover {
        background: var(--navy);
        color: #fff;
        border-color: var(--navy);
      }

      .faction-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* Orbit Lane Editor */
      .route-editor {
        margin-top: 16px;
        padding: 14px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.6);
        border: 1px solid var(--stroke);
      }

      .route-form {
        display: grid;
        gap: 10px;
        grid-template-columns: 1fr 1fr 1fr auto;
        align-items: end;
      }

      .route-form label {
        display: block;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
        margin-bottom: 4px;
      }

      .route-form input,
      .route-form select {
        width: 100%;
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.9);
        font-size: 0.85rem;
      }

      .route-cargo-fields {
        display: grid;
        grid-template-columns: 1fr 80px;
        gap: 6px;
      }

      .route-cargo-fields input {
        text-align: right;
      }

      .route.editable {
        position: relative;
      }

      .route .route-actions {
        display: flex;
        gap: 6px;
      }

      .route .route-action {
        padding: 4px 8px;
        border-radius: 6px;
        border: none;
        background: rgba(27, 43, 58, 0.08);
        font-size: 0.75rem;
        cursor: pointer;
      }

      .route .route-action:hover {
        background: var(--navy);
        color: #fff;
      }

      .route .route-action.delete:hover {
        background: var(--danger);
      }

      .route-inline-editor {
        width: 100%;
        padding: 12px;
        border-radius: 12px;
        background: rgba(23, 33, 44, 0.05);
        border: 1px solid rgba(27, 43, 58, 0.2);
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.08);
      }

      .route-inline-editor.is-hidden {
        display: none;
      }

      .route-editor-grid {
        display: grid;
        gap: 10px;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      }

      .route-editor-grid label {
        display: block;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--muted);
        margin-bottom: 4px;
      }

      .route-editor-grid input,
      .route-editor-grid select {
        width: 100%;
        padding: 8px;
        border-radius: 8px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.95);
        font-size: 0.85rem;
      }

      .route-editor-actions {
        margin-top: 12px;
        display: flex;
        gap: 8px;
        justify-content: flex-end;
      }

      /* JSON Import */
      .import-zone {
        margin-top: 12px;
        padding: 20px;
        border: 2px dashed var(--stroke);
        border-radius: 12px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .import-zone:hover,
      .import-zone.drag-over {
        border-color: var(--brass);
        background: rgba(177, 138, 85, 0.08);
      }

      .import-zone input {
        display: none;
      }

      .import-zone p {
        margin: 0;
        font-size: 0.9rem;
        color: var(--muted);
      }

      /* Print Report */
      @media print {
        .theme-toggle,
        .notification-toggle,
        .notification-center,
        .floating-nav,
        .soundtrack-player,
        .sim-controls,
        .toast-container,
        .command-palette-overlay,
        .settings-overlay,
        .tutorial-overlay,
        .modal-overlay {
          display: none !important;
        }

        body {
          background: white !important;
        }

        body::before {
          display: none !important;
        }

        .page {
          padding: 20px;
          max-width: 100%;
        }

        .hero,
        .card,
        .kpi-card,
        section {
          break-inside: avoid;
          box-shadow: none !important;
          border: 1px solid #ddd !important;
        }

        @page {
          margin: 1cm;
        }
      }

      /* Keyboard Hint */
      .keyboard-hint {
        position: fixed;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%);
        padding: 8px 14px;
        border-radius: 10px;
        background: var(--panel-strong);
        border: 1px solid var(--stroke);
        box-shadow: var(--shadow-soft);
        font-size: 0.8rem;
        color: var(--muted);
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
        z-index: 500;
      }

      .keyboard-hint.is-visible {
        opacity: 1;
      }

      .keyboard-hint kbd {
        padding: 2px 6px;
        border-radius: 4px;
        background: rgba(27, 43, 58, 0.1);
        font-family: monospace;
        margin: 0 2px;
      }

      /* Multi-Planet System */
      .planet-manager {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .planet-switcher {
        padding: 8px 12px;
        border-radius: 999px;
        background: var(--panel-strong);
        border: 1px solid var(--stroke);
        box-shadow: var(--shadow-soft);
        font-size: 0.85rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .planet-switcher:hover {
        background: rgba(177, 138, 85, 0.15);
      }

      .planet-list-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 4500;
        display: none;
        align-items: center;
        justify-content: center;
      }

      .planet-list-overlay.is-open {
        display: flex;
      }

      .planet-list-panel {
        width: min(600px, 90vw);
        max-height: 80vh;
        background: var(--panel-strong);
        border: 1px solid var(--stroke);
        border-radius: 20px;
        box-shadow: var(--shadow);
        overflow: hidden;
        display: grid;
        grid-template-rows: auto 1fr auto;
      }

      .planet-list-header {
        padding: 18px 20px;
        border-bottom: 1px solid var(--stroke);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .planet-list-body {
        padding: 20px;
        overflow-y: auto;
        display: grid;
        gap: 12px;
      }

      .planet-item {
        padding: 14px;
        border-radius: 12px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.6);
        cursor: pointer;
        transition: all 0.2s ease;
        display: grid;
        grid-template-columns: auto 1fr auto;
        gap: 12px;
        align-items: center;
      }

      .planet-item:hover {
        background: rgba(177, 138, 85, 0.15);
        border-color: var(--brass);
      }

      .planet-item.is-active {
        border-color: var(--brass);
        background: rgba(177, 138, 85, 0.2);
      }

      .planet-item-actions {
        display: flex;
        gap: 6px;
      }

      .planet-item-btn {
        padding: 4px 8px;
        border-radius: 6px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.8);
        font-size: 0.75rem;
        cursor: pointer;
      }

      /* Planet Compare Overlay */
      .planet-compare-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index: 4600;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .planet-compare-overlay.is-open {
        display: flex;
      }

      .planet-compare-panel {
        width: min(1200px, 95vw);
        max-height: 90vh;
        background: var(--panel-strong);
        border: 1px solid var(--stroke);
        border-radius: 20px;
        box-shadow: var(--shadow);
        overflow: hidden;
        display: grid;
        grid-template-rows: auto 1fr;
      }

      .planet-compare-header {
        padding: 18px 20px;
        border-bottom: 1px solid var(--stroke);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .planet-compare-body {
        padding: 20px;
        overflow-y: auto;
      }

      .planet-compare-selectors {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 24px;
      }

      .compare-selector {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .compare-selector label {
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--ink);
      }

      .compare-select {
        padding: 10px 14px;
        border-radius: 10px;
        border: 1px solid var(--stroke);
        background: var(--panel);
        font-size: 0.9rem;
        cursor: pointer;
      }

      .planet-compare-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
      }

      .compare-planet-card {
        padding: 20px;
        border-radius: 14px;
        border: 1px solid var(--stroke);
        background: var(--panel);
      }

      .compare-planet-visual {
        text-align: center;
        margin-bottom: 20px;
      }

      .compare-planet-canvas {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        margin: 0 auto 12px;
        image-rendering: pixelated;
        image-rendering: -moz-crisp-edges;
        image-rendering: crisp-edges;
      }

      .compare-planet-name {
        font-size: 1.2rem;
        font-weight: 700;
        margin-bottom: 4px;
      }

      .compare-planet-seed {
        font-size: 0.85rem;
        color: var(--muted);
        font-family: 'Courier New', monospace;
      }

      .compare-kpi-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 16px;
      }

      .compare-kpi-item {
        padding: 12px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.5);
        border: 1px solid var(--stroke);
      }

      .compare-kpi-label {
        font-size: 0.75rem;
        color: var(--muted);
        margin-bottom: 4px;
      }

      .compare-kpi-value {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--ink);
      }

      .compare-planet-info {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid var(--stroke);
      }

      .compare-info-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      }

      .compare-info-row:last-child {
        border-bottom: none;
      }

      .compare-info-label {
        font-size: 0.85rem;
        color: var(--muted);
      }

      .compare-info-value {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--ink);
      }

      /* Pixel Art Planet Canvas */
      .planet-canvas-container {
        position: relative;
        width: 250px;
        height: 250px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .planet-canvas {
        image-rendering: pixelated;
        image-rendering: -moz-crisp-edges;
        image-rendering: crisp-edges;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
      }

      /* Pixel Art UI */
      .pixel-art {
        image-rendering: pixelated;
        image-rendering: -moz-crisp-edges;
        image-rendering: crisp-edges;
      }

      .pixel-button {
        image-rendering: pixelated;
        image-rendering: -moz-crisp-edges;
        image-rendering: crisp-edges;
        border: 2px solid;
        border-color: var(--ink) var(--muted) var(--muted) var(--ink);
        box-shadow: inset -2px -2px 0 var(--muted), inset 2px 2px 0 var(--ink);
        font-family: 'Courier New', monospace;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .pixel-button:active {
        border-color: var(--muted) var(--ink) var(--ink) var(--muted);
        box-shadow: inset 2px 2px 0 var(--muted), inset -2px -2px 0 var(--ink);
      }

      .pixel-card {
        image-rendering: pixelated;
        image-rendering: -moz-crisp-edges;
        image-rendering: crisp-edges;
        border: 2px solid var(--ink);
        box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.2);
        background: var(--panel);
      }

      .pixel-icon {
        image-rendering: pixelated;
        image-rendering: -moz-crisp-edges;
        image-rendering: crisp-edges;
        font-size: 1.2rem;
        line-height: 1;
      }

      /* Apply pixel art style to buttons */
      .seed-button, .sim-btn, .planet-item-btn, .compare-select {
        font-family: 'Courier New', monospace;
        font-weight: 600;
      }

      /* Pixel art achievement cards */
      .achievement-card {
        border: 2px solid var(--stroke);
        box-shadow: 3px 3px 0 rgba(0, 0, 0, 0.1);
      }

      .achievement-card.unlocked {
        border-color: var(--brass);
        box-shadow: 4px 4px 0 rgba(177, 138, 85, 0.3);
      }

      /* Pixel art KPI cards */
      [data-kpi] {
        border: 2px solid var(--stroke);
        box-shadow: 2px 2px 0 rgba(0, 0, 0, 0.05);
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      [data-kpi]:hover {
        transform: translateY(-2px);
        box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.1);
      }

      /* KPI Detail Modal */
      .kpi-detail-modal {
        max-width: 600px;
      }

      .kpi-detail-content {
        display: grid;
        gap: 16px;
      }

      .kpi-detail-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid var(--stroke);
      }

      .kpi-detail-row:last-child {
        border-bottom: none;
      }

      .kpi-detail-label {
        color: var(--muted);
        font-size: 0.9rem;
      }

      .kpi-detail-value {
        font-weight: 600;
        color: var(--ink);
      }

      .kpi-trend {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 8px;
      }

      .kpi-trend.up {
        color: var(--success);
      }

      .kpi-trend.down {
        color: var(--danger);
      }

      /* Quick Actions Bar */
      .quick-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 16px;
        padding: 12px;
        background: var(--panel);
        border: 1px solid var(--stroke);
        border-radius: 12px;
      }

      .quick-action-btn {
        padding: 10px 16px;
        border-radius: 12px;
        border: 1px solid var(--stroke);
        background: rgba(255, 255, 255, 0.8);
        color: var(--navy);
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .quick-action-btn:hover {
        background: var(--navy);
        color: #fff;
        border-color: var(--navy);
        transform: translateY(-1px);
      }
    </style>
  </head>
  <body>
    <!-- Topbar Navigation -->
    <header class="topbar" id="topbar">
      <div class="topbar-left">
        <div class="topbar-logo">🌍 Planet Sandbox</div>
        <nav class="topbar-nav" id="topbar-nav">
          <button class="active" data-section="hero">🏠 Start</button>
          <button data-section="research">🔬 Forschung</button>
          <button data-section="chains">⚙️ Ketten</button>
          <button data-section="military">⚔️ Militär</button>
          <button data-section="diplomacy">🤝 Diplomatie</button>
          <div class="topbar-nav-more">
            <button class="topbar-nav-more-btn">Mehr ▼</button>
            <div class="topbar-nav-dropdown">
              <button data-section="biomes">🌍 Biome</button>
              <button data-section="achievements">🏆 Erfolge</button>
              <button data-section="seeds">🌱 Seeds</button>
            </div>
          </div>
        </nav>
      </div>
      <div class="topbar-center">
        <div class="sim-controls-compact" id="sim-controls" aria-label="Simulation">
          <button class="sim-btn-compact" id="sim-pause" type="button" aria-pressed="false" title="Pause">⏸</button>
          <button class="sim-btn-compact" id="sim-1x" type="button" aria-pressed="true" title="1× Geschwindigkeit">1×</button>
          <button class="sim-btn-compact" id="sim-4x" type="button" aria-pressed="false" title="4× Geschwindigkeit">4×</button>
          <button class="sim-btn-compact" id="sim-10x" type="button" aria-pressed="false" title="10× Geschwindigkeit">10×</button>
          <span class="sim-time-compact" id="sim-time">Tag 1, Jahr 1</span>
        </div>
      </div>
      <div class="topbar-right">
        <button class="planet-switcher-compact" id="planet-switcher" aria-label="Planeten wechseln">
          <span>🌍</span>
          <span id="current-planet-name">Planet 1</span>
          <span>▼</span>
        </button>
        <button class="planet-switcher-compact" id="planet-add" aria-label="Neuen Planet hinzufügen" title="Neuer Planet">➕</button>
        <button class="topbar-btn" id="settings-toggle" aria-label="Einstellungen">⚙️</button>
        <button class="topbar-btn" id="auth-login">Anmelden</button>
        <button class="topbar-btn" id="auth-logout" style="display: none;">Abmelden</button>
      </div>
    </header>

    <!-- Planet List Overlay -->
    <div class="planet-list-overlay" id="planet-list-overlay" role="dialog" aria-modal="true" aria-label="Planetenliste">
      <div class="planet-list-panel">
        <div class="planet-list-header">
          <h3>🌍 Planeten</h3>
          <button class="modal-close" id="planet-list-close" aria-label="Schließen">×</button>
        </div>
        <div class="planet-list-body" id="planet-list-body">
          <!-- Dynamisch generiert -->
        </div>
        <div class="planet-list-header" style="border-top: 1px solid var(--stroke); border-bottom: none;">
          <button class="seed-button" id="planet-compare" style="width: 100%;">Vergleichen</button>
        </div>
      </div>
    </div>

      <section class="card" style="margin: 20px auto; max-width: 960px;">
        <h3>Sicherung &amp; Login (lokal)</h3>
        <p class="lead">
          Saves und Login laufen nur lokal im Browser. Kein echter Account, keine Cloud-Sync. Für schnelle Tests kannst du als Gast spielen.
        </p>
      </section>

    <!-- Planet Compare Overlay -->
    <div class="planet-compare-overlay" id="planet-compare-overlay" role="dialog" aria-modal="true" aria-label="Planetenvergleich">
      <div class="planet-compare-panel">
        <div class="planet-compare-header">
          <h3>⚖️ Planetenvergleich</h3>
          <button class="modal-close" id="planet-compare-close" aria-label="Schließen">×</button>
        </div>
        <div class="planet-compare-body" id="planet-compare-body">
          <div class="planet-compare-selectors">
            <div class="compare-selector">
              <label>Planet 1:</label>
              <select id="compare-planet-1" class="compare-select"></select>
            </div>
            <div class="compare-selector">
              <label>Planet 2:</label>
              <select id="compare-planet-2" class="compare-select"></select>
            </div>
          </div>
          <div class="planet-compare-content" id="planet-compare-content">
            <!-- Wird dynamisch generiert -->
          </div>
        </div>
      </div>
    </div>

    <!-- Command Palette -->
    <div class="command-palette-overlay" id="command-palette" role="dialog" aria-modal="true" aria-label="Befehlspalette">
      <div class="command-palette">
        <input type="text" class="command-input" id="command-input" placeholder="Suche Aktionen, Sektionen, Seeds... (Esc zum Schließen)" autocomplete="off">
        <div class="command-list" id="command-list" role="listbox"></div>
      </div>
    </div>

    <!-- Settings Panel -->
    <div class="settings-overlay" id="settings-overlay" role="dialog" aria-modal="true" aria-label="Einstellungen">
      <div class="settings-panel">
        <div class="settings-header">
          <h3>⚙️ Einstellungen</h3>
          <button class="modal-close" id="settings-close" aria-label="Schließen">×</button>
        </div>
        <div class="settings-body">
          <div class="setting-group">
            <h4>Audio</h4>
            <div class="setting-row">
              <span class="setting-label">Lautstärke</span>
              <div class="setting-control">
                <input type="range" id="setting-volume" min="0" max="100" value="70">
              </div>
            </div>
            <div class="setting-row">
              <span class="setting-label">Musik an</span>
              <div class="setting-control">
                <input type="checkbox" id="setting-music" checked>
              </div>
            </div>
          </div>
          <div class="setting-group">
            <h4>Darstellung</h4>
            <div class="setting-row">
              <span class="setting-label">UI-Skalierung</span>
              <div class="setting-control">
                <select id="setting-scale">
                  <option value="0.9">90%</option>
                  <option value="1" selected>100%</option>
                  <option value="1.1">110%</option>
                  <option value="1.2">120%</option>
                </select>
              </div>
            </div>
            <div class="setting-row">
              <span class="setting-label">Reduzierte Bewegung</span>
              <div class="setting-control">
                <input type="checkbox" id="setting-reduced-motion">
              </div>
            </div>
            <div class="setting-row">
              <span class="setting-label">Automatischer Dark Mode</span>
              <div class="setting-control">
                <input type="checkbox" id="setting-auto-dark">
              </div>
            </div>
          </div>
          <div class="setting-group">
            <h4>Simulation</h4>
            <div class="setting-row">
              <span class="setting-label">Auto-Pause bei Tab-Wechsel</span>
              <div class="setting-control">
                <input type="checkbox" id="setting-auto-pause" checked>
              </div>
            </div>
            <div class="setting-row">
              <span class="setting-label">Benachrichtigungen</span>
              <div class="setting-control">
                <input type="checkbox" id="setting-notifications" checked>
              </div>
            </div>
          </div>
          <div class="setting-group">
            <h4>Daten</h4>
            <div class="setting-row">
              <span class="setting-label">Alle Daten löschen</span>
              <div class="setting-control">
                <button class="seed-button secondary" id="setting-clear-data" style="padding: 6px 12px; font-size: 0.8rem;">Zurücksetzen</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Keyboard Hint -->
    <div class="keyboard-hint" id="keyboard-hint">
      <kbd>⌘</kbd>+<kbd>K</kbd> Befehlspalette · <kbd>T</kbd> Theme · <kbd>G</kbd> Glossar · <kbd>Space</kbd> Pause
    </div>

    <!-- Toasts -->
    <div class="toast-container" id="toast-container" aria-live="polite" aria-atomic="false"></div>

    <!-- Theme Toggle -->
    <button class="theme-toggle" id="theme-toggle" aria-label="Theme wechseln">
      <svg class="sun-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
      <span>Theme</span>
    </button>

    <!-- Notification Toggle -->
    <button class="notification-toggle" id="notification-toggle" aria-label="Benachrichtigungen">
      🔔
      <span class="badge">5</span>
    </button>

    <!-- Notification Center -->
    <aside class="notification-center" id="notification-center">
      <div class="notification-header">
        <h4>Benachrichtigungen</h4>
        <span class="notification-badge">5 neu</span>
      </div>
      <div class="notification-list">
        <div class="notification-item danger">
          <strong>Versorgungskrise!</strong>
          <p>Hydroponik in Sektor 07 ohne Wasser.</p>
          <time>vor 2 Minuten</time>
        </div>
        <div class="notification-item warning">
          <strong>Staubsturm naht</strong>
          <p>Nordkuppe in 4 Tagen betroffen.</p>
          <time>vor 15 Minuten</time>
        </div>
        <div class="notification-item success">
          <strong>Handelsroute etabliert</strong>
          <p>Orbit-Lane A → Hub Delta aktiv.</p>
          <time>vor 1 Stunde</time>
        </div>
        <div class="notification-item">
          <strong>Forschung abgeschlossen</strong>
          <p>Atmosphären-Prozessor Stufe 2 verfügbar.</p>
          <time>vor 2 Stunden</time>
        </div>
        <div class="notification-item warning">
          <strong>Emissionslimit</strong>
          <p>CO₂ bei 58% – Limit: 60%</p>
          <time>vor 3 Stunden</time>
        </div>
      </div>
    </aside>


    <!-- Soundtrack Player -->
    <div class="soundtrack-player" id="soundtrack-player">
      <button class="player-btn" id="player-toggle" aria-label="Play/Pause">▶</button>
      <div class="player-info">
        <div class="player-track">Ambient: Orbital Horizons</div>
        <div class="player-progress"><span></span></div>
      </div>
      <button class="player-volume" aria-label="Lautstärke">🔊</button>
    </div>

    <!-- Glossary Modal -->
    <!-- KPI Detail Modal -->
    <div class="modal-overlay" id="kpi-detail-modal">
      <div class="modal kpi-detail-modal">
        <div class="modal-header">
          <h3 id="kpi-detail-title">KPI Details</h3>
          <button class="modal-close" id="kpi-detail-close" aria-label="Schließen">×</button>
        </div>
        <div class="modal-body">
          <div class="kpi-detail-content" id="kpi-detail-content">
            <!-- Wird dynamisch generiert -->
          </div>
        </div>
      </div>
    </div>

    <div class="modal-overlay" id="glossary-modal">
      <div class="modal">
        <div class="modal-header">
          <h3>📖 Glossar</h3>
          <button class="modal-close" aria-label="Schließen">×</button>
        </div>
        <div class="modal-body">
          <input type="text" class="glossary-search" placeholder="Begriff suchen..." id="glossary-search">
          <dl class="glossary-list" id="glossary-list">
            <div class="glossary-item">
              <dt>Regolith</dt>
              <dd>Lockeres Gesteinsmaterial auf der Planetenoberfläche, Grundlage für Erzabbau.</dd>
            </div>
            <div class="glossary-item">
              <dt>Hydroponik</dt>
              <dd>Anbau von Pflanzen in Nährlösungen ohne Erde – essentiell für Nahrungsproduktion.</dd>
            </div>
            <div class="glossary-item">
              <dt>Orbit-Lane</dt>
              <dd>Handelsroute zwischen Sektoren oder zu orbitalen Stationen.</dd>
            </div>
            <div class="glossary-item">
              <dt>Terraforming</dt>
              <dd>Umgestaltung eines Planeten für menschliche Besiedlung (Atmosphäre, Klima, Biome).</dd>
            </div>
            <div class="glossary-item">
              <dt>Sektor</dt>
              <dd>Abgegrenztes Gebiet auf der Planetenoberfläche mit eigenem Klima und Ressourcen.</dd>
            </div>
            <div class="glossary-item">
              <dt>Emissionen</dt>
              <dd>CO₂-Ausstoß durch Industrie – beeinflusst Klima und Zufriedenheit.</dd>
            </div>
            <div class="glossary-item">
              <dt>Magnetfeld</dt>
              <dd>Schützt vor kosmischer Strahlung – essenziell für Bevölkerungswachstum.</dd>
            </div>
            <div class="glossary-item">
              <dt>Biom</dt>
              <dd>Ökologische Zone mit charakteristischer Flora, Fauna und Klima.</dd>
            </div>
          </dl>
        </div>
      </div>
    </div>

    <!-- Tutorial Overlay -->
    <div class="tutorial-overlay" id="tutorial-overlay">
      <div class="tutorial-highlight" id="tutorial-highlight"></div>
      <div class="tutorial-tooltip" id="tutorial-tooltip">
        <h4 id="tutorial-title">Willkommen!</h4>
        <p id="tutorial-text">Entdecke die Grundlagen der Planetenbesiedlung.</p>
        <div class="tutorial-nav">
          <button class="skip" id="tutorial-skip">Überspringen</button>
          <button class="next" id="tutorial-next">Weiter →</button>
        </div>
        <div class="tutorial-progress" id="tutorial-progress">
          <span class="active"></span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
    </div>

    <div class="event-overlay" id="event-overlay" role="dialog" aria-modal="true" aria-label="Ereignis">
      <div class="event-dialog">
        <button class="modal-close" id="event-close" aria-label="Schließen">×</button>
        <div class="event-title" id="event-title">Ereignis</div>
        <div class="event-body" id="event-body"></div>
        <div class="event-choices" id="event-choices"></div>
      </div>
    </div>

    <div class="auth-overlay" id="auth-overlay" role="dialog" aria-modal="true" aria-label="Anmeldung">
      <div class="auth-dialog">
        <h3>Anmelden / Registrieren</h3>
        <div class="auth-form">
          <label for="auth-username">Nutzername</label>
          <input id="auth-username" type="text" autocomplete="username" />
          <label for="auth-pass">Passcode (min. 6 Zeichen)</label>
          <input id="auth-pass" type="password" autocomplete="current-password" />
          <div class="auth-error" id="auth-error"></div>
          <div class="auth-actions">
            <button class="seed-button secondary" type="button" id="auth-cancel">Abbrechen</button>
            <button class="seed-button" type="button" id="auth-submit">Weiter</button>
          </div>
        </div>
      </div>
    </div>

    <main class="page">
      <!-- Start View: Hero + Status -->
      <div class="view-container active" id="view-start">
      <header class="hero" id="hero">
        <div class="auth-bar">
          <span class="auth-user" id="auth-user-label">Nicht angemeldet</span>
          <button class="auth-btn" id="auth-login">Anmelden</button>
          <button class="auth-btn" id="auth-logout" style="display: none;">Abmelden</button>
        </div>
        <div class="hero-text">
          <p class="eyebrow">Planetensimulation</p>
          <h1>Planet Sandbox: Siedeln, Handeln, Terraformen</h1>
          <p class="lead">
            Ein Siedlungs- und Wirtschaftsspiel auf einem lebendigen Planeten. 
            Sektoren auf einer Kugel, Orbit-Lanes statt Schiffsrouten - elegante
            Produktionsketten, zufriedene Bewohner, sichtbare Konsequenzen.
          </p>
        </div>
        <div class="hero-visual">
          <div class="planet-canvas-container">
            <canvas class="planet-canvas pixel-art" id="main-planet-canvas" width="250" height="250"></canvas>
          </div>
          <div class="legend">Pixel Art Planet mit Seed-generierten Kontinenten</div>
        </div>
        <div class="hero-actions">
          <div class="badge-row">
            <span class="badge">Zielgruppe: 12+</span>
            <span class="badge">Fokus: Aufbau + Simulation</span>
            <span class="badge">Stil: spielerisch plausibel</span>
          </div>
          <div class="chip-row" style="justify-content: center; margin-top: 16px;">
            <button class="seed-button secondary" id="glossary-open">📖 Glossar</button>
            <button class="seed-button secondary" id="tutorial-start">🎓 Tutorial</button>
          </div>
        </div>
      </header>

      <section id="status">
        <h2>Kolonie-Status</h2>
        <p class="lead">Die Statusleiste als schneller &Uuml;berblick.</p>
        <div class="kpi-grid">
          <div class="kpi-card" data-kpi="population" style="--value: 72%;">
            <div class="kpi-title">Bev&ouml;lkerung</div>
            <div class="kpi-value">128k</div>
            <div class="kpi-sub">Stufe: Kolonisten</div>
            <div class="kpi-meter"><span></span></div>
          </div>
          <div class="kpi-card" data-kpi="supply" style="--value: 84%;">
            <div class="kpi-title">Versorgung</div>
            <div class="kpi-value">84%</div>
            <div class="kpi-sub">Engpass: Verbundmaterial</div>
            <div class="kpi-meter"><span></span></div>
          </div>
          <div class="kpi-card" data-kpi="satisfaction" style="--value: 71%;">
            <div class="kpi-title">Zufriedenheit</div>
            <div class="kpi-value">71%</div>
            <div class="kpi-sub">Steuern stabil</div>
            <div class="kpi-meter"><span></span></div>
          </div>
          <div class="kpi-card" data-kpi="emissions" style="--value: 32%;">
            <div class="kpi-title">Emissionen</div>
            <div class="kpi-value">32%</div>
            <div class="kpi-sub">Limit: 60%</div>
            <div class="kpi-meter"><span></span></div>
          </div>
          <div class="kpi-card" data-kpi="energy" style="--value: 55%;">
            <div class="kpi-title">Energie</div>
            <div class="kpi-value">55%</div>
            <div class="kpi-sub">Puffer: 2 Tage</div>
            <div class="kpi-meter"><span></span></div>
          </div>
          <div class="kpi-card" data-kpi="water" style="--value: 90%;">
            <div class="kpi-title">Wasser</div>
            <div class="kpi-value">90%</div>
            <div class="kpi-sub">Reservoir stabil</div>
            <div class="kpi-meter"><span></span></div>
          </div>
        </div>
        <div class="grid-2" style="margin-top: 20px;">
          <div class="card resource-panel">
            <h3>Ressourcenlager</h3>
            <p class="lead">Live-Best&auml;nde, Kapazit&auml;ten und Netto-Fl&uuml;sse deiner wichtigsten Rohstoffe.</p>
            <div class="resource-grid" id="resource-grid" aria-live="polite"></div>
          </div>
          <div class="card effects-panel">
            <h3>Aktive Effekte</h3>
            <p class="lead">Tempor&auml;re Boni und Debuffs durch Events, Forschung oder Diplomatie.</p>
            <div class="effects-list" id="effects-list"></div>
          </div>
        </div>
        <!-- Quick Actions Bar - kompakter -->
        <div class="quick-actions">
          <button class="quick-action-btn" id="quick-build">
            🏗️ Gebäude
          </button>
          <button class="quick-action-btn" id="quick-research">
            🔬 Forschung
          </button>
          <button class="quick-action-btn" id="quick-routes">
            🚀 Routen
          </button>
          <button class="quick-action-btn" id="quick-events">
            📰 Events
          </button>
        </div>
      </section>
      </div>
      <!-- End Start View -->

      <!-- Research View -->
      <div class="view-container" id="view-research">
      <section id="research">
        <h2>🔬 Forschungsbaum</h2>
        <p class="lead">Schalte neue Technologien frei und forme die Zukunft deines Planeten.</p>
        <div class="research-layout">
          <div class="research-queue-panel" id="research-queue-panel">
            <h3>Forschungswarteschlange</h3>
            <div class="research-queue-points" id="research-queue-points">Punkte: 0</div>
            <div class="research-queue-list" id="research-queue-list"></div>
            <p class="research-queue-empty" id="research-queue-empty">Keine laufenden Aufträge.</p>
          </div>
          <div class="research-tree-wrapper">
            <div class="research-tree">
              <div class="research-tier">
                <span class="research-tier-label">Basis</span>
                <div class="research-node unlocked">
                  <div class="node-icon">⚡</div>
                  <div class="node-title">Solarenergie</div>
                  <div class="node-cost">✓ Erforscht</div>
                  <span class="node-status">✓</span>
                  <span class="research-connector"></span>
                </div>
                <div class="research-node unlocked">
                  <div class="node-icon">💧</div>
                  <div class="node-title">Wassergewinnung</div>
                  <div class="node-cost">✓ Erforscht</div>
                  <span class="node-status">✓</span>
                </div>
                <div class="research-node unlocked">
                  <div class="node-icon">🌱</div>
                  <div class="node-title">Hydroponik I</div>
                  <div class="node-cost">✓ Erforscht</div>
                  <span class="node-status">✓</span>
                </div>
              </div>
              <div class="research-tier">
                <span class="research-tier-label">Fortgeschritten</span>
                <div class="research-node available">
                  <div class="node-icon">🔋</div>
                  <div class="node-title">Fusionsreaktor</div>
                  <div class="node-cost">2500 Forschung</div>
                </div>
                <div class="research-node available">
                  <div class="node-icon">🏭</div>
                  <div class="node-title">Erzraffinerie II</div>
                  <div class="node-cost">1800 Forschung</div>
                </div>
                <div class="research-node unlocked">
                  <div class="node-icon">🌡️</div>
                  <div class="node-title">Klima-Steuerung</div>
                  <div class="node-cost">✓ Erforscht</div>
                  <span class="node-status">✓</span>
                </div>
              </div>
              <div class="research-tier">
                <span class="research-tier-label">Experte</span>
                <div class="research-node locked">
                  <div class="node-icon">🛸</div>
                  <div class="node-title">Orbit-Werft</div>
                  <div class="node-cost">5000 Forschung</div>
                </div>
                <div class="research-node locked">
                  <div class="node-icon">🌍</div>
                  <div class="node-title">Atmosphären-Prozessor</div>
                  <div class="node-cost">6500 Forschung</div>
                </div>
                <div class="research-node locked">
                  <div class="node-icon">🧬</div>
                  <div class="node-title">Gen-Anpassung</div>
                  <div class="node-cost">8000 Forschung</div>
                </div>
              </div>
              <div class="research-tier">
                <span class="research-tier-label">Energie</span>
                <div class="research-node available">
                  <div class="node-icon">🔋</div>
                  <div class="node-title">Energiespeicher I</div>
                  <div class="node-cost">800 Forschung</div>
                </div>
                <div class="research-node locked">
                  <div class="node-icon">⚡</div>
                  <div class="node-title">Energiespeicher II</div>
                  <div class="node-cost">2200 Forschung</div>
                </div>
                <div class="research-node available">
                  <div class="node-icon">🌋</div>
                  <div class="node-title">Geothermie</div>
                  <div class="node-cost">2800 Forschung</div>
                </div>
                <div class="research-node locked">
                  <div class="node-icon">⚛️</div>
                  <div class="node-title">Kernfusion II</div>
                  <div class="node-cost">6000 Forschung</div>
                </div>
              </div>
              <div class="research-tier">
                <span class="research-tier-label">Ressourcen</span>
                <div class="research-node available">
                  <div class="node-icon">⛏️</div>
                  <div class="node-title">Tiefbohrung</div>
                  <div class="node-cost">2400 Forschung</div>
                </div>
                <div class="research-node available">
                  <div class="node-icon">♻️</div>
                  <div class="node-title">Ressourcen-Recycling</div>
                  <div class="node-cost">2000 Forschung</div>
                </div>
                <div class="research-node locked">
                  <div class="node-icon">☄️</div>
                  <div class="node-title">Asteroiden-Abbau</div>
                  <div class="node-cost">7000 Forschung</div>
                </div>
              </div>
              <div class="research-tier">
                <span class="research-tier-label">Bevölkerung</span>
                <div class="research-node available">
                  <div class="node-icon">🌱</div>
                  <div class="node-title">Hydroponik II</div>
                  <div class="node-cost">2600 Forschung</div>
                </div>
                <div class="research-node locked">
                  <div class="node-icon">🌿</div>
                  <div class="node-title">Hydroponik III</div>
                  <div class="node-cost">5500 Forschung</div>
                </div>
                <div class="research-node available">
                  <div class="node-icon">🏛️</div>
                  <div class="node-title">Lebensraum-Expansion</div>
                  <div class="node-cost">3000 Forschung</div>
                </div>
              </div>
              <div class="research-tier">
                <span class="research-tier-label">Terraforming</span>
                <div class="research-node available">
                  <div class="node-icon">🌍</div>
                  <div class="node-title">Terraforming I</div>
                  <div class="node-cost">3200 Forschung</div>
                </div>
                <div class="research-node locked">
                  <div class="node-icon">🌎</div>
                  <div class="node-title">Terraforming II</div>
                  <div class="node-cost">7500 Forschung</div>
                </div>
                <div class="research-node locked">
                  <div class="node-icon">🌏</div>
                  <div class="node-title">Biosphären-Engineering</div>
                  <div class="node-cost">6500 Forschung</div>
                </div>
              </div>
              <div class="research-tier">
                <span class="research-tier-label">Handel</span>
                <div class="research-node available">
                  <div class="node-icon">📊</div>
                  <div class="node-title">Handelsoptimierung</div>
                  <div class="node-cost">1800 Forschung</div>
                </div>
                <div class="research-node locked">
                  <div class="node-icon">🌐</div>
                  <div class="node-title">Handelsnetzwerk</div>
                  <div class="node-cost">5000 Forschung</div>
                </div>
                <div class="research-node locked">
                  <div class="node-icon">🚀</div>
                  <div class="node-title">Interplanetarer Handel</div>
                  <div class="node-cost">14000 Forschung</div>
                </div>
              </div>
              <div class="research-tier">
                <span class="research-tier-label">Endgame</span>
                <div class="research-node locked">
                  <div class="node-icon">☀️</div>
                  <div class="node-title">Dyson-Spiegel</div>
                  <div class="node-cost">15000 Forschung</div>
                </div>
                <div class="research-node locked">
                  <div class="node-icon">🌐</div>
                  <div class="node-title">Planetares Netzwerk</div>
                  <div class="node-cost">12000 Forschung</div>
                </div>
                <div class="research-node locked">
                  <div class="node-icon">💻</div>
                  <div class="node-title">Quantencomputer</div>
                  <div class="node-cost">8000 Forschung</div>
                </div>
                <div class="research-node locked">
                  <div class="node-icon">🔬</div>
                  <div class="node-title">Nanotechnologie</div>
                  <div class="node-cost">6000 Forschung</div>
                </div>
                <div class="research-node locked">
                  <div class="node-icon">🤖</div>
                  <div class="node-title">Künstliche Intelligenz</div>
                  <div class="node-cost">16000 Forschung</div>
                </div>
              </div>
            </div>
            <div class="research-deps" id="research-deps">
              <strong>Voraussetzungen</strong>
              <div class="research-deps-list">Wähle eine Forschung, um Details anzuzeigen.</div>
            </div>
          </div>
        </div>
      </section>
      </div>
      <!-- End Research View -->

      <!-- Diplomacy View -->
      <div class="view-container" id="view-diplomacy">
      <section id="diplomacy">
        <h2>🤝 Diplomatie &amp; Fraktionen</h2>
        <p class="lead">Baue Beziehungen zu anderen Kolonien auf oder konkurriere um Ressourcen.</p>
        <div class="diplomacy-grid">
          <div class="faction-card" data-faction="tech">
            <div class="faction-header">
              <div class="faction-emblem tech">🔧</div>
              <div class="faction-info">
                <h4>Technokraten-Union</h4>
                <span>Fokus: Forschung & Innovation</span>
              </div>
            </div>
            <div class="faction-relations">
              <small>Beziehung: <span class="relation-status">Freundlich</span> (<span class="relation-value">72</span>%)</small>
              <div class="relation-bar">
                <div class="relation-fill friendly" style="width: 72%;"></div>
              </div>
            </div>
            <div class="faction-treaties">
              <span class="treaty-badge">Forschungsabkommen</span>
              <span class="treaty-badge">Technologie-Tausch</span>
            </div>
            <div class="faction-actions">
              <button class="faction-btn" data-action="gift">🎁 Geschenk</button>
              <button class="faction-btn" data-action="trade">📦 Handeln</button>
              <button class="faction-btn" data-action="treaty">📜 Vertrag</button>
            </div>
          </div>
          <div class="faction-card" data-faction="eco">
            <div class="faction-header">
              <div class="faction-emblem eco">🌿</div>
              <div class="faction-info">
                <h4>Öko-Kollektiv</h4>
                <span>Fokus: Nachhaltigkeit & Biome</span>
              </div>
            </div>
            <div class="faction-relations">
              <small>Beziehung: <span class="relation-status">Neutral</span> (<span class="relation-value">45</span>%)</small>
              <div class="relation-bar">
                <div class="relation-fill neutral" style="width: 45%;"></div>
              </div>
            </div>
            <div class="faction-treaties">
              <span class="treaty-badge pending">Handelsabkommen (ausstehend)</span>
            </div>
            <div class="faction-actions">
              <button class="faction-btn" data-action="gift">🎁 Geschenk</button>
              <button class="faction-btn" data-action="trade">📦 Handeln</button>
              <button class="faction-btn" data-action="treaty">📜 Vertrag</button>
            </div>
          </div>
          <div class="faction-card">
            <div class="faction-header">
              <div class="faction-emblem corp">💰</div>
              <div class="faction-info">
                <h4>Stellar Industries</h4>
                <span>Fokus: Handel & Produktion</span>
              </div>
            </div>
            <div class="faction-relations">
              <small>Beziehung: Alliiert (89%)</small>
              <div class="relation-bar">
                <div class="relation-fill allied" style="width: 89%;"></div>
              </div>
            </div>
            <div class="faction-treaties">
              <span class="treaty-badge">Handelsallianz</span>
              <span class="treaty-badge">Ressourcen-Pakt</span>
              <span class="treaty-badge">Militärbeistand</span>
            </div>
          </div>
          <div class="faction-card">
            <div class="faction-header">
              <div class="faction-emblem militant">⚔️</div>
              <div class="faction-info">
                <h4>Frontier-Miliz</h4>
                <span>Fokus: Expansion & Kontrolle</span>
              </div>
            </div>
            <div class="faction-relations">
              <small>Beziehung: Feindlich (18%)</small>
              <div class="relation-bar">
                <div class="relation-fill hostile" style="width: 18%;"></div>
              </div>
            </div>
            <div class="faction-treaties">
              <span class="treaty-badge" style="background: rgba(182,66,42,0.15); color: var(--danger); border-color: rgba(182,66,42,0.3);">Handelsembargo</span>
            </div>
          </div>
        </div>
      </section>
      </div>
      <!-- End Diplomacy View -->

      <!-- Chains/Flow View -->
      <div class="view-container" id="view-chains">
      <section id="flow">
        <h2>📊 Ressourcen-Fluss</h2>
        <p class="lead">Visualisierung aller Warenströme – von der Quelle bis zum Verbraucher.</p>
        <div class="flow-diagram">
          <div class="flow-container">
            <div class="flow-column">
              <div class="flow-node source">Eisfelder<div class="flow-value">120t/Tag</div></div>
              <div class="flow-node source">Regolith<div class="flow-value">85t/Tag</div></div>
              <div class="flow-node source">Solarpark<div class="flow-value">450 MW</div></div>
            </div>
            <div class="flow-column">
              <div class="flow-node process">Wasserwerk<div class="flow-value">95t/Tag</div></div>
              <div class="flow-node process">Raffinerie<div class="flow-value">60t/Tag</div></div>
              <div class="flow-node process">Energienetz<div class="flow-value">420 MW</div></div>
            </div>
            <div class="flow-column">
              <div class="flow-node output">Trinkwasser<div class="flow-value">80t/Tag</div></div>
              <div class="flow-node output">Metallbarren<div class="flow-value">45t/Tag</div></div>
              <div class="flow-node output">Nahrung<div class="flow-value">35t/Tag</div></div>
            </div>
            <div class="flow-column">
              <div class="flow-node consumer">🏠 Wohngebiete<div class="flow-value">128k Einwohner</div></div>
              <div class="flow-node consumer">🏭 Industrie<div class="flow-value">45 Betriebe</div></div>
              <div class="flow-node consumer">🚀 Raumhafen<div class="flow-value">Export: 25t/Tag</div></div>
            </div>
          </div>
          <svg class="flow-svg" id="flow-svg" aria-hidden="true"></svg>
        </div>
      </section>
      <section id="stats">
        <h2>📈 Statistik-Dashboard</h2>
        <p class="lead">Entwicklung über Zeit – erkenne Trends und optimiere frühzeitig.</p>
        <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
          <button class="seed-button secondary" id="stats-export-csv" style="font-size: 0.85rem;">📊 CSV Export</button>
          <button class="seed-button secondary" id="stats-export-png" style="font-size: 0.85rem;">🖼️ PNG Export</button>
          <button class="seed-button secondary" id="stats-clear-history" style="font-size: 0.85rem;">🗑️ Verlauf löschen</button>
        </div>
        <div class="stats-dashboard" id="stats-dashboard">
          <!-- Wird dynamisch generiert -->
        </div>
      </section>
      <section id="chains">
        <h2>🌍 Biom-Galerie</h2>
        <p class="lead">Jedes Biom hat einzigartige Eigenschaften, Boni und Herausforderungen.</p>
        <div class="biome-gallery">
          <div class="biome-card" data-biome="tundra">
            <div class="biome-preview tundra"></div>
            <h4>Tundra</h4>
            <p>Eisige Weiten mit reichen Wasservorkommen</p>
            <div class="biome-stats">
              <span>❄️ -20°C</span>
              <span>💧 +40%</span>
              <span>🌱 -60%</span>
            </div>
          </div>
          <div class="biome-card" data-biome="desert">
            <div class="biome-preview desert"></div>
            <h4>Wüste</h4>
            <p>Extreme Hitze, reich an Mineralien</p>
            <div class="biome-stats">
              <span>🌡️ +45°C</span>
              <span>⛏️ +50%</span>
              <span>💧 -80%</span>
            </div>
          </div>
          <div class="biome-card" data-biome="ocean">
            <div class="biome-preview ocean"></div>
            <h4>Ozean</h4>
            <p>Unbegrenzte Wasserressourcen, Handelsbonus</p>
            <div class="biome-stats">
              <span>🌊 100%</span>
              <span>🚢 +30%</span>
              <span>🏗️ -70%</span>
            </div>
          </div>
          <div class="biome-card" data-biome="jungle">
            <div class="biome-preview jungle"></div>
            <h4>Dschungel</h4>
            <p>Üppige Vegetation, Biomasse-Bonus</p>
            <div class="biome-stats">
              <span>🌴 +80%</span>
              <span>💨 Feucht</span>
              <span>🦠 +20%</span>
            </div>
          </div>
          <div class="biome-card" data-biome="volcanic">
            <div class="biome-preview volcanic"></div>
            <h4>Vulkanisch</h4>
            <p>Geothermie, aber gefährlich</p>
            <div class="biome-stats">
              <span>🔥 +60%</span>
              <span>⚠️ Risiko</span>
              <span>⛏️ +35%</span>
            </div>
          </div>
          <div class="biome-card" data-biome="plains">
            <div class="biome-preview plains"></div>
            <h4>Ebenen</h4>
            <p>Ideales Siedlungsgebiet, ausbalanciert</p>
            <div class="biome-stats">
              <span>🏠 +40%</span>
              <span>🌾 +30%</span>
              <span>⚖️ Balance</span>
            </div>
          </div>
          <div class="biome-card" data-biome="mountain">
            <div class="biome-preview mountain"></div>
            <h4>Gebirge</h4>
            <p>Schwer zugänglich, aber erzreich</p>
            <div class="biome-stats">
              <span>🏔️ +2000m</span>
              <span>⛏️ +70%</span>
              <span>🚗 -50%</span>
            </div>
          </div>
          <div class="biome-card" data-biome="swamp">
            <div class="biome-preview swamp"></div>
            <h4>Sumpf</h4>
            <p>Gasgewinnung, aber instabil</p>
            <div class="biome-stats">
              <span>💨 +55%</span>
              <span>🏗️ -40%</span>
              <span>🦟 +30%</span>
            </div>
          </div>
        </div>
      </section>

      <section>
        <h2>Ansichten &amp; Ebenen</h2>
        <p class="lead">
          Wechsel zwischen Planet, Sektor und Handel - jede Ebene zeigt nur die Infos,
          die du f&uuml;r Entscheidungen brauchst.
        </p>
        <div class="tabs">
          <div class="tablist" role="tablist" aria-label="Ansichten">
            <button
              id="tab-planet"
              class="tab-button"
              role="tab"
              aria-selected="true"
              aria-controls="panel-planet"
              tabindex="0"
            >
              Planet
            </button>
            <button
              id="tab-sektor"
              class="tab-button"
              role="tab"
              aria-selected="false"
              aria-controls="panel-sektor"
              tabindex="-1"
            >
              Sektor
            </button>
            <button
              id="tab-handel"
              class="tab-button"
              role="tab"
              aria-selected="false"
              aria-controls="panel-handel"
              tabindex="-1"
            >
              Handel
            </button>
          </div>
          <div id="panel-planet" class="tab-panel" role="tabpanel" aria-labelledby="tab-planet">
            <div class="grid-2">
              <div class="card">
                <h3>Planetare Ebene</h3>
                <p class="lead">
                  Globale Parameter wie Sonnenintensit&auml;t, Atmosph&auml;re und Magnetfeld
                  werden hier gesteuert. Sektoren sind als farbige Zonen markiert.
                </p>
                <div class="chip-row">
                  <span class="chip">Temperatur</span>
                  <span class="chip">Druck</span>
                  <span class="chip">Biome</span>
                  <span class="chip">Orbit</span>
                </div>
              </div>
              <div class="card">
                <h3>Klima-Overlays</h3>
                <ul>
                  <li>Heatmap f&uuml;r Temperatur, Feuchte und St&uuml;rme.</li>
                  <li>Emissionswolken zeigen Industrie-Belastung.</li>
                  <li>Terraforming-Korridore markieren aktive Eingriffe.</li>
                </ul>
              </div>
            </div>
          </div>
          <div
            id="panel-sektor"
            class="tab-panel"
            role="tabpanel"
            aria-labelledby="tab-sektor"
            hidden
          >
            <div class="grid-2">
              <div class="card">
                <h3>Sektor-Analyse</h3>
                <p class="lead">
                  Lokale Planung: Baufl&auml;chen, Ressourcen, Risiko und
                  Versorgung sind auf einen Blick sichtbar.
                </p>
                <div class="overlay-controls">
                  <button class="overlay-btn" data-overlay="none" aria-pressed="true">Keine</button>
                  <button class="overlay-btn" data-overlay="temp" aria-pressed="false">🌡️ Temperatur</button>
                  <button class="overlay-btn" data-overlay="emissions" aria-pressed="false">💨 Emissionen</button>
                  <button class="overlay-btn" data-overlay="risk" aria-pressed="false">⚠️ Risiko</button>
                  <button class="overlay-btn" data-overlay="water" aria-pressed="false">💧 Wasser</button>
                </div>
                <div class="sector-map" id="sector-map-main" aria-hidden="true">
                  <div class="overlay-layer temp"></div>
                  <div class="overlay-layer emissions"></div>
                  <div class="overlay-layer risk"></div>
                  <div class="overlay-layer water"></div>
                  <div class="weather-overlay">
                    <div class="weather-storm"></div>
                    <div class="weather-storm"></div>
                    <div class="weather-storm"></div>
                  </div>
                  <span class="map-marker ore"></span>
                  <span class="map-marker water"></span>
                  <span class="map-marker risk"></span>
                </div>
                <div class="legend">Erz, Wasser, Risiko + Live-Wetter + Overlays</div>
              </div>
              <div class="card">
                <h3>Detailpanel</h3>
                <div class="stat-list">
                  <div class="stat-row"><span class="stat-label">Klima</span><span class="stat-value">Mild / 18C</span></div>
                  <div class="stat-row"><span class="stat-label">Boden</span><span class="stat-value">Basalt + Lehm</span></div>
                  <div class="stat-row"><span class="stat-label">Risiko</span><span class="stat-value">Staubsturm 12%</span></div>
                  <div class="stat-row"><span class="stat-label">Kapazit&auml;t</span><span class="stat-value">+2200 Wohnraum</span></div>
                </div>
              </div>
            </div>
          </div>
          <div
            id="panel-handel"
            class="tab-panel"
            role="tabpanel"
            aria-labelledby="tab-handel"
            hidden
          >
            <div class="grid-2">
              <div class="card">
                <h3>Orbit-Lanes</h3>
                <p class="lead">
                  Routen verbinden Sektoren und orbitale Hubs. Distanz, Wetter und
                  Gravitation beeinflussen die Laufzeit.
                </p>
                <div class="route-list" id="route-list">
                  <div class="route editable" data-route-id="1">
                    <span>Nordkuppe 07 → Orbit-Hub A</span>
                    <span>8d / 120t</span>
                    <div class="route-actions">
                      <button class="route-action" data-action="edit">✏️</button>
                      <button class="route-action delete" data-action="delete">🗑️</button>
                    </div>
                  </div>
                  <div class="route editable" data-route-id="2">
                    <span>Südgürtel 02 → Raffinerie 4</span>
                    <span>5d / 80t</span>
                    <div class="route-actions">
                      <button class="route-action" data-action="edit">✏️</button>
                      <button class="route-action delete" data-action="delete">🗑️</button>
                    </div>
                  </div>
                  <div class="route editable" data-route-id="3">
                    <span>Ozeanring → Terra-Knoten</span>
                    <span>6d / 95t</span>
                    <div class="route-actions">
                      <button class="route-action" data-action="edit">✏️</button>
                      <button class="route-action delete" data-action="delete">🗑️</button>
                    </div>
                  </div>
                </div>
                <div class="route-editor">
                  <h4 style="margin: 0 0 10px; font-size: 0.85rem;">Neue Route erstellen</h4>
                  <div class="route-form">
                    <div>
                      <label>Von</label>
                      <select id="route-from">
                        <option>Nordkuppe 07</option>
                        <option>Südgürtel 02</option>
                        <option>Ozeanring</option>
                        <option>Polarbecken</option>
                      </select>
                    </div>
                    <div>
                      <label>Nach</label>
                      <select id="route-to">
                        <option>Orbit-Hub A</option>
                        <option>Orbit-Hub B</option>
                        <option>Raffinerie 4</option>
                        <option>Terra-Knoten</option>
                      </select>
                    </div>
                    <div>
                      <label>Ladung</label>
                      <div class="route-cargo-fields">
                        <select id="route-cargo"></select>
                        <input id="route-amount" type="number" min="10" max="400" step="10" value="80" />
                      </div>
                    </div>
                    <button class="seed-button" id="route-add">+ Hinzufügen</button>
                  </div>
                </div>
              </div>
              <div class="card">
                <h3>Handelsknoten</h3>
                <ul>
                  <li>Orbit-Hubs speichern Reserveg&uuml;ter und puffern Krisen.</li>
                  <li>Schiffe lassen sich nach Bedarf priorisieren.</li>
                  <li>Frachtkapazit&auml;t beeinflusst Aufstiegsrate.</li>
                </ul>
                <div class="chip-row">
                  <span class="chip">Fracht</span>
                  <span class="chip">Routen</span>
                  <span class="chip">Subvention</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section>
        <h2>Planetare Siedlungssimulation</h2>
        <div class="grid-3">
          <div class="card">
            <h3>Inseln -&gt; Sektoren</h3>
            <p class="lead">
              Jeder Sektor hat eigenes Klima, Boden und Ressourcen - wie eine Insel mit
              klarem Profil.
            </p>
          </div>
          <div class="card">
            <h3>Handel -&gt; Orbit-Lanes</h3>
            <p class="lead">
              Handelsrouten verlaufen als Orbit-Lanes zwischen Sektoren und orbitalen
              Knotenpunkten.
            </p>
          </div>
          <div class="card">
            <h3>Warenketten -&gt; Terraforming</h3>
            <p class="lead">
              Klassische Ketten werden mit planetaren Systemen verkn&uuml;pft: Wasser,
              Sauerstoff und Energie sind Basiswaren.
            </p>
          </div>
          <div class="card">
            <h3>Bewohnerstufen</h3>
            <p class="lead">
              Pioniere, Kolonisten, Ingenieure, Terraformer - jede Stufe hebt die
              planetare Stabilit&auml;t.
            </p>
          </div>
          <div class="card">
            <h3>Politik &amp; Einfluss</h3>
            <p class="lead">
              Planetarer Rat, Umweltabgaben und Forschungsquoten ersetzen klassische Steuern.
            </p>
          </div>
        </div>
      </section>

      <section>
        <h2>Kern-Loop &amp; Progression</h2>
        <div class="steps">
          <div class="step">
            <div class="step-num">1</div>
            <strong>Sektoren scannen</strong>
            <p class="lead">Gebiete mit Ressourcen, Klima und Gefahren identifizieren.</p>
          </div>
          <div class="step">
            <div class="step-num">2</div>
            <strong>Siedlungen gr&uuml;nden</strong>
            <p class="lead">Grundversorgung sichern: Wasser, Energie, Nahrung.</p>
          </div>
          <div class="step">
            <div class="step-num">3</div>
            <strong>Warenketten bauen</strong>
            <p class="lead">Produktionen verzahnen und St&ouml;rungen stabilisieren.</p>
          </div>
          <div class="step">
            <div class="step-num">4</div>
            <strong>Orbit handeln</strong>
            <p class="lead">Routen optimieren, neue Sektoren anbinden, Upgrades finanzieren.</p>
          </div>
          <div class="step">
            <div class="step-num">5</div>
            <strong>Stufen aufsteigen</strong>
            <p class="lead">Bessere Infrastruktur schaltet Tools und Terraforming frei.</p>
          </div>
        </div>
      </section>
      <section id="chains">
        <h2>Warenketten &amp; Gesellschaft</h2>
        <p class="lead">
          Klicke auf einen Knoten, um Unterketten, Effekte und Engp&auml;sse sichtbar zu
          machen. Jede Stufe verr&auml;t dir, wo Optimierung am meisten bringt.
        </p>
        <div class="chain-legend">
          <span><span class="legend-dot good"></span>Stabil</span>
          <span><span class="legend-dot warn"></span>Knapp</span>
          <span><span class="legend-dot bad"></span>Engpass</span>
        </div>
        <div class="grid-2">
          <div class="card" data-chain-card>
            <h3>Warenkette: Lebenserhalt</h3>
            <p class="lead">Grundversorgung f&uuml;r die erste Bev&ouml;lkerungsstufe.</p>
            <div class="chain-map" role="list">
              <button
                class="chain-node"
                type="button"
                aria-expanded="true"
                aria-controls="life-ice"
                data-tooltip="Rohstoffquelle"
                data-status="good"
              >
                Eisfelder <span class="node-tag">Rohstoff</span>
                <span class="node-indicator" aria-hidden="true"></span>
              </button>
              <span class="chain-link">-&gt;</span>
              <button
                class="chain-node"
                type="button"
                aria-expanded="false"
                aria-controls="life-waterworks"
                data-tooltip="Verarbeitung"
                data-status="warn"
              >
                Wasserwerke <span class="node-tag">Veredelung</span>
                <span class="node-indicator" aria-hidden="true"></span>
              </button>
              <span class="chain-link">-&gt;</span>
              <button
                class="chain-node"
                type="button"
                aria-expanded="false"
                aria-controls="life-hydro"
                data-tooltip="Produktion"
                data-status="good"
              >
                Hydroponik <span class="node-tag">Produktion</span>
                <span class="node-indicator" aria-hidden="true"></span>
              </button>
              <span class="chain-link">-&gt;</span>
              <button
                class="chain-node"
                type="button"
                aria-expanded="false"
                aria-controls="life-food"
                data-tooltip="Endprodukt"
                data-status="bad"
              >
                Nahrung <span class="node-tag">Gut</span>
                <span class="node-indicator" aria-hidden="true"></span>
              </button>
              <span class="chain-link">-&gt;</span>
              <button
                class="chain-node"
                type="button"
                aria-expanded="false"
                aria-controls="life-pioneers"
                data-tooltip="Bev&ouml;lkerung"
                data-status="warn"
              >
                Pioniere <span class="node-tag">Stufe 1</span>
                <span class="node-indicator" aria-hidden="true"></span>
              </button>
            </div>
            <div class="subchain-group">
              <div id="life-ice" class="subchain is-open" role="region" aria-label="Eisfelder">
                <h4>Eisfelder</h4>
                <div class="subchain-grid">
                  <div class="subchain-row">
                    <span class="subchain-label">Input</span>
                    <span class="subchain-value">Energie</span>
                  </div>
                  <div class="subchain-row">
                    <span class="subchain-label">Output</span>
                    <span class="subchain-value">Schmelzwasser</span>
                  </div>
                  <div class="subchain-row">
                    <span class="subchain-label">Effekt</span>
                    <span class="subchain-value">+15% in Kaltsektoren</span>
                  </div>
                  <div class="subchain-row">
                    <span class="subchain-label">Engpass</span>
                    <span class="subchain-value good">Keiner</span>
                  </div>
                </div>
              </div>
              <div id="life-waterworks" class="subchain" role="region" aria-label="Wasserwerke">
                <h4>Wasserwerke</h4>
                <div class="subchain-grid">
                  <div class="subchain-row">
                    <span class="subchain-label">Input</span>
                    <span class="subchain-value">Eis</span>
                  </div>
                  <div class="subchain-row">
                    <span class="subchain-label">Output</span>
                    <span class="subchain-value">Trinkwasser</span>
                  </div>
                  <div class="subchain-row">
                    <span class="subchain-label">Effekt</span>
                    <span class="subchain-value">Puffer +2 Tage</span>
                  </div>
                  <div class="subchain-row">
                    <span class="subchain-label">Engpass</span>
                    <span class="subchain-value warn">Filterleistung</span>
                  </div>
                </div>
              </div>
              <div id="life-hydro" class="subchain" role="region" aria-label="Hydroponik">
                <h4>Hydroponik</h4>
                <div class="subchain-grid">
                  <div class="subchain-row">
                    <span class="subchain-label">Input</span>
                    <span class="subchain-value">Wasser, Energie</span>
                  </div>
                  <div class="subchain-row">
                    <span class="subchain-label">Output</span>
                    <span class="subchain-value">Nahrung</span>
                  </div>
                  <div class="subchain-row">
                    <span class="subchain-label">Effekt</span>
                    <span class="subchain-value">+10% in milden Sektoren</span>
                  </div>
                  <div class="subchain-row">
                    <span class="subchain-label">Engpass</span>
                    <span class="subchain-value good">Keiner</span>
                  </div>
                </div>
              </div>
              <div id="life-food" class="subchain" role="region" aria-label="Nahrung">
                <h4>Nahrung</h4>
                <div class="subchain-grid">
                  <div class="subchain-row">
                    <span class="subchain-label">Input</span>
                    <span class="subchain-value">Hydroponik</span>
                  </div>
                  <div class="subchain-row">
                    <span class="subchain-label">Output</span>
                    <span class="subchain-value">Versorgung</span>
                  </div>
                  <div class="subchain-row">
                    <span class="subchain-label">Bedarf</span>
                    <span class="subchain-value">1 Nahrung / Haushalt</span>
                  </div>
                  <div class="subchain-row">
                    <span class="subchain-label">Engpass</span>
                    <span class="subchain-value bad">Lager leer</span>
                  </div>
                </div>
              </div>
              <div id="life-pioneers" class="subchain" role="region" aria-label="Pioniere">
                <h4>Pioniere</h4>
                <div class="subchain-grid">
                  <div class="subchain-row">
                    <span class="subchain-label">Input</span>
                    <span class="subchain-value">Nahrung, Wasser</span>
                  </div>
                  <div class="subchain-row">
                    <span class="subchain-label">Output</span>
                    <span class="subchain-value">Bev&ouml;lkerungswachstum</span>
                  </div>
                  <div class="subchain-row">
                    <span class="subchain-label">Effekt</span>
                    <span class="subchain-value">Wachstum ab 60% Zufriedenheit</span>
                  </div>
                  <div class="subchain-row">
                    <span class="subchain-label">Engpass</span>
                    <span class="subchain-value warn">Bedarf steigt</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="card" data-chain-card>
            <h3>Warenkette: Industriegut</h3>
            <p class="lead">F&uuml;r Aufstieg zu Ingenieuren und orbitalen Modulen.</p>
            <div class="chain-map" role="list">
              <button
                class="chain-node"
                type="button"
                aria-expanded="true"
                aria-controls="ind-regolith"
                data-tooltip="Rohstoffquelle"
                data-status="good"
              >
                Regolith <span class="node-tag">Rohstoff</span>
                <span class="node-indicator" aria-hidden="true"></span>
              </button>
              <span class="chain-link">-&gt;</span>
              <button
                class="chain-node"
                type="button"
                aria-expanded="false"
                aria-controls="ind-refinery"
                data-tooltip="Verarbeitung"
                data-status="bad"
              >
                Erzraffinerie <span class="node-tag">Veredelung</span>
                <span class="node-indicator" aria-hidden="true"></span>
              </button>
              <span class="chain-link">-&gt;</span>
              <button
                class="chain-node"
                type="button"
                aria-expanded="false"
                aria-controls="ind-metal"
                data-tooltip="Halbfertig"
                data-status="warn"
              >
                Metall <span class="node-tag">Bauteil</span>
                <span class="node-indicator" aria-hidden="true"></span>
              </button>
              <span class="chain-link">-&gt;</span>
              <button
                class="chain-node"
                type="button"
                aria-expanded="false"
                aria-controls="ind-yard"
                data-tooltip="Produktion"
                data-status="good"
              >
                Werft <span class="node-tag">Fertigung</span>
                <span class="node-indicator" aria-hidden="true"></span>
              </button>
              <span class="chain-link">-&gt;</span>
              <button
                class="chain-node"
                type="button"
                aria-expanded="false"
                aria-controls="ind-freighter"
                data-tooltip="Logistik"
                data-status="warn"
              >
                Frachter <span class="node-tag">Transport</span>
                <span class="node-indicator" aria-hidden="true"></span>
              </button>
            </div>
            <div class="subchain-group">
              <div id="ind-regolith" class="subchain is-open" role="region" aria-label="Regolith">
                <h4>Regolith</h4>
                <div class="subchain-grid">
                  <div class="subchain-row">
                    <span class="subchain-label">Input</span>
                    <span class="subchain-value">Energie</span>
                  </div>
                  <div class="subchain-row">
                    <span class="subchain-label">Output</span>
                    <span class="subchain-value">Erz</span>
                  </div>
                  <div class="subchain-row">
                    <span class="subchain-label">Effekt</span>
                    <span class="subchain-value">+20% an Gebirgszonen</span>
                  </div>
                  <div class="subchain-row">
                    <span class="subchain-label">Engpass</span>
                    <span class="subchain-value good">Keiner</span>
                  </div>
                </div>
              </div>
              <div id="ind-refinery" class="subchain" role="region" aria-label="Erzraffinerie">
                <h4>Erzraffinerie</h4>
                <div class="subchain-grid">
                  <div class="subchain-row">
                    <span class="subchain-label">Input</span>
                    <span class="subchain-value">Erz, Energie</span>
                  </div>
                  <div class="subchain-row">
                    <span class="subchain-label">Output</span>
                    <span class="subchain-value">Metallbarren</span>
                  </div>
                  <div class="subchain-row">
                    <span class="subchain-label">Effekt</span>
                    <span class="subchain-value">Emissionen +8%</span>
                  </div>
                  <div class="subchain-row">
                    <span class="subchain-label">Engpass</span>
                    <span class="subchain-value bad">Energie fehlt</span>
                  </div>
                </div>
              </div>
              <div id="ind-metal" class="subchain" role="region" aria-label="Metall">
                <h4>Metall</h4>
                <div class="subchain-grid">
                  <div class="subchain-row">
                    <span class="subchain-label">Input</span>
                    <span class="subchain-value">Barren</span>
                  </div>
                  <div class="subchain-row">
                    <span class="subchain-label">Output</span>
                    <span class="subchain-value">Bauteile</span>
                  </div>
                  <div class="subchain-row">
                    <span class="subchain-label">Effekt</span>
                    <span class="subchain-value">Druckbonus +5%</span>
                  </div>
                  <div class="subchain-row">
                    <span class="subchain-label">Engpass</span>
                    <span class="subchain-value warn">Barren knapp</span>
                  </div>
                </div>
              </div>
              <div id="ind-yard" class="subchain" role="region" aria-label="Werft">
                <h4>Werft</h4>
                <div class="subchain-grid">
                  <div class="subchain-row">
                    <span class="subchain-label">Input</span>
                    <span class="subchain-value">Metall, Energie</span>
                  </div>
                  <div class="subchain-row">
                    <span class="subchain-label">Output</span>
                    <span class="subchain-value">Frachter</span>
                  </div>
                  <div class="subchain-row">
                    <span class="subchain-label">Effekt</span>
                    <span class="subchain-value">Bauzeit 3 Tage</span>
                  </div>
                  <div class="subchain-row">
                    <span class="subchain-label">Engpass</span>
                    <span class="subchain-value good">Keiner</span>
                  </div>
                </div>
              </div>
              <div id="ind-freighter" class="subchain" role="region" aria-label="Frachter">
                <h4>Frachter</h4>
                <div class="subchain-grid">
                  <div class="subchain-row">
                    <span class="subchain-label">Input</span>
                    <span class="subchain-value">Treibstoff</span>
                  </div>
                  <div class="subchain-row">
                    <span class="subchain-label">Output</span>
                    <span class="subchain-value">Transportkapazit&auml;t</span>
                  </div>
                  <div class="subchain-row">
                    <span class="subchain-label">Effekt</span>
                    <span class="subchain-value">+120t pro Route</span>
                  </div>
                  <div class="subchain-row">
                    <span class="subchain-label">Engpass</span>
                    <span class="subchain-value warn">Treibstoff knapp</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="card" style="margin-top: 20px;">
          <h3>Bev&ouml;lkerungsstufen</h3>
          <p class="lead">Neue Stufen erweitern Bedarfe und geben Simulationstools frei.</p>
          <div class="tier-grid">
            <div class="tier">
              <span>Pioniere</span>
              Wasser, Nahrung, Schutzkuppeln
            </div>
            <div class="tier">
              <span>Kolonisten</span>
              Stromnetz, Bildung, Grundkomfort
            </div>
            <div class="tier">
              <span>Ingenieure</span>
              Forschung, Versorgungsketten, Orbitalhafen
            </div>
            <div class="tier">
              <span>Terraformer</span>
              Atmosph&auml;re, Biome, Klima-Module
            </div>
          </div>
        </div>
      </section>

      <section>
        <h2>Sektor-Detailpanel</h2>
        <div class="card sector-panel">
          <div>
            <h3>Nordkuppe 07</h3>
            <p class="lead">
              Polarer Sektor mit Eisfeldern und seltenen Erzen. Gute Wasserlage, aber
              regelm&auml;&szlig;ige St&uuml;rme.
            </p>
            <div class="stat-list">
              <div class="stat-row"><span class="stat-label">Ressourcen</span><span class="stat-value">Eis, Erz, Gas</span></div>
              <div class="stat-row"><span class="stat-label">Wetterlage</span><span class="stat-value">Sturm / 4d</span></div>
              <div class="stat-row"><span class="stat-label">Industrie</span><span class="stat-value">+18% Output</span></div>
              <div class="stat-row"><span class="stat-label">Wohnraum</span><span class="stat-value">+2.200</span></div>
            </div>
          </div>
          <div>
            <div class="sector-map" aria-hidden="true">
              <span class="map-marker ore"></span>
              <span class="map-marker water"></span>
              <span class="map-marker risk"></span>
            </div>
            <div class="legend">Ressourcen, Risiko, Infrastruktur</div>
            <div class="chip-row">
              <span class="chip">Baufl&auml;che 62%</span>
              <span class="chip">Energie +15%</span>
              <span class="chip">Sturmzone</span>
            </div>
          </div>
        </div>
      </section>

      <section>
        <h2>UI/UX Mockup</h2>
        <div class="ui-layout">
          <div class="ui-frame">
            <div class="ui-top">Planet-Ansicht | Sektor-Ansicht | Handelsnetz</div>
            <div class="ui-body">
              <div class="ui-panel">
                <strong>Tools</strong>
                <div class="chip-row">
                  <span class="chip">Siedlung</span>
                  <span class="chip">Ketten</span>
                  <span class="chip">Terraforming</span>
                  <span class="chip">Ereignisse</span>
                </div>
              </div>
              <div class="ui-center">
                <div class="planet"></div>
                <div>3D-Planet + Sektor-Overlay</div>
              </div>
              <div class="ui-panel">
                <strong>Status</strong>
                <ul>
                  <li>Versorgung</li>
                  <li>Zufriedenheit</li>
                  <li>Emissionen</li>
                  <li>Handelsrouten</li>
                </ul>
              </div>
            </div>
            <div class="ui-bottom">Pause | 1x | 4x | 10x | Warnungen</div>
          </div>
        </div>
      </section>

      <section>
        <h2>Planetare Simulation &amp; Systeme</h2>
        <div class="grid-2">
          <div class="card">
            <ul>
              <li>Atmosph&auml;re, Druck, Temperatur und Jahreszeiten.</li>
              <li>Hydrologie mit Ozeanen, Niederschlag und Feuchtezonen.</li>
              <li>Tektonik erzeugt Ressourcen und Risikozonen.</li>
              <li>Biome wirken auf Ertr&auml;ge und Siedlungsstabilit&auml;t.</li>
              <li>Ereignisse: Meteor, Supervulkan, Staubsturm.</li>
            </ul>
          </div>
          <div class="card">
            <h3>Simulation trifft Wirtschaft</h3>
            <ul>
              <li>Klima beeinflusst Produktionsraten und Versorgung.</li>
              <li>Emissionen k&ouml;nnen die Temperatur kippen.</li>
              <li>Orbitale Module stabilisieren Wetter und Logistik.</li>
              <li>Analyse-Overlays zeigen Engp&auml;sse klar.</li>
            </ul>
            <div class="chip-row">
              <span class="chip">Temperatur</span>
              <span class="chip">Druck</span>
              <span class="chip">Biom</span>
              <span class="chip">Handel</span>
            </div>
          </div>
        </div>
      </section>

      <section>
        <h2>Tools &amp; Eingriffe</h2>
        <div class="grid-2">
          <div class="card">
            <ul>
              <li>Terraforming-Pinsel f&uuml;r H&ouml;he, Feuchte, Vegetation.</li>
              <li>Atmosph&auml;ren-Mixer f&uuml;r O2/CO2/N2.</li>
              <li>Sonnenintensit&auml;t und Magnetfeld steuern.</li>
              <li>Zeitraffer und Zeitsprung f&uuml;r Makroplanung.</li>
            </ul>
          </div>
          <div class="card">
            <h3>Spielmechanische Limits</h3>
            <ul>
              <li>Tools kosten Einfluss oder Ressourcen.</li>
              <li>Cooldowns erzwingen strategische Planung.</li>
              <li>Events sind Risiko-Management, kein Reset.</li>
            </ul>
          </div>
        </div>
      </section>

      <section>
        <h2>Ereignisse &amp; Warnungen</h2>
        <div class="grid-2">
          <div class="card">
            <h3>Timeline</h3>
            <div class="timeline">
              <div class="timeline-item">
                <span class="timeline-dot"></span>
                <div class="timeline-card">
                  <strong>Staubsturm (Nordkuppe)</strong>
                  <p>Logistik -20% f&uuml;r 4 Tage.</p>
                </div>
              </div>
              <div class="timeline-item">
                <span class="timeline-dot"></span>
                <div class="timeline-card">
                  <strong>Orbit-Fenster offen</strong>
                  <p>Bonus auf Handel f&uuml;r 2 Tage.</p>
                </div>
              </div>
              <div class="timeline-item">
                <span class="timeline-dot"></span>
                <div class="timeline-card">
                  <strong>Vulkanische Aktivierung</strong>
                  <p>CO2-Anstieg, neue Erzfelder.</p>
                </div>
              </div>
            </div>
          </div>
          <div class="card">
            <h3>Warnungen</h3>
            <div class="warning-grid">
              <div class="warning-card">
                <div class="warning-icon">!</div>
                <div>
                  <strong>Versorgungsl&uuml;cke</strong>
                  <p>Hydroponik fehlt 12t Wasser.</p>
                </div>
              </div>
              <div class="warning-card">
                <div class="warning-icon">!</div>
                <div>
                  <strong>Emissionslimit</strong>
                  <p>CO2 n&auml;hert sich 60%.</p>
                </div>
              </div>
              <div class="warning-card">
                <div class="warning-icon">!</div>
                <div>
                  <strong>Routenstau</strong>
                  <p>Orbit-Lane A &uuml;berlastet.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="seeds">
        <h2>Planetenarchiv &amp; Seeds</h2>
        <div class="grid-3">
          <div class="card">
            <h3>Seed-Generator</h3>
            <p class="lead">
              Jeder Planet entsteht aus einem Seed. Gleicher Seed bedeutet identische
              Welt, ein neuer Seed erzeugt andere Klima-, Ressourcen- und Risiko-Kombinationen.
            </p>
            <div class="seed-form">
              <label class="seed-tag" for="seed-input">Seed</label>
              <input
                id="seed-input"
                class="seed-input"
                type="text"
                value="ORBIT-9A2"
                autocomplete="off"
              />
            <div class="seed-actions">
              <button class="seed-button" type="button" id="seed-apply">Seed anwenden</button>
              <button class="seed-button secondary" type="button" id="seed-random">
                Neu w&uuml;rfeln
              </button>
              <button class="seed-button secondary" type="button" id="seed-copy">
                Link kopieren
              </button>
              <button class="seed-button secondary" type="button" id="seed-save">
                Im Archiv speichern
              </button>
            </div>
            <p class="seed-feedback" id="seed-feedback" role="status"></p>
          </div>
          <div class="seed-output">
            <div class="seed-row"><span>Seed</span><strong data-seed-out="seed"></strong></div>
            <div class="seed-row"><span>Planetentyp</span><strong data-seed-out="size"></strong></div>
            <div class="seed-row"><span>Klima</span><strong data-seed-out="climate"></strong></div>
              <div class="seed-row"><span>Ozeananteil</span><strong data-seed-out="ocean"></strong></div>
              <div class="seed-row"><span>Schwerkraft</span><strong data-seed-out="gravity"></strong></div>
              <div class="seed-row"><span>Ressourcen</span><strong data-seed-out="resources"></strong></div>
              <div class="seed-row"><span>Risiko</span><strong data-seed-out="hazard"></strong></div>
              <div class="seed-row"><span>Sektoren</span><strong data-seed-out="sectors"></strong></div>
            </div>
          </div>
          <div class="card">
            <h3>Seed-Archiv</h3>
            <p class="lead">
              Favoriten bleiben oben. Lade gespeicherte Seeds, um identische Welten
              zu rekonstruieren.
            </p>
            <div class="seed-actions">
              <button class="seed-button secondary" type="button" id="seed-clear">
                Archiv leeren
              </button>
            </div>
            <div class="archive-list" id="seed-archive" aria-live="polite"></div>
            <p class="archive-empty" id="seed-archive-empty">Noch keine Seeds gespeichert.</p>
          </div>
          <div class="card">
            <h3>Preset-Galerie</h3>
            <div class="planet-gallery">
              <div class="planet-card" data-seed="DUNE-3C7" data-seed-bias="ocean-low">
                <div class="planet-mini desert"></div>
                <strong>&Ouml;dland</strong>
                <p class="planet-note">Wenig Wasser, hohe Erze.</p>
                <div class="seed-tag">Seed: <span data-seed-value></span></div>
                <div class="planet-meta">
                  <div class="meta-row"><span>Klima</span><span class="meta-value" data-seed-field="climate"></span></div>
                  <div class="meta-row"><span>Ozean</span><span class="meta-value" data-seed-field="ocean"></span></div>
                  <div class="meta-row"><span>Risiko</span><span class="meta-value" data-seed-field="hazard"></span></div>
                </div>
                <button class="seed-button secondary" type="button" data-seed-load>
                  Seed laden
                </button>
              </div>
              <div class="planet-card" data-seed="AQUA-91F" data-seed-bias="ocean-high">
                <div class="planet-mini ocean"></div>
                <strong>Wasserwelt</strong>
                <p class="planet-note">Handel leicht, Land knapp.</p>
                <div class="seed-tag">Seed: <span data-seed-value></span></div>
                <div class="planet-meta">
                  <div class="meta-row"><span>Klima</span><span class="meta-value" data-seed-field="climate"></span></div>
                  <div class="meta-row"><span>Ozean</span><span class="meta-value" data-seed-field="ocean"></span></div>
                  <div class="meta-row"><span>Risiko</span><span class="meta-value" data-seed-field="hazard"></span></div>
                </div>
                <button class="seed-button secondary" type="button" data-seed-load>
                  Seed laden
                </button>
              </div>
              <div class="planet-card" data-seed="NIVIS-22A" data-seed-bias="ice">
                <div class="planet-mini ice"></div>
                <strong>Eisplanet</strong>
                <p class="planet-note">K&auml;lte, starke St&uuml;rme.</p>
                <div class="seed-tag">Seed: <span data-seed-value></span></div>
                <div class="planet-meta">
                  <div class="meta-row"><span>Klima</span><span class="meta-value" data-seed-field="climate"></span></div>
                  <div class="meta-row"><span>Ozean</span><span class="meta-value" data-seed-field="ocean"></span></div>
                  <div class="meta-row"><span>Risiko</span><span class="meta-value" data-seed-field="hazard"></span></div>
                </div>
                <button class="seed-button secondary" type="button" data-seed-load>
                  Seed laden
                </button>
              </div>
              <div class="planet-card" data-seed="EMBER-7D1" data-seed-bias="ember">
                <div class="planet-mini ember"></div>
                <strong>Vulkanwelt</strong>
                <p class="planet-note">Hohe Energie, riskante Zonen.</p>
                <div class="seed-tag">Seed: <span data-seed-value></span></div>
                <div class="planet-meta">
                  <div class="meta-row"><span>Klima</span><span class="meta-value" data-seed-field="climate"></span></div>
                  <div class="meta-row"><span>Ozean</span><span class="meta-value" data-seed-field="ocean"></span></div>
                  <div class="meta-row"><span>Risiko</span><span class="meta-value" data-seed-field="hazard"></span></div>
                </div>
                <button class="seed-button secondary" type="button" data-seed-load>
                  Seed laden
                </button>
              </div>
              <div class="planet-card" data-seed="VERDE-58B" data-seed-bias="lush">
                <div class="planet-mini forest"></div>
                <strong>Dschungelwelt</strong>
                <p class="planet-note">Biomasse stark, Wege schwer.</p>
                <div class="seed-tag">Seed: <span data-seed-value></span></div>
                <div class="planet-meta">
                  <div class="meta-row"><span>Klima</span><span class="meta-value" data-seed-field="climate"></span></div>
                  <div class="meta-row"><span>Ozean</span><span class="meta-value" data-seed-field="ocean"></span></div>
                  <div class="meta-row"><span>Risiko</span><span class="meta-value" data-seed-field="hazard"></span></div>
                </div>
                <button class="seed-button secondary" type="button" data-seed-load>
                  Seed laden
                </button>
              </div>
              <div class="planet-card" data-seed="FERRA-4E8" data-seed-bias="metal">
                <div class="planet-mini metal"></div>
                <strong>Metallwelt</strong>
                <p class="planet-note">Erzreich, Industriebonus.</p>
                <div class="seed-tag">Seed: <span data-seed-value></span></div>
                <div class="planet-meta">
                  <div class="meta-row"><span>Klima</span><span class="meta-value" data-seed-field="climate"></span></div>
                  <div class="meta-row"><span>Ozean</span><span class="meta-value" data-seed-field="ocean"></span></div>
                  <div class="meta-row"><span>Risiko</span><span class="meta-value" data-seed-field="hazard"></span></div>
                </div>
                <button class="seed-button secondary" type="button" data-seed-load>
                  Seed laden
                </button>
              </div>
            </div>
          </div>
          <div class="card">
            <h3>Challenges</h3>
            <div class="challenge-grid">
              <div class="challenge-card">
                <strong>Balance</strong>
                <p>Temperatur 0-30C f&uuml;r 20 Zyklen.</p>
              </div>
              <div class="challenge-card">
                <strong>Blaue Welt</strong>
                <p>Mindestens 30% Ozeananteil.</p>
              </div>
              <div class="challenge-card">
                <strong>Autarkie</strong>
                <p>Alle Bedarfe ohne Import decken.</p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="achievements">
        <h2>🏆 Achievements</h2>
        <p class="lead">Sammle Erfolge und zeige deine Errungenschaften.</p>
        <div class="achievement-grid" id="achievement-grid">
          <!-- Wird dynamisch generiert -->
        </div>
      </section>

      <section id="build-editor">
        <h2>🏗️ Interaktiver Baueditor</h2>
        <p class="lead">Platziere Gebäude und sieh Versorgungsradien in Echtzeit.</p>
        <div class="build-editor">
          <div class="build-palette">
            <div class="build-item selected" data-building="home">
              <span class="item-icon">🏠</span>
              <div class="item-text">
                <span>Wohnkuppel</span>
                <span class="item-meta">120 Metall</span>
              </div>
            </div>
            <div class="build-item" data-building="solar">
              <span class="item-icon">⚡</span>
              <div class="item-text">
                <span>Solarfeld</span>
                <span class="item-meta">100 Metall</span>
              </div>
            </div>
            <div class="build-item" data-building="water">
              <span class="item-icon">💧</span>
              <div class="item-text">
                <span>Wasserwerk</span>
                <span class="item-meta">150 Metall</span>
              </div>
            </div>
            <div class="build-item" data-building="hydro">
              <span class="item-icon">🌱</span>
              <div class="item-text">
                <span>Hydroponik</span>
                <span class="item-meta">200 Metall</span>
              </div>
            </div>
            <div class="build-item" data-building="refinery">
              <span class="item-icon">🏭</span>
              <div class="item-text">
                <span>Raffinerie</span>
                <span class="item-meta">300 Metall</span>
              </div>
            </div>
            <div class="build-item" data-building="lab">
              <span class="item-icon">🔬</span>
              <div class="item-text">
                <span>Labor</span>
                <span class="item-meta">250 Metall</span>
              </div>
            </div>
            <div class="build-item" data-building="spaceport">
              <span class="item-icon">🚀</span>
              <div class="item-text">
                <span>Raumhafen</span>
                <span class="item-meta">500 Metall</span>
              </div>
            </div>
            <div class="build-item" data-building="warehouse">
              <span class="item-icon">📦</span>
              <div class="item-text">
                <span>Lager</span>
                <span class="item-meta">80 Metall</span>
              </div>
            </div>
            <div class="build-item" data-building="barracks">
              <span class="item-icon">⚔️</span>
              <div class="item-text">
                <span>Kaserne</span>
                <span class="item-meta">400 Metall</span>
              </div>
            </div>
            <div class="build-item is-locked" data-building="fusion-reactor" data-requires="fusion">
              <span class="item-icon">⚛️</span>
              <div class="item-text">
                <span>Fusionsreaktor</span>
                <span class="item-meta">600 Metall</span>
              </div>
            </div>
            <div class="build-item is-locked" data-building="orbital-shipyard" data-requires="orbital">
              <span class="item-icon">🛰️</span>
              <div class="item-text">
                <span>Orbit-Werft</span>
                <span class="item-meta">800 Metall</span>
              </div>
            </div>
            <div class="build-item is-locked" data-building="dyson-mirror" data-requires="dyson">
              <span class="item-icon">☀️</span>
              <div class="item-text">
                <span>Dyson-Spiegel</span>
                <span class="item-meta">1200 Metall</span>
              </div>
            </div>
            <div class="build-item" data-action="delete">
              <span class="item-icon">🗑️</span>
              <div class="item-text">
                <span>Löschen</span>
                <span class="item-meta">Entfernen</span>
              </div>
            </div>
          </div>
          <div class="build-grid" id="build-grid">
            <!-- Grid wird per JS generiert -->
          </div>
        </div>
        <div class="callout" style="margin-top: 16px;">
          <strong>Tipp:</strong> Klicke auf ein Gebäude links, dann auf eine Zelle im Grid. Der grüne Bereich zeigt den Versorgungsradius.
        </div>
      </section>

      <section id="catastrophe">
        <h2>💥 Katastrophen-Simulator</h2>
        <p class="lead">Simuliere Naturkatastrophen und plane deine Verteidigung.</p>
        <div class="catastrophe-sim">
          <div class="catastrophe-controls">
            <div class="catastrophe-type selected">
              <h4>☄️ Meteoriteneinschlag</h4>
              <p>Zerstört Infrastruktur, neue Erzvorkommen</p>
            </div>
            <div class="catastrophe-type">
              <h4>🌋 Supervulkan</h4>
              <p>CO₂-Anstieg, Temperaturänderung, Asche</p>
            </div>
            <div class="catastrophe-type">
              <h4>🌪️ Megasturm</h4>
              <p>Logistik unterbrochen, Gebäudeschäden</p>
            </div>
            <div class="catastrophe-type">
              <h4>☀️ Sonneneruption</h4>
              <p>Elektronik ausgefallen, Strahlung</p>
            </div>
          </div>
          <div class="catastrophe-preview">
            <h3>Vorschau: Meteoriteneinschlag</h3>
            <p class="lead">Sektor Nordkuppe 07</p>
            <div class="preview-comparison">
              <div class="preview-state">
                <h5>Vorher</h5>
                <div class="stat"><span>Bevölkerung</span><span>24.500</span></div>
                <div class="stat"><span>Industrie</span><span>12 Betriebe</span></div>
                <div class="stat"><span>Erz</span><span>45%</span></div>
                <div class="stat"><span>Wasser</span><span>78%</span></div>
              </div>
              <div class="preview-state">
                <h5>Nachher</h5>
                <div class="stat negative"><span>Bevölkerung</span><span>-8.200 ⚠️</span></div>
                <div class="stat negative"><span>Industrie</span><span>-5 Betriebe</span></div>
                <div class="stat positive"><span>Erz</span><span>+25% 📈</span></div>
                <div class="stat negative"><span>Wasser</span><span>-15%</span></div>
              </div>
            </div>
            <button class="seed-button" style="margin-top: 16px;">Simulation starten</button>
          </div>
        </div>
      </section>

      <section id="community-seeds">
        <h2>🌐 Community Seeds</h2>
        <p class="lead">Entdecke von Spielern geteilte Welten mit einzigartigen Herausforderungen.</p>
        <div class="community-seeds">
          <div class="community-seed-card">
            <span class="seed-difficulty hard">Schwer</span>
            <div class="seed-author">
              <div class="author-avatar">TF</div>
              <div class="author-info">
                <strong>TerraFormer_42</strong>
                <span>Vor 2 Tagen</span>
              </div>
            </div>
            <div class="seed-code">HELL-666</div>
            <p class="seed-desc">Vulkanwelt ohne Wasservorkommen. Kannst du überleben?</p>
            <div class="seed-stats">
              <span>⬇️ 1.2k Downloads</span>
              <span>⭐ 4.8</span>
              <span>💬 47</span>
            </div>
          </div>
          <div class="community-seed-card">
            <span class="seed-difficulty easy">Einfach</span>
            <div class="seed-author">
              <div class="author-avatar">SB</div>
              <div class="author-info">
                <strong>SpaceBuilder</strong>
                <span>Vor 5 Tagen</span>
              </div>
            </div>
            <div class="seed-code">EDEN-001</div>
            <p class="seed-desc">Perfekte Startbedingungen für Anfänger. Viel Wasser!</p>
            <div class="seed-stats">
              <span>⬇️ 3.4k Downloads</span>
              <span>⭐ 4.9</span>
              <span>💬 89</span>
            </div>
          </div>
          <div class="community-seed-card">
            <span class="seed-difficulty extreme">Extrem</span>
            <div class="seed-author">
              <div class="author-avatar">HC</div>
              <div class="author-info">
                <strong>HardcoreColonist</strong>
                <span>Vor 1 Woche</span>
              </div>
            </div>
            <div class="seed-code">VOID-X99</div>
            <p class="seed-desc">Kein Magnetfeld, ständige Strahlung, minimale Ressourcen.</p>
            <div class="seed-stats">
              <span>⬇️ 890 Downloads</span>
              <span>⭐ 4.6</span>
              <span>💬 156</span>
            </div>
          </div>
          <div class="community-seed-card">
            <span class="seed-difficulty medium">Mittel</span>
            <div class="seed-author">
              <div class="author-avatar">WW</div>
              <div class="author-info">
                <strong>WaterWorld</strong>
                <span>Vor 3 Tagen</span>
              </div>
            </div>
            <div class="seed-code">OCEAN-42</div>
            <p class="seed-desc">90% Ozean. Baue schwimmende Kolonien!</p>
            <div class="seed-stats">
              <span>⬇️ 2.1k Downloads</span>
              <span>⭐ 4.7</span>
              <span>💬 72</span>
            </div>
          </div>
        </div>
      </section>

      <section id="roadmap">
        <h2>🗺️ Entwickler-Roadmap</h2>
        <p class="lead">Die Zukunft von Planet Sandbox – von der Idee bis zum Release.</p>
        <div class="roadmap">
          <div class="roadmap-phase">
            <div class="phase-content">
              <h4>Konzept & Design</h4>
              <span>Q1 2024</span>
            </div>
            <div class="phase-marker completed">✓</div>
            <div class="phase-details">
              <ul>
                <li>Game Design Document</li>
                <li>UI/UX Konzept</li>
                <li>Erste Prototypen</li>
              </ul>
            </div>
          </div>
          <div class="roadmap-phase">
            <div class="phase-content">
              <h4>Alpha</h4>
              <span>Q2 2024</span>
            </div>
            <div class="phase-marker current">α</div>
            <div class="phase-details">
              <ul>
                <li>Kernmechaniken</li>
                <li>Warenketten</li>
                <li>Erste Spielbarkeit</li>
              </ul>
            </div>
          </div>
          <div class="roadmap-phase">
            <div class="phase-content">
              <h4>Beta</h4>
              <span>Q4 2024</span>
            </div>
            <div class="phase-marker">β</div>
            <div class="phase-details">
              <ul>
                <li>Multiplayer</li>
                <li>Vollständige Kampagne</li>
                <li>Modding-Support</li>
              </ul>
            </div>
          </div>
          <div class="roadmap-phase">
            <div class="phase-content">
              <h4>Release</h4>
              <span>Q2 2025</span>
            </div>
            <div class="phase-marker">1.0</div>
            <div class="phase-details">
              <ul>
                <li>Vollversion</li>
                <li>Steam Release</li>
                <li>Konsolen-Ports</li>
              </ul>
            </div>
          </div>
        </div>
      </section>

      <section id="multiplayer">
        <h2>🎮 Multiplayer-Konzept</h2>
        <p class="lead">Verschiedene Modi für kooperatives und kompetitives Spiel.</p>
        <div class="multiplayer-modes">
          <div class="mode-card">
            <div class="mode-icon coop">🤝</div>
            <h4>Kooperativ</h4>
            <p>Gemeinsam einen Planeten besiedeln und terraformen.</p>
            <ul class="mode-features">
              <li>Geteilte Ressourcen</li>
              <li>Spezialisierung möglich</li>
              <li>Gemeinsame Ziele</li>
            </ul>
          </div>
          <div class="mode-card">
            <div class="mode-icon pvp">⚔️</div>
            <h4>Kompetitiv</h4>
            <p>Wettstreit um Sektoren und Handelsrouten.</p>
            <ul class="mode-features">
              <li>Territorialkämpfe</li>
              <li>Handelskriege</li>
              <li>Sabotage möglich</li>
            </ul>
          </div>
          <div class="mode-card">
            <div class="mode-icon race">🏁</div>
            <h4>Wettrennen</h4>
            <p>Wer erreicht zuerst die Terraforming-Stufe?</p>
            <ul class="mode-features">
              <li>Zeitdruck</li>
              <li>Meilenstein-Boni</li>
              <li>Ranglisten</li>
            </ul>
          </div>
          <div class="mode-card">
            <div class="mode-icon trade">💹</div>
            <h4>Handelsnetzwerk</h4>
            <p>Reine Wirtschaftssimulation zwischen Spielern.</p>
            <ul class="mode-features">
              <li>Globaler Markt</li>
              <li>Verträge & Abkommen</li>
              <li>Wirtschaftskrisen</li>
            </ul>
          </div>
        </div>
      </section>

      <section id="modding">
        <h2>🔧 Modding-API</h2>
        <p class="lead">Erweitere das Spiel mit eigenen Inhalten und Mechaniken.</p>
        <div class="modding-docs">
          <div class="card">
            <h3>Eigene Warenketten definieren</h3>
            <div class="code-block">
<span class="comment">// Beispiel: Neue Produktionskette</span>
{
  <span class="string">"id"</span>: <span class="string">"luxus_nahrung"</span>,
  <span class="string">"name"</span>: <span class="string">"Gourmet-Mahlzeiten"</span>,
  <span class="string">"inputs"</span>: [
    { <span class="string">"resource"</span>: <span class="string">"nahrung"</span>, <span class="string">"amount"</span>: <span class="number">2</span> },
    { <span class="string">"resource"</span>: <span class="string">"wasser"</span>, <span class="string">"amount"</span>: <span class="number">1</span> }
  ],
  <span class="string">"outputs"</span>: [
    { <span class="string">"resource"</span>: <span class="string">"luxus_nahrung"</span>, <span class="string">"amount"</span>: <span class="number">1</span> }
  ],
  <span class="string">"productionTime"</span>: <span class="number">120</span>,
  <span class="string">"requiredTech"</span>: <span class="string">"advanced_farming"</span>
}
            </div>
          </div>
          <div class="card">
            <h3>API-Endpunkte</h3>
            <div class="api-endpoint">
              <span class="method get">GET</span>
              <span class="path">/api/planet/{id}/sectors</span>
              <p>Gibt alle Sektoren eines Planeten zurück.</p>
            </div>
            <div class="api-endpoint">
              <span class="method post">POST</span>
              <span class="path">/api/buildings/place</span>
              <p>Platziert ein Gebäude an gegebenen Koordinaten.</p>
            </div>
            <div class="api-endpoint">
              <span class="method put">PUT</span>
              <span class="path">/api/traderoutes/{id}</span>
              <p>Aktualisiert eine bestehende Handelsroute.</p>
            </div>
          </div>
        </div>
      </section>

      <section id="export">
        <h2>📤 Export & Teilen</h2>
        <p class="lead">Speichere und teile deine Planetenkonfiguration.</p>
        <div class="export-panel">
          <button class="export-btn" id="export-json">
            <span>📄</span> Als JSON exportieren
          </button>
          <button class="export-btn" id="export-png">
            <span>🖼️</span> Als PNG speichern
          </button>
          <button class="export-btn" id="export-link">
            <span>🔗</span> Teilbarer Link
          </button>
          <button class="export-btn" id="export-clipboard">
            <span>📋</span> In Zwischenablage
          </button>
          <button class="export-btn" id="export-print">
            <span>🖨️</span> Drucken / PDF
          </button>
        </div>
        <div class="grid-2" style="margin-top: 20px;">
          <div class="card">
            <h3>📥 Import</h3>
            <p class="lead">Lade einen gespeicherten Spielstand oder Seed.</p>
            <div class="import-zone" id="import-zone">
              <input type="file" id="import-file" accept=".json">
              <p>📁 JSON-Datei hierher ziehen oder klicken</p>
            </div>
          </div>
          <div class="card">
            <h3>💾 Spielstand</h3>
            <p class="lead">Speichere den kompletten Fortschritt lokal.</p>
            <div class="seed-actions" style="margin-top: 12px;">
              <button class="seed-button" id="save-game">Spielstand speichern</button>
              <button class="seed-button secondary" id="load-game">Spielstand laden</button>
            </div>
            <p class="seed-feedback" id="save-feedback" role="status" style="margin-top: 10px;"></p>
          </div>
        </div>
      </section>

      <section>
        <h2>Technische Umsetzung (Prototyp)</h2>
        <div class="card">
          <ol>
            <li>Sektoren-Grid auf Kugel mappen, Ressourcen- und Klima-Layer speichern.</li>
            <li>Produktionsketten-System mit Input/Output, Lager und Transportzeiten.</li>
            <li>Orbit-Lanes als Graph mit Kosten, Zeit und Kapazit&auml;t.</li>
            <li>Simulations-Update f&uuml;r Klima und Biome (vereinfacht).</li>
            <li>UI mit drei Modi: Planet, Sektor, Handel.</li>
          </ol>
        </div>
      </section>

      <section>
        <h2>Weitere Ideen (direkt umgesetzt)</h2>
        <div class="idea-grid">
          <div class="idea-card">
            <h3>Ratsbeschl&uuml;sse</h3>
            <p class="lead">
              Politische Edikte als tempor&auml;re Buffs/Debuffs, z. B. Subventionen oder
              Emissionsbremse.
            </p>
            <div class="chip-row">
              <span class="chip">Subvention</span>
              <span class="chip">Umweltabgabe</span>
              <span class="chip">Forschung</span>
            </div>
          </div>
          <div class="idea-card">
            <h3>Orbitale Megaprojekte</h3>
            <p class="lead">
              Langzeitprojekte wie Raumhafen, Klima-Spiegel oder Exportturm als Endgame-Ziele.
            </p>
            <div class="chip-row">
              <span class="chip">Raumhafen</span>
              <span class="chip">Sonnenpiegel</span>
            </div>
          </div>
          <div class="idea-card">
            <h3>Szenario-Editor</h3>
            <p class="lead">
              Eigene Startbedingungen, Ereignisse und Handelsregeln f&uuml;r kreative
              Herausforderungen.
            </p>
            <div class="chip-row">
              <span class="chip">Preset bauen</span>
              <span class="chip">Challenge teilen</span>
            </div>
          </div>
          <div class="idea-card">
            <h3>Fraktionen &amp; Diplomatie</h3>
            <p class="lead">
              KI-Fraktionen als Handelspartner oder Rivalen mit eigenen Umweltzielen.
            </p>
            <div class="chip-row">
              <span class="chip">Allianzen</span>
              <span class="chip">Konflikt</span>
              <span class="chip">Vertrag</span>
            </div>
          </div>
        </div>
      </section>

      <section>
        <h2>Risiken &amp; Abgrenzungen</h2>
        <div class="card">
          <ul>
            <li>Keine wissenschaftliche Genauigkeit - Fokus auf Lesbarkeit und Balance.</li>
            <li>Begrenzte Tiefe bei Physik und Str&ouml;mungsmodellen.</li>
            <li>Kein Multiplayer im Prototyp.</li>
            <li>Visualisierung vor Realismus: klare Feedback-Schleifen.</li>
          </ul>
        </div>
      </section>
    </main>
    <script>
      (() => {
        // --- Utilities: Toasts ---
        const toast = ({ type = "info", title = "Info", message = "", timeout = 2500 } = {}) => {
          const notificationsEnabled = document.getElementById('setting-notifications')?.checked ?? true;
          if (!notificationsEnabled && (type === 'info' || type === 'success')) {
            return;
          }
          const container = document.getElementById("toast-container");
          if (!container) return;

          const icon = type === "success" ? "✓" : type === "warning" ? "!" : type === "danger" ? "×" : "i";

          const el = document.createElement("div");
          el.className = "toast";
          el.dataset.type = type;
          el.innerHTML = `
            <div class="toast-icon" aria-hidden="true">${icon}</div>
            <div class="toast-body">
              <div class="toast-title">${title}</div>
              ${message ? `<div class="toast-message">${message}</div>` : ""}
            </div>
            <button type="button" class="toast-close" aria-label="Schließen">×</button>
          `;

          const close = () => {
            el.style.animation = "toastOut 180ms ease forwards";
            window.setTimeout(() => el.remove(), 180);
          };
          el.querySelector(".toast-close")?.addEventListener("click", close);

          container.appendChild(el);
          window.setTimeout(close, timeout);
        };

        let applySeedToUI = null;

        const emptyProductionStats = () => ({
          totalProduced: {},
          totalConsumed: {},
          buildingsActive: 0,
          buildingsBlocked: 0
        });

        let lastProductionStats = emptyProductionStats();

        const getActivePlanetId = () => multiPlanetState?.activePlanetId || 'default';

        const resourceDefinitions = {
          military: { label: "Militär", unit: "Einheiten", icon: "⚔️" },
          ice: { label: "Eis", unit: "t", icon: "🧊" },
          regolith: { label: "Regolith", unit: "t", icon: "🪨" },
          water: { label: "Wasser", unit: "t", icon: "💧" },
          energy: { label: "Energie", unit: "MW", icon: "⚡" },
          food: { label: "Nahrung", unit: "t", icon: "🥗" },
          metal: { label: "Metall", unit: "t", icon: "🧱" }
        };

        const tradeState = {
          totalExported: 0,
          completedRoutes: 0
        };

        const activeEffects = [];

        const factionState = {
          tech: {
            name: 'Technokraten-Union',
            relation: 72,
            treaties: ['Forschungsabkommen'],
            effects: {
              researchBonus: 0.15
            }
          },
          trade: {
            name: 'Handelsgilde',
            relation: 58,
            treaties: [],
            effects: {
              tradeBonus: 0.1
            }
          },
          eco: {
            name: 'Öko-Kollektiv',
            relation: 45,
            treaties: [],
            effects: {
              emissionsReduction: 0.05
            }
          }
        };

        const setupTabs = () => {
          const tabs = Array.from(document.querySelectorAll('[role="tab"]'));
          if (!tabs.length) return;
          const activate = (tab) => {
            tabs.forEach((btn) => {
              const isActive = btn === tab;
              btn.setAttribute("aria-selected", isActive ? "true" : "false");
              btn.tabIndex = isActive ? 0 : -1;
              const panelId = btn.getAttribute("aria-controls");
              const panel = document.getElementById(panelId);
              if (panel) {
                panel.hidden = !isActive;
              }
            });
          };

          tabs.forEach((tab, index) => {
            tab.addEventListener("click", () => activate(tab));
            tab.addEventListener("keydown", (event) => {
              if (event.key !== "ArrowRight" && event.key !== "ArrowLeft") {
                return;
              }
              event.preventDefault();
              const direction = event.key === "ArrowRight" ? 1 : -1;
              const nextIndex = (index + direction + tabs.length) % tabs.length;
              tabs[nextIndex].focus();
              activate(tabs[nextIndex]);
            });
          });

          const defaultTab =
            tabs.find((tab) => tab.getAttribute("aria-selected") === "true") || tabs[0];
          activate(defaultTab);
        };

        const setupChains = () => {
          const chainCards = document.querySelectorAll("[data-chain-card]");
          chainCards.forEach((card) => {
            const nodes = Array.from(card.querySelectorAll(".chain-node"));
            const panels = Array.from(card.querySelectorAll(".subchain"));
            if (!nodes.length || !panels.length) return;

            const closeAll = () => {
              nodes.forEach((node) => node.setAttribute("aria-expanded", "false"));
              panels.forEach((panel) => panel.classList.remove("is-open"));
            };

            const openNode = (node) => {
              const panelId = node.getAttribute("aria-controls");
              const panel = panelId ? card.querySelector(`#${panelId}`) : null;
              if (!panel) return;
              node.setAttribute("aria-expanded", "true");
              panel.classList.add("is-open");
            };

            nodes.forEach((node) => {
              node.addEventListener("click", () => {
                const isOpen = node.getAttribute("aria-expanded") === "true";
                closeAll();
                if (!isOpen) {
                  openNode(node);
                }
              });
            });

            const defaultNode =
              nodes.find((node) => node.getAttribute("aria-expanded") === "true") || nodes[0];
            closeAll();
            if (defaultNode) {
              openNode(defaultNode);
            }
          });
        };

        const normalizeSeed = (seed) => {
          if (!seed) return "";
          return seed.toUpperCase().replace(/[^A-Z0-9-]/g, "").slice(0, 20);
        };

        const userStore = {
          sessionKey: 'ps-session',
          usersKey: 'ps-users',
          getUsers() {
            try {
              const raw = localStorage.getItem(this.usersKey);
              const list = raw ? JSON.parse(raw) : [];
              return Array.isArray(list) ? list : [];
            } catch {
              return [];
            }
          },
          saveUsers(users) {
            localStorage.setItem(this.usersKey, JSON.stringify(users));
          },
          getSession() {
            try {
              const raw = localStorage.getItem(this.sessionKey);
              return raw ? JSON.parse(raw) : null;
            } catch {
              return null;
            }
          },
          saveSession(session) {
            localStorage.setItem(this.sessionKey, JSON.stringify(session));
          },
          clearSession() {
            localStorage.removeItem(this.sessionKey);
          }
        };

        const isCryptoAvailable = () => typeof crypto !== "undefined" && !!crypto.subtle?.digest;

        const hashSeed = (seed) => {
          let hash = 2166136261;
          for (let i = 0; i < seed.length; i += 1) {
            hash ^= seed.charCodeAt(i);
            hash = Math.imul(hash, 16777619);
          }
          return hash >>> 0;
        };

        const hashPasscode = async (passcode) => {
          const encoder = new TextEncoder();
          const data = encoder.encode(passcode);
          const hashBuffer = await crypto.subtle.digest("SHA-256", data);
          return toHex(hashBuffer);
        };

        const mulberry32 = (seed) => () => {
          let t = (seed += 0x6d2b79f5);
          t = Math.imul(t ^ (t >>> 15), t | 1);
          t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
          return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
        };

        const toHex = (buffer) => {
          return Array.from(new Uint8Array(buffer))
            .map((b) => b.toString(16).padStart(2, "0"))
            .join("");
        };

        const randomSeed = () => {
          const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
          const digits = "0123456789";
          const pick = (pool) => pool[Math.floor(Math.random() * pool.length)];
          return `${pick(letters)}${pick(letters)}${pick(letters)}-${pick(digits)}${pick(
            letters
          )}${pick(digits)}`;
        };

        const generatePlanet = (seed, bias = "") => {
          const normalized = normalizeSeed(seed) || randomSeed();
          const rng = mulberry32(hashSeed(normalized));
          const pick = (items) => items[Math.floor(rng() * items.length)];
          const sizes = ["Zwerg", "Standard", "Gross", "Super"];
          const climates = ["Arid", "Temperiert", "Tropisch", "Polar", "Vulkanisch", "Stuermisch"];
          const hazards = [
            "Staubsturm",
            "Meteorschauer",
            "Magnetsturm",
            "Ascheregen",
            "Seismisch",
            "Irradiert",
          ];
          const resources = [
            "Erzreich",
            "Gasfelder",
            "Wasserreich",
            "Biomasse",
            "Metalle",
            "Kristalladern",
          ];

          let size = pick(sizes);
          let climate = pick(climates);
          let hazard = pick(hazards);
          let resource = pick(resources);
          let ocean = Math.round(rng() * 70 + 10);
          let gravity = (0.6 + rng() * 0.8).toFixed(1);
          let sectors = Math.round(rng() * 12 + 8);

          switch (bias) {
            case "ocean-high":
              ocean = Math.round(rng() * 25 + 70);
              break;
            case "ocean-low":
              ocean = Math.round(rng() * 15 + 5);
              break;
            case "ice":
              climate = "Polar";
              hazard = "Eissturm";
              break;
            case "ember":
              climate = "Vulkanisch";
              hazard = "Ascheregen";
              break;
            case "lush":
              climate = "Tropisch";
              resource = "Biomasse";
              ocean = Math.round(rng() * 30 + 40);
              break;
            case "metal":
              resource = "Erzreich";
              break;
            default:
              break;
          }

          return {
            seed: normalized,
            size,
            climate,
            ocean: `${ocean}%`,
            gravity: `${gravity} g`,
            hazard,
            resources: resource,
            sectors: `${sectors}`,
          };
        };

        const authState = {
          user: null,
          failedAttempts: 0
        };

        const saveKeyForUser = (user, suffix) => `ps-${suffix}:${user || 'guest'}`;

        const clearUserData = (username) => {
          const keys = [];
          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.includes(`:${username || 'guest'}`)) {
              keys.push(key);
            }
          }
          keys.forEach((k) => localStorage.removeItem(k));
        };

        const updateAuthUI = () => {
          const label = document.getElementById('auth-user-label');
          const loginBtn = document.getElementById('auth-login');
          const logoutBtn = document.getElementById('auth-logout');
          const isGuest = authState.user === 'gast';
          if (label) label.textContent = authState.user ? `Angemeldet: ${authState.user}${isGuest ? ' (Gast)' : ''}` : 'Nicht angemeldet';
          if (loginBtn) loginBtn.style.display = authState.user ? 'none' : 'inline-flex';
          if (logoutBtn) logoutBtn.style.display = authState.user ? 'inline-flex' : 'none';
          const needsAuth = !authState.user;
          setButtonDisabled('save-game', needsAuth);
          setButtonDisabled('load-game', needsAuth);
        };

        const setButtonDisabled = (id, disabled) => {
          const el = document.getElementById(id);
          if (el) {
            el.disabled = !!disabled;
            el.style.opacity = disabled ? "0.6" : "1";
            el.style.pointerEvents = disabled ? "none" : "auto";
          }
        };

        // --- Seed -> UI (KPIs / Charts / Flows / Routes / Biome highlight) ---
        const deriveColonyFromPlanet = (planet) => {
          const rng = mulberry32(hashSeed(planet.seed));
          const oceanPct = parseInt(String(planet.ocean).replace("%", ""), 10) || 0;
          const basePop =
            planet.size === "Zwerg" ? 60000 : planet.size === "Standard" ? 128000 : planet.size === "Gross" ? 220000 : 380000;

          const climatePenalty =
            planet.climate === "Polar" ? 0.85 :
            planet.climate === "Vulkanisch" ? 0.9 :
            planet.climate === "Arid" ? 0.88 :
            planet.climate === "Stuermisch" ? 0.92 :
            planet.climate === "Tropisch" ? 0.98 :
            1.0;

          const pop = Math.round(basePop * climatePenalty * (0.85 + rng() * 0.4));

          const water = Math.round(Math.min(98, Math.max(15, oceanPct * 0.85 + rng() * 25)));
          const energy = Math.round(Math.min(98, Math.max(15, 45 + rng() * 55)));
          const emissions = Math.round(Math.min(85, Math.max(5, 12 + rng() * 55 + (planet.resources === "Erzreich" ? 8 : 0))));
          const supply = Math.round(Math.min(96, Math.max(35, 55 + rng() * 40 - (planet.hazard.includes("Sturm") ? 8 : 0))));
          const satisfaction = Math.round(Math.min(92, Math.max(30, 40 + supply * 0.45 - emissions * 0.15 + rng() * 12)));

          const stage =
            pop > 280000 ? "Ingenieure" :
            pop > 140000 ? "Kolonisten" :
            pop > 80000 ? "Pioniere" :
            "Siedler";

          const bottleneck =
            water < 35 ? "Wasser" :
            energy < 35 ? "Energie" :
            supply < 55 ? "Nahrung" :
            emissions > 60 ? "Emissionen" :
            "Keiner";

          const sectors = parseInt(planet.sectors, 10) || 12;
          const tradeVolume = Math.round(400 + rng() * 1200);

          return {
            population: pop,
            stage,
            supply,
            satisfaction,
            emissions,
            emissionsLimit: 60,
            energy,
            water,
            bottleneck,
            sectors,
            tradeVolume,
            rng,
          };
        };

        const formatNumberShort = (n) => {
          if (n >= 1000000) return `${(n / 1000000).toFixed(1).replace(".0", "")}M`;
          if (n >= 1000) return `${Math.round(n / 1000)}k`;
          return String(n);
        };

        const escapeHTML = (value) => {
          return String(value || "")
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#39;");
        };

        const setKpi = (key, { valueText, subText, percent }) => {
          const card = document.querySelector(`[data-kpi="${key}"]`);
          if (!card) return;
          const valueEl = card.querySelector(".kpi-value");
          const subEl = card.querySelector(".kpi-sub");
          if (valueEl) valueEl.textContent = valueText;
          if (subEl && subText != null) subEl.textContent = subText;
          if (typeof percent === "number") {
            card.style.setProperty("--value", `${Math.max(0, Math.min(100, percent))}%`);
          }
        };

        const setBiomeDominant = (planet) => {
          const oceanPct = parseInt(String(planet.ocean).replace("%", ""), 10) || 0;
          const dominant =
            oceanPct >= 70 ? "ocean" :
            planet.climate === "Polar" ? "tundra" :
            planet.climate === "Tropisch" ? "jungle" :
            planet.climate === "Vulkanisch" ? "volcanic" :
            planet.climate === "Arid" ? "desert" :
            "plains";

          document.querySelectorAll(".biome-card").forEach((card) => {
            card.classList.toggle("is-dominant", card.dataset.biome === dominant);
          });
        };

        const renderFlows = (colony) => {
          const container = document.querySelector("#flow .flow-container");
          if (!container) return;

          const productionStats = updateResourceFlows();

          const iceConsumed = productionStats.totalConsumed.ice || 0;
          const regolithConsumed = productionStats.totalConsumed.regolith || 0;
          const energyProduced = productionStats.totalProduced.energy || 0;
          const energyConsumed = productionStats.totalConsumed.energy || 0;
          const waterProduced = productionStats.totalProduced.water || 0;
          const waterConsumed = productionStats.totalConsumed.water || 0;
          const foodProduced = productionStats.totalProduced.food || 0;
          const metalProduced = productionStats.totalProduced.metal || 0;

          const ice = iceConsumed > 0 ? iceConsumed : Math.round(60 + colony.water * 1.2);
          const regolith = regolithConsumed > 0 ? regolithConsumed : Math.round(40 + colony.emissions * 0.9);
          const solar = energyProduced > 0 ? energyProduced : Math.round(220 + colony.energy * 4.5);

          const waterworks = waterProduced > 0 ? waterProduced : Math.round(ice * 0.8);
          const refinery = metalProduced > 0 ? metalProduced : Math.round(regolith * 0.7);
          const grid = energyProduced - energyConsumed;

          const drink = waterProduced - waterConsumed;
          const metal = metalProduced;
          const food = foodProduced > 0 ? foodProduced : Math.round(20 + colony.supply * 0.5);

          const hasShortage = (value) => value <= 0;
          const shortageClass = (value) => (hasShortage(value) ? ' style="color: var(--danger);"' : "");

          container.innerHTML = `
            <div class="flow-column">
              <div class="flow-node source" data-flow-index="0">Eisfelder<div class="flow-value"${shortageClass(ice)}>${ice}t/Tag</div></div>
              <div class="flow-node source" data-flow-index="1">Regolith<div class="flow-value"${shortageClass(regolith)}>${regolith}t/Tag</div></div>
              <div class="flow-node source" data-flow-index="2">Solarpark<div class="flow-value"${shortageClass(solar)}>${solar} MW</div></div>
            </div>
            <div class="flow-column">
              <div class="flow-node process" data-flow-index="0">Wasserwerk<div class="flow-value"${shortageClass(waterworks)}>${waterworks}t/Tag</div></div>
              <div class="flow-node process" data-flow-index="1">Raffinerie<div class="flow-value"${shortageClass(refinery)}>${refinery}t/Tag</div></div>
              <div class="flow-node process" data-flow-index="2">Energienetz<div class="flow-value"${shortageClass(grid)}>${grid} MW</div></div>
            </div>
            <div class="flow-column">
              <div class="flow-node output" data-flow-index="0">Trinkwasser<div class="flow-value"${shortageClass(drink)}>${drink}t/Tag</div></div>
              <div class="flow-node output" data-flow-index="1">Metallbarren<div class="flow-value"${shortageClass(metal)}>${metal}t/Tag</div></div>
              <div class="flow-node output" data-flow-index="2">Nahrung<div class="flow-value"${shortageClass(food)}>${food}t/Tag</div></div>
            </div>
            <div class="flow-column">
              <div class="flow-node consumer" data-flow-index="0">🏠 Wohngebiete<div class="flow-value">${formatNumberShort(colony.population)} Einwohner</div></div>
              <div class="flow-node consumer" data-flow-index="1">🏭 Industrie<div class="flow-value">${Math.max(8, Math.round(colony.emissions / 2))} Betriebe</div></div>
              <div class="flow-node consumer" data-flow-index="2">🚀 Raumhafen<div class="flow-value">Export: ${Math.round(colony.tradeVolume / 20)}t/Tag</div></div>
            </div>
          `;

          renderFlowPaths();
          setupFlowInteractivity();
        };

        const renderFlowPaths = () => {
          const diagram = document.querySelector("#flow .flow-diagram");
          const svg = document.getElementById("flow-svg");
          if (!diagram || !svg) return;

          const columns = Array.from(diagram.querySelectorAll(".flow-column"));
          if (columns.length < 2) return;

          const diagramRect = diagram.getBoundingClientRect();
          svg.setAttribute("width", diagramRect.width);
          svg.setAttribute("height", diagramRect.height);
          svg.setAttribute("viewBox", `0 0 ${diagramRect.width} ${diagramRect.height}`);
          svg.innerHTML = "";

          const columnNodes = columns.map((col) => Array.from(col.querySelectorAll(".flow-node")));
          const rowCount = Math.min(...columnNodes.map((nodes) => nodes.length));

          const anchor = (node, side) => {
            const rect = node.getBoundingClientRect();
            const x = side === "right" ? rect.right - diagramRect.left : rect.left - diagramRect.left;
            const y = rect.top - diagramRect.top + rect.height / 2;
            return { x, y };
          };

          for (let row = 0; row < rowCount; row += 1) {
            for (let col = 0; col < columns.length - 1; col += 1) {
              const startNode = columnNodes[col][row];
              const endNode = columnNodes[col + 1][row];
              if (!startNode || !endNode) continue;

              const start = anchor(startNode, "right");
              const end = anchor(endNode, "left");
              const midX = (start.x + end.x) / 2;

              const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
              path.setAttribute(
                "d",
                `M ${start.x} ${start.y} C ${midX} ${start.y}, ${midX} ${end.y}, ${end.x} ${end.y}`
              );
              path.classList.add("flow-path");
              path.dataset.flowIndex = String(row);
              svg.appendChild(path);
            }
          }
        };

        const ensureSeedRoutes = (planet, colony) => {
          if (routeState.routes.length > 0) return;
          const rng = colony.rng;
          const grav = parseFloat(String(planet.gravity).replace(" g", "")) || 1.0;
          const hazardSlow = planet.hazard.includes("Sturm") ? 1.15 : planet.hazard.includes("Magnet") ? 1.08 : 1.0;
          const base = 4 + Math.round(rng() * 5);
          const daysA = Math.round(base * grav * hazardSlow);
          const daysB = Math.round((base - 1) * grav * (0.95 + rng() * 0.12));
          const daysC = Math.round((base - 0) * grav * (0.9 + rng() * 0.2));

          const capA = Math.round(60 + colony.tradeVolume / 10);
          const capB = Math.round(40 + colony.tradeVolume / 14);
          const capC = Math.round(50 + colony.tradeVolume / 12);

          createRoute('Nordkuppe 07', 'Orbit-Hub A', { distance: daysA, capacity: capA, cargoType: 'metal', cargoAmount: capA });
          createRoute('Südgürtel 02', 'Raffinerie 4', { distance: daysB, capacity: capB, cargoType: 'regolith', cargoAmount: capB });
          createRoute('Ozeanring', 'Terra-Knoten', { distance: daysC, capacity: capC, cargoType: 'water', cargoAmount: capC });
        };

        const renderRoutes = (planet, colony) => {
          initRouteStateFromDOM();
          // Nur automatische Routen erstellen wenn Tutorial abgeschlossen
          if (tutorialCompleted) {
            // ensureSeedRoutes(planet, colony); // Entfernt - Routen müssen manuell erstellt werden
          }
          updateRouteUI();
        };

        const renderCharts = (colony) => {
          const charts = document.querySelectorAll("#stats .stat-chart");
          if (!charts.length) return;
          charts.forEach((chart) => {
            const title = chart.querySelector("h4")?.textContent || "";
            const bars = Array.from(chart.querySelectorAll(".chart-bar"));
            if (!bars.length) return;

            const rng = colony.rng;
            const values =
              title.includes("Bevölkerungs") ? bars.map((_, i) => Math.round(colony.population * (0.2 + (i + 1) / bars.length * 0.8) * (0.92 + rng() * 0.12))) :
              title.includes("CO₂") ? bars.map((_, i) => Math.round(colony.emissions * (0.5 + (i + 1) / bars.length * 0.6) * (0.92 + rng() * 0.12))) :
              title.includes("Handels") ? bars.map((_, i) => Math.round(colony.tradeVolume * (0.35 + (i + 1) / bars.length * 0.8) * (0.9 + rng() * 0.15))) :
              bars.map((_, i) => Math.round(colony.satisfaction * (0.8 + rng() * 0.3)));

            const max = Math.max(...values, 1);
            bars.forEach((bar, i) => {
              const pct = Math.round((values[i] / max) * 100);
              bar.style.height = `${Math.max(6, Math.min(100, pct))}%`;
              if (title.includes("Bevölkerungs")) bar.dataset.value = `${formatNumberShort(values[i])}`;
              else if (title.includes("Handels")) bar.dataset.value = `${formatNumberShort(values[i])}`;
              else bar.dataset.value = `${values[i]}${title.includes("CO₂") || title.includes("Zufrieden") ? "%" : ""}`;
            });
          });
        };

        const collectBuildings = () => {
          const buildGrid = document.getElementById("build-grid");
          if (!buildGrid) return [];
          return Array.from(buildGrid.querySelectorAll(".build-cell[data-building]")).map((cell) => ({
            building: cell.dataset.building
          }));
        };

        const updateKpisFromColony = (colony) => {
          setKpi("population", {
            valueText: `${formatNumberShort(colony.population)}`,
            subText: `Stufe: ${colony.stage}`,
            percent: Math.min(100, Math.round((colony.population / 380000) * 100)),
          });
          setKpi("supply", { valueText: `${colony.supply}%`, subText: `Engpass: ${colony.bottleneck}`, percent: colony.supply });
          setKpi("satisfaction", { valueText: `${colony.satisfaction}%`, subText: colony.satisfaction >= 60 ? "Wachstum möglich" : "Wachstum gebremst", percent: colony.satisfaction });
          setKpi("emissions", { valueText: `${colony.emissions}%`, subText: `Limit: ${colony.emissionsLimit}%`, percent: colony.emissions });
          setKpi("energy", { valueText: `${colony.energy}%`, subText: `Puffer: ${Math.max(1, Math.round(colony.energy / 25))} Tage`, percent: colony.energy });
          setKpi("water", { valueText: `${colony.water}%`, subText: colony.water > 60 ? "Reservoir stabil" : "Reservoir knapp", percent: colony.water });
        };

        const updateNotifications = (planet, colony) => {
          const badge = document.querySelector("#notification-toggle .badge");
          const headerBadge = document.querySelector("#notification-center .notification-badge");
          const list = document.querySelector("#notification-center .notification-list");
          if (!badge || !headerBadge || !list) return;

          const notifs = [];
          if (colony.supply < 45) notifs.push({ type: "warning", t: "Versorgung knapp", m: `Engpass: ${colony.bottleneck}.` });
          if (colony.water < 35) notifs.push({ type: "danger", t: "Wasserkrise", m: "Reservoir kritisch – importieren oder Wasserwerke ausbauen." });
          if (colony.energy < 25) notifs.push({ type: "warning", t: "Energieengpass", m: "Energieproduktion ausbauen oder Speicher prüfen." });
          if (colony.emissions > colony.emissionsLimit) notifs.push({ type: "danger", t: "Emissionslimit überschritten", m: `CO₂ bei ${colony.emissions}% (Limit ${colony.emissionsLimit}%).` });
          if (colony.satisfaction > 75) notifs.push({ type: "success", t: "Gute Stimmung", m: `Zufriedenheit ${colony.satisfaction}%.` });

          const count = Math.min(9, notifs.length);
          badge.textContent = String(count);
          headerBadge.textContent = `${count} neu`;

          list.innerHTML = notifs
            .map((n) => {
              return `
                <div class="notification-item ${n.type}">
                  <strong>${n.t}</strong>
                  <p>${n.m}</p>
                  <time>Seed: ${planet.seed}</time>
                </div>
              `;
            })
            .join("") || `
              <div class="notification-item success">
                <strong>Alles stabil</strong>
                <p>Keine kritischen Meldungen.</p>
                <time>Seed: ${planet.seed}</time>
              </div>
            `;
        };

        const refreshColonyUI = (planetOverride = null) => {
          const seedInput = document.getElementById("seed-input");
          const planet = planetOverride || generatePlanet(seedInput?.value || "DEFAULT");
          const colony = calculateColonyKPIs(planet, collectBuildings());

          updateKpisFromColony(colony);
          renderPixelPlanet(planet.seed);
          setBiomeDominant(planet);
          renderFlows(colony);
          renderRoutes(planet, colony);
          updateNotifications(planet, colony);
          updateResourcePanel();
          updateEffectsPanel();
        };

        const applyPlanetToUI = (planet) => {
          refreshColonyUI(planet);
        };

        const copyToClipboard = (text) => {
          if (navigator.clipboard && window.isSecureContext) {
            return navigator.clipboard.writeText(text);
          }
          return new Promise((resolve, reject) => {
            const textarea = document.createElement("textarea");
            textarea.value = text;
            textarea.setAttribute("readonly", "");
            textarea.style.position = "fixed";
            textarea.style.top = "-1000px";
            textarea.style.opacity = "0";
            document.body.appendChild(textarea);
            textarea.select();
            try {
              const success = document.execCommand("copy");
              document.body.removeChild(textarea);
              if (success) {
                resolve();
              } else {
                reject(new Error("copy failed"));
              }
            } catch (error) {
              document.body.removeChild(textarea);
              reject(error);
            }
          });
        };

        const setupSeeds = () => {
          const seedInput = document.getElementById("seed-input");
          const seedApply = document.getElementById("seed-apply");
          const seedRandom = document.getElementById("seed-random");
          const seedCopy = document.getElementById("seed-copy");
          const seedSave = document.getElementById("seed-save");
          const seedClear = document.getElementById("seed-clear");
          const seedFeedback = document.getElementById("seed-feedback");
          const seedOutputs = Array.from(document.querySelectorAll("[data-seed-out]"));
          const archiveContainer = document.getElementById("seed-archive");
          const archiveEmpty = document.getElementById("seed-archive-empty");

          const storageKey = () => saveKeyForUser(authState.user, "seed-archive");
          const maxArchive = 12;
          const storageAvailable = (() => {
            try {
              const testKey = "__seed_test__";
              localStorage.setItem(testKey, testKey);
              localStorage.removeItem(testKey);
              return true;
            } catch (error) {
              return false;
            }
          })();

            const loadArchive = () => {
              if (!storageAvailable) return [];
              try {
                const raw = localStorage.getItem(storageKey());
                const data = raw ? JSON.parse(raw) : [];
                return Array.isArray(data) ? data : [];
              } catch (error) {
                return [];
              }
          };

            const saveArchive = (items) => {
              if (!storageAvailable) return;
              localStorage.setItem(storageKey(), JSON.stringify(items));
            };

          const sortArchive = (items) =>
            items
              .slice()
              .sort((a, b) => {
                if (a.favorite !== b.favorite) {
                  return a.favorite ? -1 : 1;
                }
                return (b.lastUsed || 0) - (a.lastUsed || 0);
              })
              .slice(0, maxArchive);

          const upsertSeed = (seed) => {
            if (!storageAvailable) return [];
            const normalized = normalizeSeed(seed);
            if (!normalized) return [];
            const items = loadArchive();
            const existing = items.find((item) => item.seed === normalized);
            if (existing) {
              existing.lastUsed = Date.now();
            } else {
              items.push({ seed: normalized, favorite: false, lastUsed: Date.now() });
            }
            const sorted = sortArchive(items);
            saveArchive(sorted);
            return sorted;
          };

          const removeSeed = (seed) => {
            if (!storageAvailable) return [];
            const normalized = normalizeSeed(seed);
            const items = loadArchive().filter((item) => item.seed !== normalized);
            const sorted = sortArchive(items);
            saveArchive(sorted);
            return sorted;
          };

          const toggleFavorite = (seed) => {
            if (!storageAvailable) return [];
            const normalized = normalizeSeed(seed);
            const items = loadArchive();
            const entry = items.find((item) => item.seed === normalized);
            if (entry) {
              entry.favorite = !entry.favorite;
              entry.lastUsed = Date.now();
            }
            const sorted = sortArchive(items);
            saveArchive(sorted);
            return sorted;
          };

          const setFeedback = (message) => {
            if (seedFeedback) {
              seedFeedback.textContent = message;
            }
          };

          const updateUrl = (seed) => {
            if (!seed) return;
            const url = new URL(window.location.href);
            url.searchParams.set("seed", seed);
            window.history.replaceState(null, "", url.toString());
          };

          const buildShareUrl = (seed) => {
            const url = new URL(window.location.href);
            url.searchParams.set("seed", seed);
            return url.toString();
          };

          const renderSeed = (seed) => {
            const data = generatePlanet(seed);
            if (seedInput) {
              seedInput.value = data.seed;
            }
            seedOutputs.forEach((el) => {
              const key = el.dataset.seedOut;
              el.textContent = key && data[key] ? data[key] : "";
            });
            return data;
          };

          const renderArchive = () => {
            if (!archiveContainer || !archiveEmpty) return;
            if (!storageAvailable) {
              archiveEmpty.textContent = "Archiv nicht verfuegbar.";
              archiveEmpty.hidden = false;
              return;
            }
            const items = sortArchive(loadArchive());
            archiveContainer.innerHTML = "";
            if (!items.length) {
              archiveEmpty.hidden = false;
              return;
            }
            archiveEmpty.hidden = true;
            items.forEach((entry) => {
              const data = generatePlanet(entry.seed);
              const item = document.createElement("div");
              item.className = `archive-item${entry.favorite ? " is-favorite" : ""}`;
              item.dataset.archiveSeed = entry.seed;

              const info = document.createElement("div");
              const seedLabel = document.createElement("div");
              seedLabel.className = "archive-seed";
              seedLabel.textContent = entry.seed;
              const badge = document.createElement("div");
              badge.className = "archive-badge";
              badge.textContent = entry.favorite ? "Favorit" : "Archiv";
              const meta = document.createElement("div");
              meta.className = "archive-meta";
              meta.textContent = `Klima: ${data.climate} | Ozean: ${data.ocean} | Ressourcen: ${data.resources}`;
              info.append(seedLabel, badge, meta);

              const actions = document.createElement("div");
              actions.className = "archive-actions";
              const loadButton = document.createElement("button");
              loadButton.type = "button";
              loadButton.className = "seed-button secondary";
              loadButton.dataset.archiveAction = "load";
              loadButton.textContent = "Laden";
              const favoriteButton = document.createElement("button");
              favoriteButton.type = "button";
              favoriteButton.className = "seed-button secondary favorite-toggle";
              favoriteButton.dataset.archiveAction = "favorite";
              if (entry.favorite) {
                favoriteButton.classList.add("is-favorite");
                favoriteButton.textContent = "Favorit";
              } else {
                favoriteButton.textContent = "Fav";
              }
              const removeButton = document.createElement("button");
              removeButton.type = "button";
              removeButton.className = "seed-button secondary";
              removeButton.dataset.archiveAction = "remove";
              removeButton.textContent = "Entfernen";
              actions.append(loadButton, favoriteButton, removeButton);

              item.append(info, actions);
              archiveContainer.appendChild(item);
            });
          };

          const applySeed = (seed, options = {}) => {
            const { save = true, feedback = "" } = options;
            const data = renderSeed(seed);
            updateUrl(data.seed);
            applyPlanetToUI(data);
            if (save) {
              upsertSeed(data.seed);
              renderArchive();
            }
            if (feedback) {
              setFeedback(feedback);
            }
            return data;
          };

          applySeedToUI = applySeed;

          if (seedInput && seedOutputs.length) {
            const urlSeed = new URLSearchParams(window.location.search).get("seed");
            const initialSeed = urlSeed || seedInput.value;
            setTimeout(() => applySeed(initialSeed, { save: false }), 0);
            if (seedApply) {
              seedApply.addEventListener("click", () =>
                applySeed(seedInput.value, { save: true, feedback: "Seed angewendet." })
              );
            }
            if (seedRandom) {
              seedRandom.addEventListener("click", () =>
                applySeed(randomSeed(), { save: true, feedback: "Neuer Seed gesetzt." })
              );
            }
            if (seedSave) {
              seedSave.addEventListener("click", () => {
                const data = renderSeed(seedInput.value);
                upsertSeed(data.seed);
                renderArchive();
                updateUrl(data.seed);
                setFeedback("Seed gespeichert.");
              });
            }
            if (seedCopy) {
              seedCopy.addEventListener("click", () => {
                const data = renderSeed(seedInput.value);
                const shareUrl = buildShareUrl(data.seed);
                copyToClipboard(shareUrl)
                  .then(() => setFeedback("Link kopiert."))
                  .catch(() => setFeedback("Kopieren fehlgeschlagen."));
              });
            }
            seedInput.addEventListener("keydown", (event) => {
              if (event.key === "Enter") {
                event.preventDefault();
                applySeed(seedInput.value, { save: true, feedback: "Seed angewendet." });
              }
            });
          }

          if (seedClear) {
            seedClear.addEventListener("click", () => {
              saveArchive([]);
              renderArchive();
              setFeedback("Archiv geleert.");
            });
          }

          if (archiveContainer) {
            archiveContainer.addEventListener("click", (event) => {
              const button = event.target.closest("button[data-archive-action]");
              if (!button) return;
              const item = button.closest("[data-archive-seed]");
              if (!item) return;
              const seed = item.dataset.archiveSeed || "";
              const action = button.dataset.archiveAction;
              if (action === "load") {
                applySeed(seed, { save: true, feedback: "Seed geladen." });
              }
              if (action === "favorite") {
                toggleFavorite(seed);
                renderArchive();
              }
              if (action === "remove") {
                removeSeed(seed);
                renderArchive();
              }
            });
          }

          const planetCards = Array.from(document.querySelectorAll("[data-seed]"));
          planetCards.forEach((card) => {
            const seed = card.dataset.seed || randomSeed();
            const bias = card.dataset.seedBias || "";
            const data = generatePlanet(seed, bias);
            const seedValue = card.querySelector("[data-seed-value]");
            if (seedValue) {
              seedValue.textContent = data.seed;
            }
            card.querySelectorAll("[data-seed-field]").forEach((el) => {
              const key = el.dataset.seedField;
              el.textContent = key && data[key] ? data[key] : "";
            });
          });

          const loadButtons = Array.from(document.querySelectorAll("[data-seed-load]"));
          loadButtons.forEach((button) => {
            button.addEventListener("click", () => {
              const card = button.closest("[data-seed]");
              if (!card) return;
              const seed = card.dataset.seed || "";
              if (!seed) return;
              applySeed(seed, { save: true, feedback: "Seed geladen." });
            });
          });

          renderArchive();
        };

        setupTabs();
        setupChains();
        setupSeeds();

        let themeToggle = null;
        const applyTheme = (mode, persist = true) => {
          const isDark = mode === 'dark';
          if (isDark) {
            document.documentElement.setAttribute('data-theme', 'dark');
          } else {
            document.documentElement.removeAttribute('data-theme');
          }
          if (persist) {
            localStorage.setItem('planetTheme', isDark ? 'dark' : 'light');
          }
          if (themeToggle) {
            themeToggle.innerHTML = isDark
              ? '<svg viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg><span>Theme</span>'
              : '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg><span>Theme</span>';
          }
        };

        // Theme Toggle
        const setupTheme = () => {
          themeToggle = document.getElementById('theme-toggle');
          if (!themeToggle) return;
          
          const savedTheme = localStorage.getItem('planetTheme') || 'light';
          applyTheme(savedTheme, false);
          
          themeToggle.addEventListener('click', () => {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            applyTheme(isDark ? 'light' : 'dark', true);
          });
        };

        // Notification Center
        const setupNotifications = () => {
          const toggle = document.getElementById('notification-toggle');
          const center = document.getElementById('notification-center');
          if (!toggle || !center) return;
          
          toggle.addEventListener('click', () => {
            center.classList.toggle('is-open');
          });
          
          document.addEventListener('click', (e) => {
            if (!center.contains(e.target) && !toggle.contains(e.target)) {
              center.classList.remove('is-open');
            }
          });
        };

        // Floating Navigation
        const setupTopbarNav = () => {
          const nav = document.getElementById('topbar-nav');
          if (!nav) return;
          
          const viewMap = {
            'hero': 'view-start',
            'status': 'view-start',
            'research': 'view-research',
            'chains': 'view-chains',
            'military': 'view-military',
            'diplomacy': 'view-diplomacy',
            'biomes': 'view-biomes',
            'achievements': 'view-achievements',
            'seeds': 'view-seeds'
          };
          
          const switchView = (viewId) => {
            // Verstecke alle Views
            document.querySelectorAll('.view-container').forEach(view => {
              view.classList.remove('active');
            });
            
            // Zeige gewählte View
            const targetView = document.getElementById(viewId);
            if (targetView) {
              targetView.classList.add('active');
              // Scroll zum Anfang der View
              window.scrollTo({ top: 0, behavior: 'smooth' });
            }
          };
          
          const buttons = nav.querySelectorAll('button');
          buttons.forEach(btn => {
            btn.addEventListener('click', () => {
              const sectionId = btn.dataset.section;
              
              // View-Switching
              if (sectionId && viewMap[sectionId]) {
                switchView(viewMap[sectionId]);
                buttons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
              } else if (btn.id === 'settings-toggle') {
                // Settings bleibt wie es war
                return;
              } else {
                // Fallback: Scroll zu Sektion
                const section = document.getElementById(sectionId) || 
                               document.querySelector(`.hero`);
                if (section) {
                  section.scrollIntoView({ behavior: 'smooth' });
                }
                buttons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
              }
            });
          });
          
          // Standard: Start-View anzeigen
          switchView('view-start');
        };

        // Glossary Modal
        const setupGlossary = () => {
          const openBtn = document.getElementById('glossary-open');
          const modal = document.getElementById('glossary-modal');
          const closeBtn = modal?.querySelector('.modal-close');
          const searchInput = document.getElementById('glossary-search');
          const list = document.getElementById('glossary-list');
          
          if (!openBtn || !modal) return;
          
          openBtn.addEventListener('click', () => {
            modal.classList.add('is-open');
          });
          
          closeBtn?.addEventListener('click', () => {
            modal.classList.remove('is-open');
          });
          
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              modal.classList.remove('is-open');
            }
          });
          
          if (searchInput && list) {
            searchInput.addEventListener('input', () => {
              const query = searchInput.value.toLowerCase();
              const items = list.querySelectorAll('.glossary-item');
              items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(query) ? 'block' : 'none';
              });
            });
          }
        };

        // Tutorial System
        const setupTutorial = () => {
          const startBtn = document.getElementById('tutorial-start');
          const overlay = document.getElementById('tutorial-overlay');
          const tooltip = document.getElementById('tutorial-tooltip');
          const highlight = document.getElementById('tutorial-highlight');
          const skipBtn = document.getElementById('tutorial-skip');
          const nextBtn = document.getElementById('tutorial-next');
          const progress = document.getElementById('tutorial-progress');
          
          if (!startBtn || !overlay) return;
          
          const steps = [
            { 
              selector: '.hero', 
              title: 'Willkommen zu Planet Sandbox!', 
              text: 'Du beginnst mit einer neuen Kolonie. Die Simulation ist pausiert - du hast Zeit, alles zu lernen. Klicke auf "Weiter" um zu beginnen.',
              action: null
            },
            { 
              selector: '#status', 
              title: 'Kolonie-Status überwachen', 
              text: 'Hier siehst du Bevölkerung, Versorgung, Zufriedenheit und Emissionen. Diese Werte ändern sich langsam - du musst aktiv handeln!',
              action: null
            },
            { 
              selector: '#research', 
              title: 'Forschung - Der Schlüssel zum Erfolg', 
              text: 'Forschung passiert NICHT automatisch! Du musst Technologien manuell auswählen und Forschungspunkte sammeln. Klicke auf eine verfügbare Technologie, um sie zu erforschen.',
              action: () => {
                const researchSection = document.querySelector('#research');
                if (researchSection) {
                  researchSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
              }
            },
            { 
              selector: '#flow', 
              title: 'Handelsrouten erstellen', 
              text: 'Handelsrouten werden NICHT automatisch erstellt! Du musst sie manuell im Handelsrouten-Panel erstellen. Ohne Routen gibt es keinen Handel.',
              action: null
            },
            { 
              selector: '.sim-controls', 
              title: 'Simulation steuern', 
              text: 'Die Simulation startet pausiert. Klicke auf "Weiter" um sie zu starten. Du kannst die Geschwindigkeit anpassen (1×, 4×, 10×) oder pausieren.',
              action: null
            },
            { 
              selector: null, 
              title: 'Tutorial abgeschlossen!', 
              text: 'Du bist bereit! Die Simulation startet jetzt. Denke daran: Forschung und Handelsrouten müssen manuell erstellt werden. Viel Erfolg!',
              action: () => {
                tutorialCompleted = true;
                localStorage.setItem('tutorialCompleted', 'true');
                simState.paused = false;
                const pauseBtn = document.getElementById('sim-pause');
                if (pauseBtn) {
                  pauseBtn.setAttribute("aria-pressed", "false");
                  pauseBtn.textContent = "Pause";
                }
                if (!simState.tickInterval) {
                  startSimulation();
                }
                toast({ type: 'success', title: 'Tutorial abgeschlossen!', message: 'Die Simulation startet jetzt. Viel Erfolg!' });
              }
            }
          ];
          
          let currentStep = 0;
          
          const showStep = (index) => {
            if (index >= steps.length) {
              overlay.classList.remove('is-active');
              if (!tutorialCompleted) {
                tutorialCompleted = true;
                localStorage.setItem('tutorialCompleted', 'true');
                simState.paused = false;
                const pauseBtn = document.getElementById('sim-pause');
                if (pauseBtn) {
                  pauseBtn.setAttribute("aria-pressed", "false");
                  pauseBtn.textContent = "Pause";
                }
                if (!simState.tickInterval) {
                  startSimulation();
                }
              }
              return;
            }
            
            const step = steps[index];
            
            document.getElementById('tutorial-title').textContent = step.title;
            document.getElementById('tutorial-text').textContent = step.text;
            
            const el = step.selector ? document.querySelector(step.selector) : null;
            
            if (el) {
              el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            if (el && highlight && tooltip) {
              const rect = el.getBoundingClientRect();
              highlight.style.top = `${rect.top - 6}px`;
              highlight.style.left = `${rect.left - 6}px`;
              highlight.style.width = `${rect.width + 12}px`;
              highlight.style.height = `${rect.height + 12}px`;

              const padding = 16;
              const tooltipWidth = tooltip.offsetWidth || 280;
              const tooltipHeight = tooltip.offsetHeight || 140;
              const top = Math.min(window.innerHeight - tooltipHeight - padding, rect.bottom + 12);
              const left = Math.min(window.innerWidth - tooltipWidth - padding, rect.left);
              tooltip.style.top = `${Math.max(padding, top)}px`;
              tooltip.style.left = `${Math.max(padding, left)}px`;
            } else if (highlight) {
              highlight.style.display = 'none';
            }
            
            // Update progress
            const dots = progress.querySelectorAll('span');
            dots.forEach((dot, i) => {
              dot.classList.toggle('active', i <= index);
            });
            
            nextBtn.textContent = index === steps.length - 1 ? 'Fertig ✓' : 'Weiter →';
            
            // Führe Action aus wenn vorhanden
            if (step.action) {
              setTimeout(() => step.action(), 300);
            }
          };
          
          // Auto-start Tutorial wenn nicht abgeschlossen
          if (!tutorialCompleted) {
            setTimeout(() => {
              currentStep = 0;
              overlay.classList.add('is-active');
              showStep(0);
            }, 1000);
          }
          
          startBtn.addEventListener('click', () => {
            currentStep = 0;
            overlay.classList.add('is-active');
            showStep(0);
          });
          
          skipBtn?.addEventListener('click', () => {
            overlay.classList.remove('is-active');
            if (!tutorialCompleted) {
              tutorialCompleted = true;
              localStorage.setItem('tutorialCompleted', 'true');
            }
          });
          
          nextBtn?.addEventListener('click', () => {
            currentStep++;
            showStep(currentStep);
          });
        };

        // Unified Build Editor (replaces both old functions)
        const buildingIcons = {
          home: '🏠',
          solar: '☀️',
          water: '💧',
          hydro: '🌱',
          refinery: '🏭',
          lab: '🔬',
          spaceport: '🚀',
          warehouse: '📦',
          'fusion-reactor': '⚛️',
          'orbital-shipyard': '🛰️',
          'dyson-mirror': '☀️',
          'geothermal-plant': '🌋',
          'deep-mine': '⛏️',
          'asteroid-miner': '☄️',
          'habitat-dome': '🏛️',
          'terraform-station': '🌍',
          'biosphere-lab': '🌏',
          'interplanetary-port': '🚀'
        };
        const buildingRadius = {
          home: 1,
          solar: 2,
          water: 3,
          hydro: 2,
          refinery: 1,
          lab: 2,
          spaceport: 4,
          warehouse: 1,
          barracks: 2,
          'fusion-reactor': 3,
          'orbital-shipyard': 3,
          'dyson-mirror': 4,
          'geothermal-plant': 3,
          'deep-mine': 2,
          'asteroid-miner': 4,
          'habitat-dome': 3,
          'terraform-station': 3,
          'biosphere-lab': 2,
          'interplanetary-port': 4
        };
        
        const renderBuildingIcon = (building) => {
          return `<span class="building-icon">${buildingIcons[building] || '🏗️'}</span>`;
        };
        
        const setupBuildEditor = () => {
          const grid = document.getElementById('build-grid');
          const palette = document.querySelector('.build-palette');
          
          if (!grid || !palette) return;

          refreshBuildPalette();
          
          // Generate grid cells if not already present
          if (grid.children.length === 0) {
            for (let i = 0; i < 96; i++) {
              const cell = document.createElement('div');
              cell.className = 'build-cell';
              cell.dataset.index = i;
              grid.appendChild(cell);
            }
          }
          
          let selectedTool = null;
          let deleteMode = false;
          const initialSelection = palette.querySelector('.build-item.selected[data-building]');
          if (initialSelection && !initialSelection.classList.contains('is-locked')) {
            selectedTool = initialSelection.dataset.building;
          }
          
          // Palette selection
          palette.querySelectorAll('.build-item').forEach(item => {
            const building = item.dataset.building;
            const action = item.dataset.action;
            
            item.addEventListener('click', () => {
              if (item.classList.contains('is-locked')) {
                toast({ type: 'warning', title: 'Gesperrt', message: 'Forschung erforderlich.' });
                return;
              }
              palette.querySelectorAll('.build-item').forEach(i => {
                i.classList.remove('selected', 'is-selected');
              });
              item.classList.add('selected', 'is-selected');
              
              if (action === 'delete') {
                deleteMode = true;
                selectedTool = null;
              } else if (building) {
                deleteMode = false;
                selectedTool = building;
              }
            });
          });
          
          // Grid click handler
          grid.addEventListener('click', (e) => {
            const cell = e.target.closest('.build-cell');
            if (!cell) return;
            
            // Clear previous radius
            grid.querySelectorAll('.radius').forEach(c => c.classList.remove('radius'));
            
            if (deleteMode && cell.dataset.building) {
              // Delete building
              delete cell.dataset.building;
              cell.classList.remove('occupied');
              cell.innerHTML = '';
              updateStorageCapacity();
              updateResourcePanel();
              refreshColonyUI();
              toast({ type: 'info', title: 'Gebäude entfernt', message: '' });
            } else if (selectedTool && !cell.dataset.building) {
              if (!isBuildingUnlocked(selectedTool)) {
                toast({ type: 'warning', title: 'Gesperrt', message: 'Forschung erforderlich.' });
                return;
              }
              if (!canAffordBuilding(selectedTool)) {
                toast({ type: 'warning', title: 'Nicht genug Ressourcen', message: 'Metall fehlt.' });
                return;
              }
              // Place building
              payBuildingCost(selectedTool);
              cell.dataset.building = selectedTool;
              cell.classList.add('occupied');
              cell.innerHTML = renderBuildingIcon(selectedTool);
              
              // Show radius
              const index = parseInt(cell.dataset.index);
              const row = Math.floor(index / 12);
              const col = index % 12;
              const radius = buildingRadius[selectedTool] || 1;
              
              for (let r = -radius; r <= radius; r++) {
                for (let c = -radius; c <= radius; c++) {
                  const newRow = row + r;
                  const newCol = col + c;
                  if (newRow >= 0 && newRow < 8 && newCol >= 0 && newCol < 12) {
                    const newIndex = newRow * 12 + newCol;
                    const targetCell = grid.querySelector(`[data-index="${newIndex}"]`);
                    if (targetCell && !targetCell.classList.contains('occupied')) {
                      targetCell.classList.add('radius');
                    }
                  }
                }
              }
              updateStorageCapacity();
              updateResourcePanel();
              refreshColonyUI();
            } else if (!selectedTool && !deleteMode && cell.classList.contains('occupied')) {
              // Click on occupied cell without tool selected: clear radius only
            }
          });
        };

        // Catastrophe Simulator
        const setupCatastrophe = () => {
          const types = document.querySelectorAll('.catastrophe-type');
          const startButton = document.querySelector('.catastrophe-preview .seed-button');
          
          types.forEach(type => {
            type.addEventListener('click', () => {
              types.forEach(t => t.classList.remove('selected'));
              type.classList.add('selected');
              
              // Finde Katastrophen-Typ
              const title = type.querySelector('h4')?.textContent || '';
              let catType = null;
              if (title.includes('Meteorit')) catType = 'meteor';
              else if (title.includes('Supervulkan')) catType = 'volcano';
              else if (title.includes('Megasturm')) catType = 'storm';
              else if (title.includes('Sonneneruption')) catType = 'solar';
              
              if (catType) {
                simulateCatastrophe(catType);
              }
            });
          });
          
          // Start-Button funktional machen
          if (startButton) {
            startButton.addEventListener('click', () => {
              const selected = document.querySelector('.catastrophe-type.selected');
              if (!selected) {
                toast({ type: 'warning', title: 'Keine Katastrophe ausgewählt', message: 'Bitte wähle zuerst eine Katastrophe aus.' });
                return;
              }
              
              const title = selected.querySelector('h4')?.textContent || '';
              let catType = null;
              if (title.includes('Meteorit')) catType = 'meteor';
              else if (title.includes('Supervulkan')) catType = 'volcano';
              else if (title.includes('Megasturm')) catType = 'storm';
              else if (title.includes('Sonneneruption')) catType = 'solar';
              
              if (catType) {
                triggerCatastrophe(catType);
              }
            });
          }
        };

        // ===== PHASE 1: INTERAKTIVE AKTIONEN =====
        
        // 1. KPI-Karten interaktiv machen
        const setupKPIActions = () => {
          const kpiCards = document.querySelectorAll('[data-kpi]');
          const modal = document.getElementById('kpi-detail-modal');
          const closeBtn = document.getElementById('kpi-detail-close');
          const titleEl = document.getElementById('kpi-detail-title');
          const contentEl = document.getElementById('kpi-detail-content');
          
          if (!modal || !titleEl || !contentEl) return;
          
          const kpiDetails = {
            population: {
              title: '👥 Bevölkerung',
              getData: () => {
                const planet = generatePlanet(document.getElementById('seed-input')?.value || 'DEFAULT');
                const colony = calculateColonyKPIs(planet, collectBuildings());
                const buildings = collectBuildings();
                const homes = buildings.filter(b => b.building === 'home').length;
                return {
                  aktuell: `${(colony.population / 1000).toFixed(0)}k`,
                  stufe: colony.stage,
                  wachstum: `${((colony.population / 100000) * 0.1).toFixed(1)}% pro Tag`,
                  wohnungen: homes,
                  kapazität: `${(homes * 500).toFixed(0)}`,
                  sektoren: colony.sectors,
                  optimierung: colony.bottleneck === 'Nahrung' ? 'Mehr Hydroponik bauen' : 
                              colony.bottleneck === 'Wasser' ? 'Wasserwerke erweitern' : 
                              'Stabil'
                };
              }
            },
            supply: {
              title: '📦 Versorgung',
              getData: () => {
                const planet = generatePlanet(document.getElementById('seed-input')?.value || 'DEFAULT');
                const colony = calculateColonyKPIs(planet, collectBuildings());
                return {
                  aktuell: `${colony.supply}%`,
                  engpass: colony.bottleneck,
                  produktion: 'Berechnet aus Gebäuden',
                  verbrauch: 'Berechnet aus Bevölkerung',
                  optimierung: colony.bottleneck !== 'Keiner' ? `Mehr ${colony.bottleneck} produzieren` : 'Optimal'
                };
              }
            },
            satisfaction: {
              title: '😊 Zufriedenheit',
              getData: () => {
                const planet = generatePlanet(document.getElementById('seed-input')?.value || 'DEFAULT');
                const colony = calculateColonyKPIs(planet, collectBuildings());
                return {
                  aktuell: `${colony.satisfaction}%`,
                  faktoren: `Versorgung: ${colony.supply}%, Emissionen: ${colony.emissions}%`,
                  steuern: 'Stabil',
                  optimierung: colony.satisfaction < 60 ? 'Versorgung erhöhen, Emissionen senken' : 'Gut'
                };
              }
            },
            emissions: {
              title: '💨 Emissionen',
              getData: () => {
                const planet = generatePlanet(document.getElementById('seed-input')?.value || 'DEFAULT');
                const colony = calculateColonyKPIs(planet, collectBuildings());
                return {
                  aktuell: `${colony.emissions}%`,
                  limit: `${colony.emissionsLimit}%`,
                  status: colony.emissions > colony.emissionsLimit * 0.8 ? 'Kritisch' : 'OK',
                  optimierung: colony.emissions > 50 ? 'Mehr erneuerbare Energie, Recycling' : 'Gut'
                };
              }
            },
            energy: {
              title: '⚡ Energie',
              getData: () => {
                const planet = generatePlanet(document.getElementById('seed-input')?.value || 'DEFAULT');
                const colony = calculateColonyKPIs(planet, collectBuildings());
                return {
                  aktuell: `${colony.energy}%`,
                  puffer: '2 Tage',
                  produktion: 'Solar + Fusion',
                  optimierung: colony.energy < 50 ? 'Mehr Solarkraftwerke bauen' : 'Ausreichend'
                };
              }
            },
            water: {
              title: '💧 Wasser',
              getData: () => {
                const planet = generatePlanet(document.getElementById('seed-input')?.value || 'DEFAULT');
                const colony = calculateColonyKPIs(planet, collectBuildings());
                return {
                  aktuell: `${colony.water}%`,
                  status: colony.water > 70 ? 'Stabil' : 'Knapp',
                  produktion: 'Wasserwerke',
                  optimierung: colony.water < 50 ? 'Mehr Wasserwerke bauen' : 'Gut'
                };
              }
            }
          };
          
          const showKPIDetails = (kpiType) => {
            const detail = kpiDetails[kpiType];
            if (!detail) return;
            
            const data = detail.getData();
            titleEl.textContent = detail.title;
            
            contentEl.innerHTML = Object.entries(data).map(([key, value]) => {
              const label = key === 'aktuell' ? 'Aktueller Wert' :
                           key === 'stufe' ? 'Bevölkerungsstufe' :
                           key === 'wachstum' ? 'Wachstumsrate' :
                           key === 'wohnungen' ? 'Wohnungen' :
                           key === 'kapazität' ? 'Kapazität' :
                           key === 'sektoren' ? 'Sektoren' :
                           key === 'engpass' ? 'Engpass' :
                           key === 'produktion' ? 'Produktion' :
                           key === 'verbrauch' ? 'Verbrauch' :
                           key === 'faktoren' ? 'Einflussfaktoren' :
                           key === 'steuern' ? 'Steuern' :
                           key === 'limit' ? 'Limit' :
                           key === 'status' ? 'Status' :
                           key === 'puffer' ? 'Puffer' :
                           key === 'optimierung' ? 'Optimierung' : key;
              
              return `
                <div class="kpi-detail-row">
                  <span class="kpi-detail-label">${label}</span>
                  <span class="kpi-detail-value">${value}</span>
                </div>
              `;
            }).join('');
            
            modal.classList.add('is-open');
          };
          
          kpiCards.forEach(card => {
            card.addEventListener('click', () => {
              const kpiType = card.dataset.kpi;
              if (kpiType) {
                showKPIDetails(kpiType);
              }
            });
          });
          
          closeBtn?.addEventListener('click', () => {
            modal.classList.remove('is-open');
          });
          
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              modal.classList.remove('is-open');
            }
          });
        };
        
        // 2. Schnellaktionen
        const setupQuickActions = () => {
          const buildBtn = document.getElementById('quick-build');
          const researchBtn = document.getElementById('quick-research');
          const routesBtn = document.getElementById('quick-routes');
          const eventsBtn = document.getElementById('quick-events');
          
          buildBtn?.addEventListener('click', () => {
            const buildSection = document.getElementById('build-editor');
            if (buildSection) {
              // Wechsle zu Chains-View und scroll zu Build-Editor
              const nav = document.getElementById('floating-nav');
              const chainsBtn = nav?.querySelector('[data-section="chains"]');
              if (chainsBtn) chainsBtn.click();
              setTimeout(() => {
                buildSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
              }, 300);
            }
          });
          
          researchBtn?.addEventListener('click', () => {
            const nav = document.getElementById('floating-nav');
            const researchBtn = nav?.querySelector('[data-section="research"]');
            if (researchBtn) researchBtn.click();
          });
          
          routesBtn?.addEventListener('click', () => {
            const nav = document.getElementById('floating-nav');
            const chainsBtn = nav?.querySelector('[data-section="chains"]');
            if (chainsBtn) chainsBtn.click();
            setTimeout(() => {
              const routeSection = document.querySelector('#panel-handel');
              if (routeSection) {
                routeSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
              }
            }, 300);
          });
          
          eventsBtn?.addEventListener('click', () => {
            if (pendingEvent) {
              showEventOverlay(pendingEvent);
            } else {
              toast({ type: 'info', title: 'Keine Events', message: 'Aktuell gibt es keine aktiven Events.' });
            }
          });
        };
        
        // 3. Diplomatie-Buttons
        const setupDiplomacyActions = () => {
          const factionCards = document.querySelectorAll('.faction-card');
          
          factionCards.forEach(card => {
            const giftBtn = card.querySelector('[data-action="gift"]');
            const tradeBtn = card.querySelector('[data-action="trade"]');
            const treatyBtn = card.querySelector('[data-action="treaty"]');
            const faction = card.dataset.faction;
            
            giftBtn?.addEventListener('click', () => {
              showDiplomacyDialog('gift', faction);
            });
            
            tradeBtn?.addEventListener('click', () => {
              showDiplomacyDialog('trade', faction);
            });
            
            treatyBtn?.addEventListener('click', () => {
              showDiplomacyDialog('treaty', faction);
            });
          });
        };
        
        const showDiplomacyDialog = (action, faction) => {
          const factionNames = {
            tech: 'Technokraten-Union',
            eco: 'Öko-Allianz',
            militant: 'Frontier-Miliz'
          };
          
          const factionName = factionNames[faction] || faction;
          
          if (action === 'gift') {
            const resources = ['metal', 'water', 'food', 'energy'];
            const resourceNames = {
              metal: 'Metall',
              water: 'Wasser',
              food: 'Nahrung',
              energy: 'Energie'
            };
            
            const resource = resources[Math.floor(Math.random() * resources.length)];
            const amount = Math.floor(Math.random() * 100 + 50);
            const cost = amount * 2;
            
            if (confirm(`Geschenk an ${factionName} senden?\n\n${amount} ${resourceNames[resource]}\nKosten: ${cost} Einfluss\n\nBeziehung: +10`)) {
              if (getResource(resource) >= amount) {
                consumeResource(resource, amount);
                if (factionState[faction]) {
                  factionState[faction].relation = Math.min(100, (factionState[faction].relation || 0) + 10);
                }
                toast({ type: 'success', title: 'Geschenk gesendet', message: `${factionName} freut sich über das Geschenk!` });
                updateResourcePanel();
                refreshColonyUI();
              } else {
                toast({ type: 'warning', title: 'Nicht genug Ressourcen', message: `Du hast nicht genug ${resourceNames[resource]}.` });
              }
            }
          } else if (action === 'trade') {
            toast({ type: 'info', title: 'Handel', message: `Handelsdialog mit ${factionName} öffnen (wird erweitert)` });
          } else if (action === 'treaty') {
            toast({ type: 'info', title: 'Vertrag', message: `Vertragsverhandlung mit ${factionName} (wird erweitert)` });
          }
        };
        
        // 4. Ressourcen-Karten interaktiv
        const setupResourceActions = () => {
          // Wird beim Rendern der Ressourcen-Karten aufgerufen
          // Siehe updateResourcePanel()
        };

        // ===== PHASE 2: KI-GEGNER & TERRITORIUM-SYSTEM =====
        
        // Territorium State
        const sectorOwnership = {}; // sectorId -> { owner: 'player'|'ai1'|'ai2'|'ai3'|'neutral', strength: number, buildings: [] }
        
        // KI-Gegner State
        const aiOpponents = [
          { 
            id: 'ai1', 
            name: 'Imperium Alpha', 
            color: '#ff4444', 
            sectors: [], 
            resources: { metal: 500, water: 300, food: 200, energy: 4000 },
            military: 100,
            relationship: 0,
            expansionRate: 0.1
          },
          { 
            id: 'ai2', 
            name: 'Kolonie Beta', 
            color: '#ff8844', 
            sectors: [], 
            resources: { metal: 400, water: 350, food: 250, energy: 3500 },
            military: 80,
            relationship: 0,
            expansionRate: 0.08
          },
          { 
            id: 'ai3', 
            name: 'Siedlung Gamma', 
            color: '#8844ff', 
            sectors: [], 
            resources: { metal: 450, water: 320, food: 220, energy: 3800 },
            military: 90,
            relationship: 0,
            expansionRate: 0.09
          }
        ];
        
        // Militär State
        const militaryState = {
          player: { strength: 0, units: [] },
          ai1: { strength: 100 },
          ai2: { strength: 80 },
          ai3: { strength: 90 }
        };
        
        // Territorium initialisieren
        const setupTerritorySystem = () => {
          const buildGrid = document.getElementById('build-grid');
          if (!buildGrid) return;
          
          const totalCells = 8 * 12; // 8 rows, 12 cols
          const totalSectors = 12; // Beispiel: 12 Sektoren
          
          // Initialisiere Sektoren: Spieler bekommt 2-3, KI bekommt je 1-2, Rest neutral
          const playerSectors = 3;
          const aiSectorsPerOpponent = 2;
          
          // Spieler-Sektoren
          for (let i = 0; i < playerSectors; i++) {
            const sectorId = `sector-${i}`;
            sectorOwnership[sectorId] = {
              owner: 'player',
              strength: 50,
              buildings: []
            };
          }
          
          // KI-Sektoren
          let sectorIndex = playerSectors;
          aiOpponents.forEach(ai => {
            for (let j = 0; j < aiSectorsPerOpponent; j++) {
              const sectorId = `sector-${sectorIndex}`;
              sectorOwnership[sectorId] = {
                owner: ai.id,
                strength: ai.military,
                buildings: []
              };
              ai.sectors.push(sectorId);
              sectorIndex++;
            }
          });
          
          // Rest ist neutral
          for (let i = sectorIndex; i < totalSectors; i++) {
            const sectorId = `sector-${i}`;
            sectorOwnership[sectorId] = {
              owner: 'neutral',
              strength: 0,
              buildings: []
            };
          }
          
          renderSectorOwnership();
        };
        
        // Sektoren auf Karte rendern
        const renderSectorOwnership = () => {
          // Planet-Canvas neu rendern mit Sektoren-Farben
          const seedInput = document.getElementById('seed-input');
          const seed = seedInput?.value || 'DEFAULT';
          renderPixelPlanet(seed);
          
          // Markiere Sektoren im Build-Grid
          const buildGrid = document.getElementById('build-grid');
          if (!buildGrid) return;
          
          const cells = buildGrid.querySelectorAll('.build-cell');
          cells.forEach((cell, index) => {
            const sectorId = `sector-${Math.floor(index / 10)}`; // Vereinfacht: 10 Zellen pro Sektor
            const ownership = sectorOwnership[sectorId];
            
            if (ownership) {
              cell.dataset.owner = ownership.owner;
              
              // Farbe basierend auf Besitzer
              if (ownership.owner === 'player') {
                cell.style.borderColor = '#4ade80';
                cell.style.borderWidth = '2px';
              } else if (ownership.owner === 'ai1') {
                cell.style.borderColor = '#ff4444';
                cell.style.borderWidth = '2px';
              } else if (ownership.owner === 'ai2') {
                cell.style.borderColor = '#ff8844';
                cell.style.borderWidth = '2px';
              } else if (ownership.owner === 'ai3') {
                cell.style.borderColor = '#8844ff';
                cell.style.borderWidth = '2px';
              } else {
                cell.style.borderColor = '#888';
                cell.style.borderWidth = '1px';
              }
              
              // Klick-Handler für fremde Sektoren
              if (ownership.owner !== 'player' && ownership.owner !== 'neutral') {
                cell.style.cursor = 'pointer';
                cell.title = `Sektor ${sectorId} - Besitzer: ${ownership.owner === 'ai1' ? 'Imperium Alpha' : ownership.owner === 'ai2' ? 'Kolonie Beta' : 'Siedlung Gamma'}\nKlicken zum Angreifen`;
                cell.onclick = (e) => {
                  e.stopPropagation();
                  const playerStrength = militaryState.player.strength || getResource('military') || 50;
                  const defenderStrength = ownership.strength;
                  const successChance = calculateCombat(playerStrength, defenderStrength, 1.2);
                  
                  if (confirm(`Sektor ${sectorId} angreifen?\n\nDeine Stärke: ${playerStrength}\nVerteidiger: ${defenderStrength}\nErfolgschance: ${Math.round(successChance * 100)}%`)) {
                    attackSector(sectorId);
                    updateMilitaryPanel();
                  }
                };
              } else {
                cell.style.cursor = 'default';
                cell.onclick = null;
              }
            }
          });
        };
        
        // KI-Gegner initialisieren
        const setupAIOpponents = () => {
          setupTerritorySystem();
          // KI startet mit Update-Loop
        };
        
        // KI-Verhalten ausführen
        const updateAIOpponents = () => {
          if (simState.paused) return;
          
          // Alle 10 Tage: KI-Aktionen
          if (simState.day % 10 === 0) {
            aiOpponents.forEach(ai => {
              // Expansion: Suche neutrale Sektoren
              const neutralSectors = Object.entries(sectorOwnership)
                .filter(([id, data]) => data.owner === 'neutral');
              
              if (neutralSectors.length > 0 && Math.random() < ai.expansionRate) {
                const target = neutralSectors[Math.floor(Math.random() * neutralSectors.length)];
                conquerSector(target[0], ai.id);
                toast({ type: 'info', title: 'KI-Expansion', message: `${ai.name} hat ${target[0]} erobert.` });
              }
              
              // Militär erhöhen
              ai.military += Math.floor(Math.random() * 5 + 1);
              militaryState[ai.id].strength = ai.military;
              
              // Ressourcen produzieren
              ai.resources.metal += Math.floor(Math.random() * 10 + 5);
              ai.resources.water += Math.floor(Math.random() * 8 + 3);
              ai.resources.food += Math.floor(Math.random() * 6 + 2);
            });
            
            renderSectorOwnership();
            checkVictoryCondition();
          }
        };
        
        // Sektor erobern
        const conquerSector = (sectorId, newOwner) => {
          if (!sectorOwnership[sectorId]) return;
          
          const oldOwner = sectorOwnership[sectorId].owner;
          sectorOwnership[sectorId].owner = newOwner;
          
          // Alten Besitzer aktualisieren
          if (oldOwner !== 'neutral' && oldOwner !== 'player') {
            const oldAI = aiOpponents.find(a => a.id === oldOwner);
            if (oldAI) {
              oldAI.sectors = oldAI.sectors.filter(s => s !== sectorId);
            }
          }
          
          // Neuen Besitzer aktualisieren
          if (newOwner !== 'neutral' && newOwner !== 'player') {
            const newAI = aiOpponents.find(a => a.id === newOwner);
            if (newAI && !newAI.sectors.includes(sectorId)) {
              newAI.sectors.push(sectorId);
            }
          }
          
          renderSectorOwnership();
        };
        
        // Kampf berechnen
        const calculateCombat = (attackerStrength, defenderStrength, defenderBonus = 1.0) => {
          const effectiveDefense = defenderStrength * defenderBonus;
          const ratio = attackerStrength / effectiveDefense;
          
          // Erfolgswahrscheinlichkeit basierend auf Stärke-Verhältnis
          if (ratio >= 2.0) return 0.95; // Sehr wahrscheinlich
          if (ratio >= 1.5) return 0.80;
          if (ratio >= 1.2) return 0.65;
          if (ratio >= 1.0) return 0.50;
          if (ratio >= 0.8) return 0.35;
          if (ratio >= 0.6) return 0.20;
          return 0.10; // Sehr unwahrscheinlich
        };
        
        // Sektor angreifen
        const attackSector = (targetSectorId) => {
          const ownership = sectorOwnership[targetSectorId];
          if (!ownership || ownership.owner === 'player' || ownership.owner === 'neutral') {
            return false;
          }
          
          const playerStrength = getResource('military') || militaryState.player.strength || 50;
          const defenderStrength = ownership.strength;
          const defenderBonus = 1.2; // Verteidigungs-Bonus
          
          const successChance = calculateCombat(playerStrength, defenderStrength, defenderBonus);
          const success = Math.random() < successChance;
          
          if (success) {
            conquerSector(targetSectorId, 'player');
            toast({ type: 'success', title: 'Sektor erobert!', message: `Du hast ${targetSectorId} erfolgreich erobert.` });
            
            // Beziehung zu KI verschlechtern
            const ai = aiOpponents.find(a => a.id === ownership.owner);
            if (ai) {
              ai.relationship = Math.max(-100, ai.relationship - 20);
            }
            
            // Militär-Verlust auch bei Erfolg
            const loss = Math.floor(defenderStrength * 0.1);
            const newStrength = Math.max(0, playerStrength - loss);
            resourceState.storage.military = newStrength;
            militaryState.player.strength = newStrength;
            updateResourcePanel();
            
            checkVictoryCondition();
            return true;
          } else {
            // Militär-Verlust bei Niederlage
            const loss = Math.floor(defenderStrength * 0.2);
            const newStrength = Math.max(0, playerStrength - loss);
            resourceState.storage.military = newStrength;
            militaryState.player.strength = newStrength;
            updateResourcePanel();
            toast({ type: 'warning', title: 'Angriff fehlgeschlagen', message: `Der Angriff auf ${targetSectorId} wurde abgewehrt. Militär-Verlust: ${loss}` });
            return false;
          }
        };
        
        // Sieg-Bedingung prüfen
        const checkVictoryCondition = () => {
          const totalSectors = Object.keys(sectorOwnership).length;
          const playerSectors = Object.values(sectorOwnership).filter(s => s.owner === 'player').length;
          const percentage = (playerSectors / totalSectors) * 100;
          
          if (percentage >= 100) {
            // Sieg-Dialog
            setTimeout(() => {
              if (confirm('🎉 VICTORY!\n\nDu hast den kompletten Planeten erobert!\n\nNeues Spiel starten?')) {
                location.reload();
              }
            }, 500);
          }
        };
        
        // Beziehungen aktualisieren
        const updateRelationships = (action, targetAI) => {
          const ai = aiOpponents.find(a => a.id === targetAI);
          if (!ai) return;
          
          if (action === 'attack') {
            ai.relationship = Math.max(-100, ai.relationship - 20);
          } else if (action === 'gift') {
            ai.relationship = Math.min(100, ai.relationship + 10);
          } else if (action === 'trade') {
            ai.relationship = Math.min(100, ai.relationship + 5);
          } else if (action === 'conquer_neighbor') {
            ai.relationship = Math.max(-100, ai.relationship - 5);
          }
        };
        
        // Militär-Panel aktualisieren
        const updateMilitaryPanel = () => {
          const strengthEl = document.getElementById('military-strength');
          const sectorsEl = document.getElementById('controlled-sectors');
          const percentageEl = document.getElementById('sector-percentage');
          const gridEl = document.getElementById('ai-opponents-grid');
          
          // Militär-Stärke - synchronisiere mit Ressource
          const playerStrength = getResource('military') || 50;
          militaryState.player.strength = playerStrength;
          if (strengthEl) {
            strengthEl.textContent = playerStrength;
            const maxStrength = resourceState.storageCapacity.military || 1000;
            const percent = Math.round((playerStrength / maxStrength) * 100);
            strengthEl.parentElement.style.setProperty('--value', `${percent}%`);
          }
          
          // Kontrollierte Sektoren
          const totalSectors = Object.keys(sectorOwnership).length;
          const playerSectors = Object.values(sectorOwnership).filter(s => s.owner === 'player').length;
          const percentage = totalSectors > 0 ? Math.round((playerSectors / totalSectors) * 100) : 0;
          
          if (sectorsEl) {
            sectorsEl.textContent = `${playerSectors}/${totalSectors}`;
          }
          if (percentageEl) {
            percentageEl.textContent = `${percentage}%`;
            percentageEl.parentElement.style.setProperty('--value', `${percentage}%`);
          }
          
          // KI-Gegner Grid
          if (gridEl) {
            gridEl.innerHTML = aiOpponents.map(ai => {
              const aiSectors = Object.values(sectorOwnership).filter(s => s.owner === ai.id).length;
              const relationship = ai.relationship || 0;
              const relationshipStatus = relationship < 0 ? 'Feindlich' : relationship < 50 ? 'Neutral' : 'Freundlich';
              const relationshipClass = relationship < 0 ? 'hostile' : relationship < 50 ? 'neutral' : 'friendly';
              
              return `
                <div class="faction-card" data-faction="${ai.id}">
                  <div class="faction-header">
                    <div class="faction-emblem" style="background: ${ai.color}20; color: ${ai.color};">⚔️</div>
                    <div class="faction-info">
                      <h4>${ai.name}</h4>
                      <span>Sektoren: ${aiSectors} | Militär: ${ai.military}</span>
                    </div>
                  </div>
                  <div class="faction-relations">
                    <small>Beziehung: <span class="relation-status">${relationshipStatus}</span> (<span class="relation-value">${relationship}</span>)</small>
                    <div class="relation-bar">
                      <div class="relation-fill ${relationshipClass}" style="width: ${Math.max(0, Math.min(100, relationship + 100))}%;"></div>
                    </div>
                  </div>
                  <div class="faction-actions">
                    <button class="faction-btn" data-action="attack-ai" data-ai-id="${ai.id}">⚔️ Angreifen</button>
                    <button class="faction-btn" data-action="gift-ai" data-ai-id="${ai.id}">🎁 Geschenk</button>
                  </div>
                </div>
              `;
            }).join('');
            
            // Event-Handler für KI-Aktionen
            gridEl.querySelectorAll('[data-action="attack-ai"]').forEach(btn => {
              btn.addEventListener('click', () => {
                const aiId = btn.dataset.aiId;
                const ai = aiOpponents.find(a => a.id === aiId);
                if (!ai) return;
                
                // Finde einen Sektor dieses KI-Gegners
                const aiSectors = Object.entries(sectorOwnership)
                  .filter(([id, data]) => data.owner === aiId);
                
                if (aiSectors.length === 0) {
                  toast({ type: 'info', title: 'Keine Sektoren', message: `${ai.name} hat keine Sektoren mehr.` });
                  return;
                }
                
                const targetSector = aiSectors[0][0];
                const ownership = sectorOwnership[targetSector];
                
                const playerStrength = militaryState.player.strength || 50;
                const defenderStrength = ownership.strength;
                const successChance = calculateCombat(playerStrength, defenderStrength, 1.2);
                
                if (confirm(`Sektor ${targetSector} angreifen?\n\nDeine Stärke: ${playerStrength}\nVerteidiger: ${defenderStrength}\nErfolgschance: ${Math.round(successChance * 100)}%`)) {
                  attackSector(targetSector);
                  updateMilitaryPanel();
                }
              });
            });
            
            gridEl.querySelectorAll('[data-action="gift-ai"]').forEach(btn => {
              btn.addEventListener('click', () => {
                const aiId = btn.dataset.aiId;
                showDiplomacyDialog('gift', aiId);
                updateMilitaryPanel();
              });
            });
          }
        };

        const setupEventOverlay = () => {
          const overlay = document.getElementById('event-overlay');
          const closeBtn = document.getElementById('event-close');
          const choices = document.getElementById('event-choices');
          if (closeBtn) {
            closeBtn.addEventListener('click', () => {
              pendingEvent = null;
              closeEventOverlay();
            });
          }
          overlay?.addEventListener('click', (e) => {
            if (e.target === overlay) {
              pendingEvent = null;
              closeEventOverlay();
            }
          });
          choices?.addEventListener('click', (e) => {
            const btn = e.target.closest('.event-choice');
            if (!btn || pendingEvent == null) return;
            const idx = parseInt(btn.dataset.choiceIndex || '0', 10);
            const choice = pendingEvent.choices?.[idx];
            handleEventChoice(choice, pendingEvent);
          });
        };

        const initAuth = () => {
          const overlay = document.getElementById('auth-overlay');
          const loginBtn = document.getElementById('auth-login');
          const logoutBtn = document.getElementById('auth-logout');
          const submitBtn = document.getElementById('auth-submit');
          const cancelBtn = document.getElementById('auth-cancel');
          const errorEl = document.getElementById('auth-error');
          const userInput = document.getElementById('auth-username');
          const passInput = document.getElementById('auth-pass');

          const setError = (msg) => { if (errorEl) errorEl.textContent = msg || ''; };
          const showOverlay = () => overlay?.classList.add('is-open');
          const hideOverlay = () => { overlay?.classList.remove('is-open'); setError(''); if (passInput) passInput.value=''; };

          if (!isCryptoAvailable()) {
            authState.user = 'gast';
            updateAuthUI();
            setError('Web Crypto nicht verfügbar – Login nur als Gast.');
            setButtonDisabled('auth-login', true);
            return;
          }

          const session = userStore.getSession();
          authState.user = session?.username || 'gast';
          updateAuthUI();

          loginBtn?.addEventListener('click', showOverlay);
          cancelBtn?.addEventListener('click', hideOverlay);

          logoutBtn?.addEventListener('click', () => {
            userStore.clearSession();
            authState.user = 'gast';
            updateAuthUI();
            location.reload();
          });

          submitBtn?.addEventListener('click', async () => {
            const username = (userInput?.value || '').trim().toLowerCase();
            const pass = passInput?.value || '';
            if (!username || pass.length < 6) {
              setError('Nutzername und Passcode (min. 6) erforderlich.');
              return;
            }
            const users = userStore.getUsers();
            const existing = users.find((u) => u.username === username);
            const passHash = await hashPasscode(pass);
            if (existing && existing.passHash !== passHash) {
              authState.failedAttempts += 1;
              setError('Falscher Passcode.');
              if (authState.failedAttempts >= 3) setError('Zu viele Versuche. Bitte kurz warten oder Gast nutzen.');
              return;
            }
            if (!existing) {
              users.push({ username, passHash });
              userStore.saveUsers(users);
            }
            authState.user = username;
            userStore.saveSession({ username, lastActive: Date.now() });
            updateAuthUI();
            hideOverlay();
            location.reload();
          });
        };

        // Soundtrack Player
        const setupSoundtrack = () => {
          const player = document.getElementById('soundtrack-player');
          const toggleBtn = document.getElementById('player-toggle');
          const volumeControl = document.getElementById('setting-volume');
          const musicToggle = document.getElementById('setting-music');
          
          if (!player || !toggleBtn) return;
          
          let isPlaying = false;
          let progressInterval = null;
          const tracks = [
            'Ambient: Orbital Horizons',
            'Ambient: Stellar Winds',
            'Ambient: Colony Dreams',
            'Ambient: Deep Space'
          ];
          let currentTrack = 0;
          let width = 0;
          let volumeFactor = Math.max(0.1, (parseInt(volumeControl?.value || '70', 10) || 70) / 100);

          const stopPlayback = () => {
            isPlaying = false;
            toggleBtn.textContent = '▶';
            if (progressInterval) {
              clearInterval(progressInterval);
              progressInterval = null;
            }
          };

          const startPlayback = () => {
            if (musicToggle && !musicToggle.checked) {
              stopPlayback();
              return;
            }
            isPlaying = true;
            toggleBtn.textContent = '⏸';
            const progress = player.querySelector('.player-progress span');
            if (progressInterval) clearInterval(progressInterval);
            progressInterval = setInterval(() => {
              width += 0.5 * volumeFactor;
              if (width >= 100) {
                width = 0;
                currentTrack = (currentTrack + 1) % tracks.length;
                player.querySelector('.player-track').textContent = tracks[currentTrack];
              }
              progress.style.width = width + '%';
            }, 100);
          };
          
          toggleBtn.addEventListener('click', () => {
            if (isPlaying) {
              stopPlayback();
            } else {
              startPlayback();
            }
          });

          musicToggle?.addEventListener('change', () => {
            if (musicToggle.checked) {
              startPlayback();
            } else {
              stopPlayback();
            }
            saveSettings();
          });

          volumeControl?.addEventListener('input', () => {
            volumeFactor = Math.max(0.1, (parseInt(volumeControl.value || '70', 10) || 70) / 100);
            saveSettings();
          });
        };

        // Full Game State
        const getGameState = () => {
          const seedInput = document.getElementById('seed-input');
          const buildGrid = document.getElementById('build-grid');
          const buildings = [];
          if (buildGrid) {
            buildGrid.querySelectorAll('.build-cell[data-building]').forEach(cell => {
              buildings.push({ index: parseInt(cell.dataset.index), building: cell.dataset.building });
            });
          }
          const research = [];
          document.querySelectorAll('.research-node.unlocked').forEach(node => {
            const title = node.querySelector('h4')?.textContent || '';
            if (title) research.push(title);
          });
          const routes = [];
          document.querySelectorAll('#route-list .route.editable').forEach(r => {
            const routeId = r.dataset.routeId || '';
            const spans = r.querySelectorAll('span');
            const routeText = spans[0]?.textContent || '';
            const routeMeta = spans[1]?.textContent || '';
            if (routeText) {
              routes.push({ id: routeId, text: routeText, meta: routeMeta });
            }
          });
          const researchTitles = unlockedResearch
            .map((id) => getResearchTitleById(id))
            .filter(Boolean);
          return {
            version: '2.2.0',
            seed: seedInput?.value || 'DEFAULT',
            simulation: { day: simState.day, year: simState.year, speed: simState.speed, paused: simState.paused },
            buildings,
            research: researchTitles,
            routes: routeState.routes,
            resources: resourceState.storage,
            resourceCapacity: resourceState.storageCapacity,
            researchPoints,
            unlockedResearch,
            researchQueue,
            tradeState,
            activeEffects,
            factions: factionState,
            settings: getSettings(),
            timestamp: new Date().toISOString()
          };
        };

        const setupRouteActions = () => {
          const list = document.querySelector("#panel-handel .route-list");
          if (!list || list.dataset.routeActionsAttached === "true") return;
          list.addEventListener("click", (event) => {
            const actionButton = event.target.closest("[data-action]");
            if (!actionButton) return;
            const routeEl = actionButton.closest(".route");
            if (!routeEl) return;
            const routeId = parseInt(routeEl.dataset.routeId || "0", 10);
            const route = routeState.routes.find((r) => r.id === routeId);
            if (!route) return;

            const action = actionButton.dataset.action;
            if (action === "edit-toggle") {
              route.editorOpen = !route.editorOpen;
              updateRouteUI();
              return;
            }

            if (action === "delete") {
              routeState.routes = routeState.routes.filter((r) => r.id !== routeId);
              toast({ type: "info", title: "Route gelöscht", message: "" });
              updateRouteUI();
              return;
            }

            if (action === "cancel-edit") {
              route.editorOpen = false;
              updateRouteUI();
              return;
            }

            if (action === "save-edit") {
              const editor = routeEl.querySelector(".route-inline-editor");
              if (!editor) return;
              const fromInput = editor.querySelector('[name="route-from"]');
              const toInput = editor.querySelector('[name="route-to"]');
              const cargoSelect = editor.querySelector('[name="route-cargo"]');
              const amountInput = editor.querySelector('[name="route-cargo-amount"]');
              const distanceInput = editor.querySelector('[name="route-distance"]');
              const capacityInput = editor.querySelector('[name="route-capacity"]');

              const fromValue = (fromInput?.value || "").trim();
              const toValue = (toInput?.value || "").trim();
              const cargoType = cargoSelect?.value || route.cargoType || "metal";
              const parsedDistance = Math.max(1, parseInt(distanceInput?.value || "", 10) || route.distance || 1);
              const parsedCapacity = Math.max(10, parseInt(capacityInput?.value || "", 10) || route.capacity || route.cargoAmount || 80);
              let parsedAmount = Math.max(10, parseInt(amountInput?.value || "", 10) || route.cargoAmount || 10);
              if (parsedAmount > parsedCapacity) parsedAmount = parsedCapacity;

              if (fromValue) route.from = fromValue;
              if (toValue) route.to = toValue;
              route.cargoType = cargoType;
              route.cargoAmount = parsedAmount;
              route.distance = parsedDistance;
              route.capacity = parsedCapacity;
              route.editorOpen = false;
              toast({ type: "success", title: "Route aktualisiert", message: `${route.from} → ${route.to}` });
              updateRouteUI();
            }
          });
          list.dataset.routeActionsAttached = "true";
        };

        const setupRouteEditor = () => {
          const addButton = document.getElementById('route-add');
          const fromSelect = document.getElementById('route-from');
          const toSelect = document.getElementById('route-to');
          const cargoSelect = document.getElementById('route-cargo');
          const amountInput = document.getElementById('route-amount');

          if (cargoSelect) {
            cargoSelect.innerHTML = Object.entries(resourceDefinitions)
              .map(([key, info]) => `<option value="${key}">${info.icon} ${info.label}</option>`)
              .join('');
            cargoSelect.value = 'metal';
          }
          
          if (addButton && fromSelect && toSelect) {
            initRouteStateFromDOM();
            addButton.addEventListener('click', () => {
              const from = fromSelect.value;
              const to = toSelect.value;
              const cargoType = cargoSelect?.value || 'metal';
              const amount = Math.max(10, parseInt(amountInput?.value || '0', 10) || 0);
              
              if (from === to) {
                toast({ type: 'warning', title: 'Ungültige Route', message: 'Start und Ziel müssen unterschiedlich sein.' });
                return;
              }
              
              const route = createRoute(from, to, { cargoType, cargoAmount: amount });
              updateRouteUI();
              toast({ type: 'success', title: 'Route erstellt', message: `${from} → ${to}` });
            });
          }

          setupRouteActions();
        };

        const loadGameState = (state) => {
          try {
            if (!state?.seed) throw new Error('Ungültiger Spielstand');
            const seedInput = document.getElementById('seed-input');
            if (seedInput) {
              seedInput.value = state.seed;
              if (applySeedToUI) {
                applySeedToUI(state.seed, { save: false });
              }
            }
            if (state.simulation) {
              simState.day = state.simulation.day || 1;
              simState.year = state.simulation.year || 1;
              simState.speed = state.simulation.speed || 1;
              simState.paused = state.simulation.paused || false;
              updateTimeDisplay();
            }
            if (state.buildings?.length) {
              const buildGrid = document.getElementById('build-grid');
              // Clear all first
              buildGrid?.querySelectorAll('.build-cell').forEach(cell => {
                cell.classList.remove('occupied');
                cell.innerHTML = '';
                delete cell.dataset.building;
              });
              // Restore buildings
              state.buildings.forEach(b => {
                const cell = buildGrid?.querySelector(`[data-index="${b.index}"]`);
                if (cell && b.building) {
                  cell.dataset.building = b.building;
                  cell.classList.add('occupied');
                  cell.innerHTML = renderBuildingIcon(b.building);
                }
              });
            }
            
            // Restore research
            if (state.unlockedResearch) {
              unlockedResearch = state.unlockedResearch;
              // Update research definitions
              Object.values(researchDefinitions).forEach(research => {
                research.unlocked = unlockedResearch.includes(research.id);
              });
              renderResearchTree();
              refreshBuildPalette();
            } else if (state.research?.length) {
              // Legacy support
              document.querySelectorAll('.research-node').forEach(node => {
                const title = node.querySelector('.node-title')?.textContent || '';
                if (state.research.includes(title)) {
                  node.classList.remove('available', 'locked');
                  node.classList.add('unlocked');
                  const costEl = node.querySelector('.node-cost');
                  if (costEl) costEl.textContent = '✓ Erforscht';
                  const prog = node.querySelector('.research-progress span');
                  if (prog) prog.style.width = '100%';
                }
              });
            }
            
            // Restore research points
            if (typeof state.researchPoints === 'number') {
              researchPoints = state.researchPoints;
            }
            researchQueue = Array.isArray(state.researchQueue) ? state.researchQueue : [];
            updateResearchQueueUI();
            processResearchQueue();
            if (state.tradeState) {
              tradeState.totalExported = state.tradeState.totalExported || 0;
              tradeState.completedRoutes = state.tradeState.completedRoutes || 0;
            }
            if (Array.isArray(state.activeEffects)) {
              activeEffects.splice(0, activeEffects.length, ...state.activeEffects);
            }
            
            // Restore resources
            if (state.resources) {
              Object.assign(resourceState.storage, state.resources);
            }
            if (state.resourceCapacity) {
              Object.assign(resourceState.storageCapacity, state.resourceCapacity);
            }
            
            // Restore routes
            if (state.routes && Array.isArray(state.routes) && state.routes.length > 0) {
              // Check if it's new format (routeState.routes) or old format
              if (state.routes[0] && typeof state.routes[0] === 'object' && state.routes[0].from) {
                routeState.routes = state.routes;
                routeState.nextRouteId = Math.max(...state.routes.map(r => r.id || 0), 0) + 1;
                routeState.initialized = true;
                updateRouteUI();
              } else {
                // Legacy format
                const routeList = document.getElementById('route-list');
                if (routeList) {
                  routeList.querySelectorAll('.route.editable').forEach(r => r.remove());
                  state.routes.forEach((route, idx) => {
                    const routeEl = document.createElement('div');
                    routeEl.className = 'route editable';
                    routeEl.dataset.routeId = route.id || `restored-${idx}`;
                    routeEl.innerHTML = `
                      <span>${route.text || route}</span>
                      <span>${route.meta || '5d / 80t'}</span>
                      <div class="route-actions">
                        <button class="route-action" data-action="edit">✏️</button>
                        <button class="route-action delete" data-action="delete">🗑️</button>
                      </div>
                    `;
                    routeList.appendChild(routeEl);
                  });
                  setupRouteActions();
                  routeState.initialized = true;
                }
              }
            }
            
            // Restore factions
            if (state.factions) {
              Object.assign(factionState, state.factions);
              Object.keys(factionState).forEach((key) => updateFactionRelations(key, 0));
            }
            
            if (state.settings) applySettings(state.settings);
            updateResourcePanel();
            updateEffectsPanel();
            updateResearchUI();
            processResearchQueue();
            refreshColonyUI();
            toast({ type: 'success', title: 'Geladen', message: `Spielstand vom ${new Date(state.timestamp || Date.now()).toLocaleDateString('de-DE')}` });
          } catch (e) {
            toast({ type: 'danger', title: 'Fehler', message: e.message });
          }
        };

        // Export Functions
        const setupExport = () => {
          const jsonBtn = document.getElementById('export-json');
          const pngBtn = document.getElementById('export-png');
          const linkBtn = document.getElementById('export-link');
          const clipboardBtn = document.getElementById('export-clipboard');
          const printBtn = document.getElementById('export-print');
          const saveBtn = document.getElementById('save-game');
          const loadBtn = document.getElementById('load-game');
          const importZone = document.getElementById('import-zone');
          const importFile = document.getElementById('import-file');
          
          const seedInput = document.getElementById('seed-input');
          
          // JSON Export (full state)
          if (jsonBtn) {
            jsonBtn.addEventListener('click', () => {
              const data = getGameState();
              const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `planet-${data.seed}-${simState.year}.json`;
              a.click();
              URL.revokeObjectURL(url);
              toast({ type: "success", title: "Export", message: "Spielstand als JSON gespeichert." });
            });
          }
          
          // PNG Export via Canvas
          if (pngBtn) {
            pngBtn.addEventListener('click', async () => {
              try {
                const sourceCanvas = document.getElementById('main-planet-canvas');
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 400;
                canvas.height = 400;
                ctx.fillStyle = document.documentElement.dataset.theme === 'dark' ? '#0d1117' : '#f8efe0';
                ctx.fillRect(0, 0, 400, 400);
                if (sourceCanvas) {
                  ctx.drawImage(sourceCanvas, 50, 50, 300, 300);
                } else {
                  ctx.beginPath();
                  ctx.arc(200, 200, 150, 0, Math.PI * 2);
                  const grad = ctx.createRadialGradient(160, 160, 20, 200, 200, 180);
                  grad.addColorStop(0, '#4ade80');
                  grad.addColorStop(0.5, '#3b82f6');
                  grad.addColorStop(1, '#1e3a5f');
                  ctx.fillStyle = grad;
                  ctx.fill();
                }
                ctx.font = '16px Cinzel';
                ctx.fillStyle = document.documentElement.dataset.theme === 'dark' ? '#e6edf3' : '#1d1a16';
                ctx.textAlign = 'center';
                ctx.fillText(`Seed: ${seedInput?.value || 'DEFAULT'}`, 200, 380);
                ctx.fillText(`Jahr ${simState.year}, Tag ${simState.day}`, 200, 30);
                canvas.toBlob(blob => {
                  const url = URL.createObjectURL(blob);
                  const a = document.createElement('a');
                  a.href = url;
                  a.download = `planet-${seedInput?.value || 'snapshot'}.png`;
                  a.click();
                  URL.revokeObjectURL(url);
                  toast({ type: 'success', title: 'PNG Export', message: 'Bild gespeichert.' });
                });
              } catch (e) {
                toast({ type: 'danger', title: 'Export fehlgeschlagen', message: e.message });
              }
            });
          }
          
          // Print
          if (printBtn) {
            printBtn.addEventListener('click', () => {
              window.print();
            });
          }
          
          if (linkBtn) {
            linkBtn.addEventListener('click', () => {
              const url = new URL(window.location.href);
              url.searchParams.set('seed', seedInput?.value || 'DEFAULT');
              copyToClipboard(url.toString())
                .then(() => toast({ type: "success", title: "Link kopiert", message: "Der Share-Link ist in der Zwischenablage." }))
                .catch(() => toast({ type: "danger", title: "Kopieren fehlgeschlagen", message: "Zwischenablage nicht verfügbar." }));
            });
          }
          
          if (clipboardBtn) {
            clipboardBtn.addEventListener('click', () => {
              const seed = seedInput?.value || 'DEFAULT';
              copyToClipboard(seed)
                .then(() => toast({ type: "success", title: "Seed kopiert", message: seed }))
                .catch(() => toast({ type: "danger", title: "Kopieren fehlgeschlagen", message: "Zwischenablage nicht verfügbar." }));
            });
          }
          
          // Save to LocalStorage (per User)
          if (saveBtn) {
            saveBtn.addEventListener('click', () => {
              if (!authState.user) {
                toast({ type: 'warning', title: 'Login nötig', message: 'Bitte zuerst anmelden.' });
                return;
              }
              const state = getGameState();
              // Update active planet state
              const active = getActivePlanet();
              if (active) {
                Object.assign(active, {
                  seed: state.seed,
                  simulation: state.simulation,
                  buildings: state.buildings,
                  research: state.research,
                  routes: state.routes,
                  resources: state.resources,
                  resourceCapacity: state.resourceCapacity,
                  researchPoints: state.researchPoints,
                  unlockedResearch: state.unlockedResearch,
                  researchQueue: state.researchQueue,
                  tradeState: state.tradeState,
                  activeEffects: state.activeEffects
                });
                savePlanetsToStorage();
              }
              localStorage.setItem(saveKeyForUser(authState.user, 'save'), JSON.stringify(state));
              const feedback = document.getElementById('save-feedback');
              if (feedback) feedback.textContent = `Gespeichert: Jahr ${state.simulation.year}, Tag ${state.simulation.day}`;
              toast({ type: 'success', title: 'Gespeichert', message: 'Spielstand gespeichert.' });
            });
          }
          
          // Load from LocalStorage (per User)
          if (loadBtn) {
            loadBtn.addEventListener('click', () => {
              if (!authState.user) {
                toast({ type: 'warning', title: 'Login nötig', message: 'Bitte zuerst anmelden.' });
                return;
              }
              const saved = localStorage.getItem(saveKeyForUser(authState.user, 'save'));
              if (saved) {
                loadGameState(JSON.parse(saved));
              } else {
                toast({ type: 'warning', title: 'Kein Spielstand', message: 'Es ist kein Spielstand gespeichert.' });
              }
            });
          }
          
          // Import Zone (drag & drop + click)
          if (importZone && importFile) {
            importZone.addEventListener('click', () => importFile.click());
            importZone.addEventListener('dragover', (e) => { e.preventDefault(); importZone.classList.add('drag-over'); });
            importZone.addEventListener('dragleave', () => importZone.classList.remove('drag-over'));
            importZone.addEventListener('drop', (e) => {
              e.preventDefault();
              importZone.classList.remove('drag-over');
              const file = e.dataTransfer.files[0];
              if (file) handleImportFile(file);
            });
            importFile.addEventListener('change', (e) => {
              const file = e.target.files[0];
              if (file) handleImportFile(file);
            });
          }
        };

        const handleImportFile = (file) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const state = JSON.parse(e.target.result);
              loadGameState(state);
            } catch (err) {
              toast({ type: 'danger', title: 'Import fehlgeschlagen', message: 'Ungültige JSON-Datei.' });
            }
          };
          reader.readAsText(file);
        };

        // Simulation State & Tick
        const simState = {
          paused: true, // Start pausiert
          speed: 1,
          day: 1,
          year: 1,
          tickInterval: null,
          nextEventIn: 35
        };

        // Tutorial State
        let tutorialCompleted = localStorage.getItem('tutorialCompleted') === 'true';

        // ===== PHASE 1: PRODUKTIONSKETTEN-SYSTEM =====
        
        // 1.1 Ressourcen-Management-System
        const resourceState = {
          storage: {
            ice: 500,
            regolith: 350,
            water: 300,
            energy: 4000,
            food: 220,
            metal: 250,
            military: 50
          },
          storageCapacity: {
            ice: 1000,
            regolith: 800,
            water: 500,
            energy: 10000,
            food: 400,
            metal: 600,
            military: 1000
          }
        };

        const addResource = (type, amount) => {
          if (!resourceState.storage.hasOwnProperty(type)) {
            console.warn(`Unknown resource type: ${type}`);
            return false;
          }
          const current = resourceState.storage[type];
          const capacity = resourceState.storageCapacity[type] || Infinity;
          const newAmount = Math.min(current + amount, capacity);
          resourceState.storage[type] = newAmount;
          return newAmount > current;
        };

        const consumeResource = (type, amount) => {
          if (!resourceState.storage.hasOwnProperty(type)) {
            console.warn(`Unknown resource type: ${type}`);
            return false;
          }
          if (resourceState.storage[type] >= amount) {
            resourceState.storage[type] -= amount;
            return true;
          }
          return false;
        };

        const getResource = (type) => {
          return resourceState.storage[type] || 0;
        };

        const updateStorageCapacity = () => {
          // Capacity wird basierend auf Gebäuden berechnet
          const buildGrid = document.getElementById('build-grid');
          if (!buildGrid) return;
          
          const warehouses = buildGrid.querySelectorAll('[data-building="warehouse"]').length;
          const baseCapacity = {
            ice: 1000,
            regolith: 800,
            water: 500,
            energy: 10000,
            food: 400,
            metal: 600
          };
          
          const warehouseBonus = warehouses * 200;
          Object.keys(baseCapacity).forEach(type => {
            resourceState.storageCapacity[type] = baseCapacity[type] + warehouseBonus;
            resourceState.storage[type] = Math.min(resourceState.storage[type], resourceState.storageCapacity[type]);
          });
        };

        const formatResourceValue = (value) => {
          if (value >= 1000000) return `${(value / 1000000).toFixed(1).replace(".0", "")}M`;
          if (value >= 1000) return `${Math.round(value / 1000)}k`;
          return String(value);
        };

        const formatEffectSummary = (effects = {}) => {
          const labels = {
            supply: "Versorgung",
            energy: "Energie",
            water: "Wasser",
            emissions: "Emissionen",
            population: "Bevölkerung"
          };
          const parts = Object.entries(labels)
            .map(([key, label]) => {
              if (typeof effects[key] !== "number") return null;
              const value = Math.round(effects[key] * 100);
              const sign = value > 0 ? "+" : "";
              return `${label} ${sign}${value}%`;
            })
            .filter(Boolean);
          return parts.length ? parts.join(" · ") : "Aktiv";
        };

        const updateResourcePanel = () => {
          const grid = document.getElementById("resource-grid");
          if (!grid) return;

          grid.innerHTML = Object.entries(resourceDefinitions)
            .map(([key, info]) => {
              const value = getResource(key);
              const capacity = resourceState.storageCapacity[key] || 0;
              const percent = capacity ? Math.round((value / capacity) * 100) : 0;
              const produced = lastProductionStats.totalProduced[key] || 0;
              const consumed = lastProductionStats.totalConsumed[key] || 0;
              const net = produced - consumed;
              const deltaClass = net > 0 ? "positive" : net < 0 ? "negative" : "";
              const deltaLabel = net === 0 ? "±0" : net > 0 ? `+${net}` : `${net}`;

              return `
                <div class="resource-item" data-resource="${key}" style="cursor: pointer;">
                  <div class="resource-head">
                    <div class="resource-name">${info.icon} ${info.label}</div>
                    <div class="resource-amount">${formatResourceValue(value)} ${info.unit}</div>
                  </div>
                  <div class="resource-meter" style="--value: ${percent}%"><span></span></div>
                  <div class="resource-meta">
                    <span>${formatResourceValue(value)} / ${formatResourceValue(capacity)} ${info.unit}</span>
                    <span class="resource-delta ${deltaClass}">${deltaLabel} ${info.unit}/Tag</span>
                  </div>
                </div>
              `;
            })
            .join("");
          
          // Klick-Handler für Ressourcen-Karten
          grid.querySelectorAll('.resource-item').forEach(item => {
            item.addEventListener('click', () => {
              const resourceKey = item.dataset.resource;
              const info = resourceDefinitions[resourceKey];
              if (!info) return;
              
              const value = getResource(resourceKey);
              const capacity = resourceState.storageCapacity[resourceKey] || 0;
              const produced = lastProductionStats.totalProduced[resourceKey] || 0;
              const consumed = lastProductionStats.totalConsumed[resourceKey] || 0;
              const net = produced - consumed;
              
              const modal = document.getElementById('kpi-detail-modal');
              const titleEl = document.getElementById('kpi-detail-title');
              const contentEl = document.getElementById('kpi-detail-content');
              
              if (modal && titleEl && contentEl) {
                titleEl.textContent = `${info.icon} ${info.label}`;
                contentEl.innerHTML = `
                  <div class="kpi-detail-row">
                    <span class="kpi-detail-label">Aktueller Bestand</span>
                    <span class="kpi-detail-value">${formatResourceValue(value)} ${info.unit}</span>
                  </div>
                  <div class="kpi-detail-row">
                    <span class="kpi-detail-label">Kapazität</span>
                    <span class="kpi-detail-value">${formatResourceValue(capacity)} ${info.unit}</span>
                  </div>
                  <div class="kpi-detail-row">
                    <span class="kpi-detail-label">Produktion</span>
                    <span class="kpi-detail-value">+${formatResourceValue(produced)} ${info.unit}/Tag</span>
                  </div>
                  <div class="kpi-detail-row">
                    <span class="kpi-detail-label">Verbrauch</span>
                    <span class="kpi-detail-value">-${formatResourceValue(consumed)} ${info.unit}/Tag</span>
                  </div>
                  <div class="kpi-detail-row">
                    <span class="kpi-detail-label">Netto-Fluss</span>
                    <span class="kpi-detail-value ${net > 0 ? 'kpi-trend up' : net < 0 ? 'kpi-trend down' : ''}">${net > 0 ? '+' : ''}${formatResourceValue(net)} ${info.unit}/Tag</span>
                  </div>
                  <div class="kpi-detail-row">
                    <span class="kpi-detail-label">Auslastung</span>
                    <span class="kpi-detail-value">${capacity ? Math.round((value / capacity) * 100) : 0}%</span>
                  </div>
                `;
                modal.classList.add('is-open');
              }
            });
          });
        };

        const updateEffectsPanel = () => {
          const list = document.getElementById("effects-list");
          if (!list) return;

          if (!activeEffects.length) {
            list.innerHTML = `<div class="effect-item"><strong>Alles stabil</strong><span>Keine aktiven Effekte</span></div>`;
            return;
          }

          list.innerHTML = activeEffects
            .map((effect) => {
              return `
                <div class="effect-item">
                  <strong>${effect.label}</strong>
                  <span>${effect.remainingDays} Tage · ${formatEffectSummary(effect.effects)}</span>
                </div>
              `;
            })
            .join("");
        };

        // 1.2 Gebäude-Definitionen mit Input/Output
        const buildingDefinitions = {
          solar: {
            name: 'Solarfeld',
            icon: '⚡',
            produces: { energy: 50 },
            consumes: {},
            radius: 2,
            cost: { metal: 100 },
            emissions: 0
          },
          water: {
            name: 'Wasserwerk',
            icon: '💧',
            produces: { water: 30 },
            consumes: { ice: 20 },
            radius: 3,
            cost: { metal: 150 },
            emissions: 0
          },
          hydro: {
            name: 'Hydroponik',
            icon: '🌱',
            produces: { food: 25 },
            consumes: { water: 15, energy: 10 },
            radius: 2,
            cost: { metal: 200 },
            emissions: 2
          },
          refinery: {
            name: 'Raffinerie',
            icon: '🏭',
            produces: { metal: 20 },
            consumes: { regolith: 30, energy: 25 },
            radius: 3,
            cost: { metal: 300 },
            emissions: 15
          },
          lab: {
            name: 'Labor',
            icon: '🔬',
            produces: {},
            consumes: { energy: 20 },
            radius: 2,
            cost: { metal: 250 },
            emissions: 1,
            researchPoints: 5
          },
          barracks: {
            name: 'Kaserne',
            icon: '⚔️',
            produces: { military: 5 },
            consumes: { metal: 10, food: 5, energy: 15 },
            radius: 2,
            cost: { metal: 400 },
            emissions: 3
          },
          home: {
            name: 'Wohnkuppel',
            icon: '🏠',
            produces: {},
            consumes: { water: 5, energy: 8, food: 3 },
            radius: 2,
            cost: { metal: 120 },
            emissions: 1,
            population: 50
          },
          spaceport: {
            name: 'Raumhafen',
            icon: '🚀',
            produces: {},
            consumes: { energy: 40, metal: 10 },
            radius: 4,
            cost: { metal: 500 },
            emissions: 8
          },
          warehouse: {
            name: 'Lager',
            icon: '📦',
            produces: {},
            consumes: { energy: 5 },
            radius: 1,
            cost: { metal: 80 },
            emissions: 0
          },
          'fusion-reactor': {
            name: 'Fusionsreaktor',
            icon: '⚛️',
            produces: { energy: 180 },
            consumes: { water: 10, metal: 5 },
            radius: 3,
            cost: { metal: 600 },
            emissions: 6
          },
          'orbital-shipyard': {
            name: 'Orbit-Werft',
            icon: '🛰️',
            produces: {},
            consumes: { energy: 35, metal: 20 },
            radius: 3,
            cost: { metal: 800 },
            emissions: 6,
            tradeBonus: 0.15
          },
          'dyson-mirror': {
            name: 'Dyson-Spiegel',
            icon: '☀️',
            produces: { energy: 320 },
            consumes: { metal: 20 },
            radius: 4,
            cost: { metal: 1200 },
            emissions: 0
          }
        };

        const getBuildingCost = (buildingType) => {
          const building = buildingDefinitions[buildingType];
          return building?.cost || {};
        };

        const canAffordBuilding = (buildingType) => {
          const cost = getBuildingCost(buildingType);
          return Object.entries(cost).every(([resource, amount]) => getResource(resource) >= amount);
        };

        const payBuildingCost = (buildingType) => {
          const cost = getBuildingCost(buildingType);
          Object.entries(cost).forEach(([resource, amount]) => {
            consumeResource(resource, amount);
          });
        };

        const refreshBuildPalette = () => {
          const palette = document.querySelector('.build-palette');
          if (!palette) return;
          palette.querySelectorAll('.build-item[data-building]').forEach(item => {
            const building = item.dataset.building;
            const unlocked = isBuildingUnlocked(building);
            item.classList.toggle('is-locked', !unlocked);
            item.setAttribute('aria-disabled', unlocked ? 'false' : 'true');
            if (!unlocked && item.dataset.requires) {
              item.title = 'Forschung erforderlich';
            } else {
              item.removeAttribute('title');
            }
          });
        };

        // 1.3 Produktionsketten-Logik
        const checkBuildingRequirements = (buildingType) => {
          const building = buildingDefinitions[buildingType];
          if (!building) return false;
          const efficiency = getBuildingEfficiency(buildingType);
          
          // Prüfe ob alle benötigten Inputs verfügbar sind
          for (const [resource, amount] of Object.entries(building.consumes)) {
            const needed = Math.round(amount * efficiency);
            if (getResource(resource) < needed) {
              return false;
            }
          }
          return true;
        };

        const calculateBuildingProduction = (buildingType, efficiency = 1.0) => {
          const building = buildingDefinitions[buildingType];
          if (!building) return { produced: {}, consumed: {}, canProduce: false };
          
          const canProduce = checkBuildingRequirements(buildingType);
          if (!canProduce) {
            return { produced: {}, consumed: {}, canProduce: false };
          }
          
          const produced = {};
          const consumed = {};
          
          // Verbrauche Inputs
          for (const [resource, amount] of Object.entries(building.consumes)) {
            const actualAmount = Math.round(amount * efficiency);
            if (consumeResource(resource, actualAmount)) {
              consumed[resource] = actualAmount;
            } else {
              return { produced: {}, consumed: {}, canProduce: false };
            }
          }
          
          // Produziere Outputs
          for (const [resource, amount] of Object.entries(building.produces)) {
            const actualAmount = Math.round(amount * efficiency);
            addResource(resource, actualAmount);
            produced[resource] = actualAmount;
          }
          
          return { produced, consumed, canProduce: true };
        };

        const processProductionCycle = (cycles = 1) => {
          const buildGrid = document.getElementById('build-grid');
          if (!buildGrid) return emptyProductionStats();
          
          const buildings = buildGrid.querySelectorAll('.build-cell[data-building]');
          const productionStats = emptyProductionStats();
          
          // Sammle alle Gebäude
          const buildingCounts = {};
          buildings.forEach(cell => {
            const type = cell.dataset.building;
            buildingCounts[type] = (buildingCounts[type] || 0) + 1;
          });
          
          const buildingEntries = Object.entries(buildingCounts).map(([type, count]) => ({
            type,
            count,
            efficiency: getBuildingEfficiency(type)
          }));

          for (let cycle = 0; cycle < cycles; cycle += 1) {
            buildingEntries.forEach(({ type, count, efficiency }) => {
              for (let i = 0; i < count; i++) {
                const result = calculateBuildingProduction(type, efficiency);
                
                if (result.canProduce) {
                  productionStats.buildingsActive++;
                  Object.entries(result.produced).forEach(([res, amount]) => {
                    productionStats.totalProduced[res] = (productionStats.totalProduced[res] || 0) + amount;
                  });
                  Object.entries(result.consumed).forEach(([res, amount]) => {
                    productionStats.totalConsumed[res] = (productionStats.totalConsumed[res] || 0) + amount;
                  });
                } else {
                  productionStats.buildingsBlocked++;
                }
              }
            });
          }
          
          return productionStats;
        };

        const updateResourceFlows = (cycles = 0) => {
          if (cycles > 0) {
            lastProductionStats = processProductionCycle(cycles);
          }
          return lastProductionStats;
        };

        // ===== PHASE 2: RESEARCH & PROGRESSION =====
        
        // 2.1 Research-Definitionen mit Effekten
        const researchDefinitions = {
          'Solarenergie': {
            id: 'solar',
            tier: 1,
            cost: 0,
            unlocked: true,
            effects: {
              buildingEfficiency: { solar: 1.2 }
            }
          },
          'Wassergewinnung': {
            id: 'water',
            tier: 1,
            cost: 0,
            unlocked: true,
            effects: {
              buildingEfficiency: { water: 1.15 }
            }
          },
          'Hydroponik I': {
            id: 'hydro1',
            tier: 1,
            cost: 0,
            unlocked: true,
            effects: {
              buildingEfficiency: { hydro: 1.1 }
            }
          },
          'Fusionsreaktor': {
            id: 'fusion',
            tier: 2,
            cost: 2500,
            requirements: ['solar'],
            unlocked: false,
            effects: {
              unlockBuilding: 'fusion-reactor',
              buildingEfficiency: { energy: 1.5 }
            }
          },
          'Erzraffinerie II': {
            id: 'refinery2',
            tier: 2,
            cost: 1800,
            requirements: ['hydro1'],
            unlocked: false,
            effects: {
              buildingEfficiency: { refinery: 1.3 }
            }
          },
          'Klima-Steuerung': {
            id: 'climate',
            tier: 2,
            cost: 2000,
            requirements: ['water'],
            unlocked: false,
            effects: {
              globalEfficiency: 1.1,
              emissionsReduction: 0.1
            }
          },
          'Orbit-Werft': {
            id: 'orbital',
            tier: 3,
            cost: 5000,
            requirements: ['fusion', 'refinery2'],
            unlocked: false,
            effects: {
              unlockBuilding: 'orbital-shipyard',
              tradeBonus: 1.2
            }
          },
          'Atmosphären-Prozessor': {
            id: 'atmosphere',
            tier: 3,
            cost: 6500,
            requirements: ['climate'],
            unlocked: false,
            effects: {
              emissionsReduction: 0.25,
              globalEfficiency: 1.15
            }
          },
          'Gen-Anpassung': {
            id: 'genetics',
            tier: 3,
            cost: 8000,
            requirements: ['hydro1'],
            unlocked: false,
            effects: {
              populationBonus: 1.2,
              buildingEfficiency: { hydro: 1.4 }
            }
          },
          'Dyson-Spiegel': {
            id: 'dyson',
            tier: 4,
            cost: 15000,
            requirements: ['orbital', 'atmosphere'],
            unlocked: false,
            effects: {
              unlockBuilding: 'dyson-mirror',
              energyBonus: 2.0
            }
          },
          'Planetares Netzwerk': {
            id: 'network',
            tier: 4,
            cost: 12000,
            requirements: ['genetics', 'orbital'],
            unlocked: false,
            effects: {
              globalEfficiency: 1.3,
              tradeBonus: 1.5
            }
          },
          // Neue Forschungszweige - Energie
          'Energiespeicher I': {
            id: 'battery1',
            tier: 1,
            cost: 800,
            requirements: ['solar'],
            unlocked: false,
            effects: {
              storageCapacity: { energy: 1.5 }
            }
          },
          'Energiespeicher II': {
            id: 'battery2',
            tier: 2,
            cost: 2200,
            requirements: ['battery1'],
            unlocked: false,
            effects: {
              storageCapacity: { energy: 2.0 }
            }
          },
          'Geothermie': {
            id: 'geothermal',
            tier: 2,
            cost: 2800,
            requirements: ['water'],
            unlocked: false,
            effects: {
              unlockBuilding: 'geothermal-plant',
              buildingEfficiency: { energy: 1.3 }
            }
          },
          'Kernfusion II': {
            id: 'fusion2',
            tier: 3,
            cost: 6000,
            requirements: ['fusion'],
            unlocked: false,
            effects: {
              buildingEfficiency: { energy: 1.8 },
              energyBonus: 1.3
            }
          },
          // Neue Forschungszweige - Ressourcen
          'Tiefbohrung': {
            id: 'deepmining',
            tier: 2,
            cost: 2400,
            requirements: ['refinery2'],
            unlocked: false,
            effects: {
              unlockBuilding: 'deep-mine',
              buildingEfficiency: { refinery: 1.5 }
            }
          },
          'Ressourcen-Recycling': {
            id: 'recycling',
            tier: 2,
            cost: 2000,
            requirements: ['hydro1'],
            unlocked: false,
            effects: {
              globalEfficiency: 1.15,
              emissionsReduction: 0.15
            }
          },
          'Asteroiden-Abbau': {
            id: 'asteroid',
            tier: 3,
            cost: 7000,
            requirements: ['orbital'],
            unlocked: false,
            effects: {
              unlockBuilding: 'asteroid-miner',
              resourceBonus: 1.4
            }
          },
          // Neue Forschungszweige - Bevölkerung
          'Hydroponik II': {
            id: 'hydro2',
            tier: 2,
            cost: 2600,
            requirements: ['hydro1'],
            unlocked: false,
            effects: {
              buildingEfficiency: { hydro: 1.3 },
              populationBonus: 1.1
            }
          },
          'Hydroponik III': {
            id: 'hydro3',
            tier: 3,
            cost: 5500,
            requirements: ['hydro2', 'genetics'],
            unlocked: false,
            effects: {
              buildingEfficiency: { hydro: 1.6 },
              populationBonus: 1.25
            }
          },
          'Lebensraum-Expansion': {
            id: 'habitat',
            tier: 2,
            cost: 3000,
            requirements: ['climate'],
            unlocked: false,
            effects: {
              unlockBuilding: 'habitat-dome',
              populationBonus: 1.3
            }
          },
          // Neue Forschungszweige - Terraforming
          'Terraforming I': {
            id: 'terraform1',
            tier: 2,
            cost: 3200,
            requirements: ['climate'],
            unlocked: false,
            effects: {
              unlockBuilding: 'terraform-station',
              emissionsReduction: 0.2
            }
          },
          'Terraforming II': {
            id: 'terraform2',
            tier: 3,
            cost: 7500,
            requirements: ['terraform1', 'atmosphere'],
            unlocked: false,
            effects: {
              globalEfficiency: 1.2,
              emissionsReduction: 0.35
            }
          },
          'Biosphären-Engineering': {
            id: 'biosphere',
            tier: 3,
            cost: 6500,
            requirements: ['genetics', 'terraform1'],
            unlocked: false,
            effects: {
              unlockBuilding: 'biosphere-lab',
              populationBonus: 1.4,
              globalEfficiency: 1.15
            }
          },
          // Neue Forschungszweige - Handel
          'Handelsoptimierung': {
            id: 'tradeopt',
            tier: 2,
            cost: 1800,
            requirements: [],
            unlocked: false,
            effects: {
              tradeBonus: 1.15
            }
          },
          'Handelsnetzwerk': {
            id: 'tradenet',
            tier: 3,
            cost: 5000,
            requirements: ['tradeopt', 'orbital'],
            unlocked: false,
            effects: {
              tradeBonus: 1.4,
              globalEfficiency: 1.1
            }
          },
          'Interplanetarer Handel': {
            id: 'intertrade',
            tier: 4,
            cost: 14000,
            requirements: ['tradenet', 'network'],
            unlocked: false,
            effects: {
              tradeBonus: 2.0,
              unlockBuilding: 'interplanetary-port'
            }
          },
          // Neue Forschungszweige - Spezial
          'Quantencomputer': {
            id: 'quantum',
            tier: 3,
            cost: 8000,
            requirements: ['fusion', 'network'],
            unlocked: false,
            effects: {
              globalEfficiency: 1.4,
              researchBonus: 1.5
            }
          },
          'Nanotechnologie': {
            id: 'nano',
            tier: 3,
            cost: 6000,
            requirements: ['refinery2', 'genetics'],
            unlocked: false,
            effects: {
              buildingEfficiency: { refinery: 1.6, hydro: 1.3 },
              emissionsReduction: 0.2
            }
          },
          'Künstliche Intelligenz': {
            id: 'ai',
            tier: 4,
            cost: 16000,
            requirements: ['quantum', 'network'],
            unlocked: false,
            effects: {
              globalEfficiency: 1.5,
              researchBonus: 2.0,
              populationBonus: 1.2
            }
          }
        };

        const getResearchByTitle = (title) => {
          return researchDefinitions[title] || null;
        };

        const getResearchTitleById = (id) => {
          return Object.keys(researchDefinitions).find((key) => researchDefinitions[key].id === id);
        };

        const getResearchById = (id) => {
          return Object.values(researchDefinitions).find((research) => research.id === id) || null;
        };

        let researchPoints = 0;
        let unlockedResearch = ['solar', 'water', 'hydro1']; // Start-Research
        let researchQueue = [];

        // 2.2 Forschungspunkte-System
        const generateResearchPoints = () => {
          const buildGrid = document.getElementById('build-grid');
          if (!buildGrid) return 0;
          
          const labs = buildGrid.querySelectorAll('[data-building="lab"]').length;
          const basePoints = labs * 5; // Jedes Labor produziert 5 Punkte
          
          // Faction-Boni (wird später durch Diplomatie erweitert)
          let factionBonus = 1.0; // Basis
          if (factionState?.tech?.relation >= 70 && factionState.tech.treaties.includes('Forschungsabkommen')) {
            factionBonus += 0.15;
          }
          
          return Math.round(basePoints * factionBonus);
        };

        const canAffordResearch = (researchId) => {
          const research = Object.values(researchDefinitions).find(r => r.id === researchId);
          if (!research) return false;
          
          if (research.unlocked) return false; // Bereits freigeschaltet
          
          if (researchPoints < research.cost) return false; // Nicht genug Punkte
          
          // Prüfe Requirements
          if (research.requirements) {
            for (const req of research.requirements) {
              if (!unlockedResearch.includes(req)) {
                return false;
              }
            }
          }
          
          return true;
        };

        const canQueueResearch = (researchId) => {
          const research = getResearchById(researchId);
          if (!research) return false;
          if (research.unlocked) return false;
          if (research.requirements) {
            for (const req of research.requirements) {
              if (!unlockedResearch.includes(req)) {
                return false;
              }
            }
          }
          return true;
        };

        const unlockResearch = (researchId) => {
          if (!canAffordResearch(researchId)) {
            toast({ type: 'warning', title: 'Research nicht verfügbar', message: 'Nicht genug Forschungspunkte oder Voraussetzungen nicht erfüllt.' });
            return false;
          }
          
          const research = Object.values(researchDefinitions).find(r => r.id === researchId);
          if (!research) return false;
          
          researchPoints -= research.cost;
          research.unlocked = true;
          unlockedResearch.push(researchId);
          
          // Wende Effekte an
          applyResearchEffects(research);
          
          toast({ type: 'success', title: 'Research freigeschaltet!', message: `${Object.keys(researchDefinitions).find(k => researchDefinitions[k].id === researchId)} wurde erforscht.` });
          
          return true;
        };

        // 2.3 Research-Effekte anwenden
        const applyResearchEffects = (research) => {
          // Effekte werden bereits durch getBuildingEfficiency angewendet
          // Zusätzliche Effekte wie neue Gebäude werden hier behandelt
          if (research.effects.unlockBuilding) {
            // Neues Gebäude wird verfügbar (wird in Build-Editor angezeigt)
            toast({ type: 'info', title: 'Neues Gebäude verfügbar', message: `${research.effects.unlockBuilding} kann jetzt gebaut werden.` });
            refreshBuildPalette();
          }
        };

        const isBuildingUnlocked = (buildingType) => {
          // Prüfe ob Gebäude durch Research freigeschaltet wurde
          const research = Object.values(researchDefinitions).find(r => 
            r.effects.unlockBuilding === buildingType
          );
          if (research) {
            return research.unlocked;
          }
          // Standard-Gebäude sind immer verfügbar
          return ['solar', 'water', 'hydro', 'refinery', 'lab', 'home', 'spaceport', 'warehouse', 'geothermal-plant', 'deep-mine', 'asteroid-miner', 'habitat-dome', 'terraform-station', 'biosphere-lab', 'interplanetary-port'].includes(buildingType);
        };

        // Helper-Funktion für Building-Efficiency (wird durch Research modifiziert)
        const getBuildingEfficiency = (buildingType) => {
          let efficiency = 1.0;
          
          // Wende Research-Effekte an
          unlockedResearch.forEach(researchId => {
            const research = Object.values(researchDefinitions).find(r => r.id === researchId);
            if (research && research.effects.buildingEfficiency) {
              if (research.effects.buildingEfficiency[buildingType]) {
                efficiency *= research.effects.buildingEfficiency[buildingType];
              }
              if (research.effects.buildingEfficiency.energy && (buildingType === 'solar' || buildingType === 'fusion-reactor')) {
                efficiency *= research.effects.buildingEfficiency.energy;
              }
            }
          });
          
          // Globale Effizienz-Boni
          unlockedResearch.forEach(researchId => {
            const research = Object.values(researchDefinitions).find(r => r.id === researchId);
            if (research && research.effects.globalEfficiency) {
              efficiency *= research.effects.globalEfficiency;
            }
          });
          
          return efficiency;
        };

        function getResearchEffects() {
          const effects = {
            populationBonus: 1.0,
            emissionsReduction: 0,
            tradeBonus: 1.0
          };
          unlockedResearch.forEach((researchId) => {
            const research = Object.values(researchDefinitions).find((r) => r.id === researchId);
            if (!research) return;
            if (research.effects.populationBonus) {
              effects.populationBonus *= research.effects.populationBonus;
            }
            if (research.effects.emissionsReduction) {
              effects.emissionsReduction += research.effects.emissionsReduction;
            }
            if (research.effects.tradeBonus) {
              effects.tradeBonus *= research.effects.tradeBonus;
            }
          });
          return effects;
        }

        function getTradeBonus() {
          let bonus = getResearchEffects().tradeBonus || 1.0;
          const buildGrid = document.getElementById('build-grid');
          if (buildGrid) {
            const orbitalYards = buildGrid.querySelectorAll('[data-building="orbital-shipyard"]').length;
            bonus += orbitalYards * 0.05;
          }
          if (factionState?.trade?.relation >= 60) {
            bonus += (factionState.trade.effects?.tradeBonus || 0);
          }
          return Math.max(0.5, bonus);
        }

        function getCombinedEffects() {
          const combined = {
            supply: 0,
            energy: 0,
            water: 0,
            emissions: 0,
            population: 0
          };
          activeEffects.forEach((effect) => {
            Object.keys(combined).forEach((key) => {
              if (typeof effect.effects?.[key] === "number") {
                combined[key] += effect.effects[key];
              }
            });
          });
          return combined;
        }

        function tickActiveEffects(days) {
          if (!activeEffects.length) return;
          activeEffects.forEach((effect) => {
            effect.remainingDays -= days;
          });
          for (let i = activeEffects.length - 1; i >= 0; i -= 1) {
            if (activeEffects[i].remainingDays <= 0) {
              activeEffects.splice(i, 1);
            }
          }
          updateEffectsPanel();
        }

        // 1.4 Gebäude-Effekte auf KPIs
        function calculateColonyKPIs(planet, buildings = []) {
          const rng = mulberry32(hashSeed(planet.seed));
          const oceanPct = parseInt(String(planet.ocean).replace("%", ""), 10) || 0;
          
          const clamp = (value) => Math.min(100, Math.max(0, value));

          const effects = getCombinedEffects();
          const researchEffects = getResearchEffects();

          // Basis-Werte aus Planet
          const basePop = planet.size === "Zwerg" ? 60000 : planet.size === "Standard" ? 128000 : planet.size === "Gross" ? 220000 : 380000;
          const climatePenalty = planet.climate === "Polar" ? 0.85 : planet.climate === "Vulkanisch" ? 0.9 : planet.climate === "Arid" ? 0.88 : planet.climate === "Stuermisch" ? 0.92 : planet.climate === "Tropisch" ? 0.98 : 1.0;
          
          // Zähle Gebäude
          const buildingCounts = {};
          buildings.forEach(b => {
            buildingCounts[b.building] = (buildingCounts[b.building] || 0) + 1;
          });
          
          // Emissionen aus Gebäuden
          let totalEmissions = 0;
          Object.entries(buildingCounts).forEach(([type, count]) => {
            const building = buildingDefinitions[type];
            if (building && building.emissions) {
              totalEmissions += building.emissions * count;
            }
          });
          let emissions = clamp(12 + totalEmissions * 2 + (planet.resources === "Erzreich" ? 8 : 0));
          if (researchEffects.emissionsReduction > 0) {
            emissions = clamp(emissions * (1 - researchEffects.emissionsReduction));
          }
          if (factionState?.eco?.relation >= 50) {
            emissions = clamp(emissions * (1 - (factionState.eco.effects?.emissionsReduction || 0)));
          }

          // Ressourcen-basierte KPIs
          const waterRatio = resourceState.storageCapacity.water ? (getResource("water") / resourceState.storageCapacity.water) * 100 : 0;
          const energyRatio = resourceState.storageCapacity.energy ? (getResource("energy") / resourceState.storageCapacity.energy) * 100 : 0;
          const foodRatio = resourceState.storageCapacity.food ? (getResource("food") / resourceState.storageCapacity.food) * 100 : 0;

          let water = clamp(waterRatio);
          if (planet.climate === "Arid") water = clamp(water - 15);
          if (planet.climate === "Polar") water = clamp(water - 8);
          if (planet.climate === "Tropisch") water = clamp(water + 8);
          if (oceanPct >= 70) water = clamp(water + 6);

          let energy = clamp(energyRatio);
          let supply = clamp(foodRatio);
          if (planet.hazard.includes("Sturm")) supply = clamp(supply - 8);

          if (effects.water) water = clamp(water * (1 + effects.water));
          if (effects.energy) energy = clamp(energy * (1 + effects.energy));
          if (effects.supply) supply = clamp(supply * (1 + effects.supply));
          if (effects.emissions) emissions = clamp(emissions * (1 + effects.emissions));

          // Berechne Bevölkerung
          let totalPopulation = 0;
          Object.entries(buildingCounts).forEach(([type, count]) => {
            const building = buildingDefinitions[type];
            if (building && building.population) {
              totalPopulation += building.population * count;
            }
          });
          let pop = Math.round(basePop * climatePenalty * (0.85 + rng() * 0.4) + totalPopulation);
          if (researchEffects.populationBonus > 1) {
            pop = Math.round(pop * researchEffects.populationBonus);
          }
          if (effects.population) {
            pop = Math.round(pop * (1 + effects.population));
          }
          
          // Berechne Zufriedenheit
          const satisfaction = Math.round(clamp(40 + supply * 0.45 - emissions * 0.15 + (energy > 50 ? 10 : 0) + (water > 50 ? 5 : 0) + rng() * 12));
          
          const stage = pop > 280000 ? "Ingenieure" : pop > 140000 ? "Kolonisten" : pop > 80000 ? "Pioniere" : "Siedler";
          const bottleneck = water < 35 ? "Wasser" : energy < 35 ? "Energie" : supply < 55 ? "Nahrung" : emissions > 60 ? "Emissionen" : "Keiner";
          const sectors = parseInt(planet.sectors, 10) || 12;
          const tradeBase = Math.round(400 + rng() * 1200);
          const tradeVolume = Math.round((tradeBase + tradeState.totalExported) * getTradeBonus());
          
          return {
            population: pop,
            stage,
            supply,
            satisfaction,
            emissions,
            emissionsLimit: 60,
            energy,
            water,
            bottleneck,
            sectors,
            tradeVolume,
            rng
          };
        }

        const updateTimeDisplay = () => {
          const el = document.getElementById("sim-time");
          if (el) el.textContent = `Tag ${simState.day}, Jahr ${simState.year}`;
        };

        const simTick = () => {
          if (simState.paused) return;
          const daysToAdvance = simState.speed;
          for (let step = 0; step < daysToAdvance; step += 1) {
            simState.day += 1;
            if (simState.day > 365) {
              simState.day = 1;
              simState.year += 1;
            }

            tickActiveEffects(1);

            if (simState.day % 10 === 0) {
              researchPoints += generateResearchPoints();
              // Forschung wird nur manuell verarbeitet, nicht automatisch
              // processResearchQueue(); // Entfernt - nur manuell
            }

            if (simState.nextEventIn <= 0) {
              const event = generateRandomEvent();
              processEvent(event);
              simState.nextEventIn = 30 + Math.floor(Math.random() * 30);
            }
            simState.nextEventIn -= 1;
          }

          updateResourceFlows(daysToAdvance);
          updateStorageCapacity();

          routeState.routes.forEach(route => {
            processRouteTransport(route, daysToAdvance);
          });
          updateRouteUI();
          
          // KI-Gegner aktualisieren
          updateAIOpponents();

          updateTimeDisplay();
          updateResearchUI();
          refreshColonyUI();
          updateMilitaryPanel();
        };

        const startSimulation = () => {
          if (simState.tickInterval) clearInterval(simState.tickInterval);
          simState.tickInterval = setInterval(simTick, 1000);
        };

        const setupSimulationControls = () => {
          const pause = document.getElementById("sim-pause");
          const b1 = document.getElementById("sim-1x");
          const b4 = document.getElementById("sim-4x");
          const b10 = document.getElementById("sim-10x");
          if (!pause || !b1 || !b4 || !b10) return;

          const setPressed = (active) => {
            [b1, b4, b10].forEach((b) => b.setAttribute("aria-pressed", b === active ? "true" : "false"));
          };

          pause.addEventListener("click", () => {
            simState.paused = !simState.paused;
            pause.setAttribute("aria-pressed", simState.paused ? "true" : "false");
            pause.textContent = simState.paused ? "Weiter" : "Pause";
            toast({ type: "info", title: "Simulation", message: simState.paused ? "Pausiert." : "Fortgesetzt." });
          });
          
          b1.addEventListener("click", () => { simState.speed = 1; setPressed(b1); toast({ type: "info", title: "Speed", message: "1×" }); });
          b4.addEventListener("click", () => { simState.speed = 4; setPressed(b4); toast({ type: "info", title: "Speed", message: "4×" }); });
          b10.addEventListener("click", () => { simState.speed = 10; setPressed(b10); toast({ type: "info", title: "Speed", message: "10×" }); });
          
          updateTimeDisplay();
          // Simulation startet pausiert - wird erst nach Tutorial gestartet
          if (tutorialCompleted) {
            simState.paused = false;
            pause.setAttribute("aria-pressed", "false");
            pause.textContent = "Pause";
            startSimulation();
          } else {
            pause.setAttribute("aria-pressed", "true");
            pause.textContent = "Weiter";
          }
          
          // Initialisiere alle Systeme
          updateStorageCapacity();
          updateResourcePanel();
          updateEffectsPanel();
          updateResearchUI();
          refreshColonyUI();
        };

        // 2.4 Research-UI aktualisieren
        const renderResearchTree = () => {
          const tree = document.querySelector('.research-tree');
          if (!tree) return;
          
          // Aktualisiere Research-Nodes basierend auf researchDefinitions
          const nodes = tree.querySelectorAll('.research-node');
          nodes.forEach(node => {
            const titleEl = node.querySelector('.node-title');
            if (!titleEl) return;
            
            const title = titleEl.textContent.trim();
            const research = getResearchByTitle(title);
            
            if (research) {
              // Update Status
              if (research.unlocked) {
                node.classList.add('unlocked');
                node.classList.remove('available', 'locked');
                const statusEl = node.querySelector('.node-status');
                if (statusEl) statusEl.textContent = '✓';
                const costEl = node.querySelector('.node-cost');
                if (costEl) costEl.textContent = '✓ Erforscht';
              } else if (canAffordResearch(research.id)) {
                node.classList.add('available');
                node.classList.remove('unlocked', 'locked');
                const costEl = node.querySelector('.node-cost');
                if (costEl) costEl.textContent = `${research.cost} Forschung`;
              } else {
                node.classList.add('locked');
                node.classList.remove('unlocked', 'available');
                const costEl = node.querySelector('.node-cost');
                if (costEl) costEl.textContent = `${research.cost} Forschung`;
              }

              node.dataset.researchId = research.id;
              if (research.requirements?.length) {
                node.dataset.prereq = research.requirements.join(',');
              } else {
                node.removeAttribute('data-prereq');
              }
              node.classList.toggle('queued', researchQueue.includes(research.id));
              
              // Add progress bar if not exists
              if (!node.querySelector('.research-progress')) {
                const prog = document.createElement('div');
                prog.className = 'research-progress';
                prog.innerHTML = '<span></span>';
                node.appendChild(prog);
              }
            }
          });
        };

        const updateResearchUI = () => {
          const researchSection = document.querySelector('#research');
          if (!researchSection) return;
          
          let pointsDisplay = researchSection.querySelector('.research-points-display');
          if (!pointsDisplay) {
            pointsDisplay = document.createElement('div');
            pointsDisplay.className = 'research-points-display';
            pointsDisplay.style.cssText = 'padding: 12px; background: var(--panel); border-radius: 10px; margin-bottom: 16px; text-align: center;';
            researchSection.querySelector('.research-tree')?.parentElement?.insertBefore(pointsDisplay, researchSection.querySelector('.research-tree'));
          }
          pointsDisplay.innerHTML = `<strong>Forschungspunkte: ${researchPoints}</strong>`;
          renderResearchTree();
          updateResearchQueueUI();
        };

        const updateResearchQueueUI = () => {
          const queueList = document.getElementById('research-queue-list');
          const queuePoints = document.getElementById('research-queue-points');
          const queueEmpty = document.getElementById('research-queue-empty');
          if (!queueList || !queuePoints || !queueEmpty) return;

          queuePoints.textContent = `Punkte: ${researchPoints}`;
          if (!researchQueue.length) {
            queueList.innerHTML = '';
            queueEmpty.hidden = false;
            return;
          }
          queueEmpty.hidden = true;
          queueList.innerHTML = researchQueue
            .map((id, index) => {
              const research = getResearchById(id);
              if (!research) return '';
              const title = getResearchTitleById(id) || research.id;
              const remaining = Math.max(0, research.cost - researchPoints);
              const statusLabel =
                index === 0
                  ? remaining > 0
                    ? `${remaining} Punkte fehlen`
                    : 'Bereit'
                  : `Position ${index + 1}`;
              return `
                <div class="research-queue-item ${index === 0 ? 'active' : ''}" data-research-id="${id}">
                  <div class="queue-info">
                    <strong>${title}</strong>
                    <span>${research.cost} Punkte</span>
                  </div>
                  <div class="queue-meta">
                    <span class="queue-remaining">${statusLabel}</span>
                    <button type="button" class="seed-button secondary tiny" data-action="cancel">Abbrechen</button>
                  </div>
                </div>
              `;
            })
            .join('');
        };

        const processResearchQueue = () => {
          let updated = false;
          while (researchQueue.length > 0) {
            const nextId = researchQueue[0];
            const research = getResearchById(nextId);
            if (!research) {
              researchQueue.shift();
              updated = true;
              continue;
            }
            if (!canAffordResearch(research.id)) break;
            researchQueue.shift();
            unlockResearch(research.id);
            updated = true;
          }
          updateResearchQueueUI();
          if (updated) {
            updateResearchUI();
          }
        };

        const updateResearchDepsPanel = (research) => {
          const panel = document.getElementById('research-deps');
          if (!panel) return;
          const list = panel.querySelector('.research-deps-list');
          if (!list) return;
          if (!research) {
            list.innerHTML = '<span>Wähle eine Forschung, um Details anzuzeigen.</span>';
            return;
          }
          const requirements = research.requirements || [];
          if (!requirements.length) {
            list.innerHTML = '<span>Keine Voraussetzungen.</span>';
            return;
          }
          list.innerHTML = requirements
            .map((req) => {
              const title = getResearchTitleById(req) || req;
              const fulfilled = unlockedResearch.includes(req);
              return `<div><span>${title}</span><span class="state-${fulfilled ? 'fulfilled' : 'missing'}">${fulfilled ? '✓ Freigeschaltet' : '✕ Fehlend'}</span></div>`;
            })
            .join('');
        };

        const setupResearchQueueActions = () => {
          const queueList = document.getElementById('research-queue-list');
          if (!queueList || queueList.dataset.listenerAttached === 'true') return;
          queueList.addEventListener('click', (event) => {
            const button = event.target.closest('button[data-action="cancel"]');
            if (!button) return;
            const item = button.closest('.research-queue-item');
            if (!item) return;
            const id = item.dataset.researchId;
            if (!id) return;
            researchQueue = researchQueue.filter((rid) => rid !== id);
            updateResearchQueueUI();
          });
          queueList.dataset.listenerAttached = 'true';
        };

        // Research Tree interactions with dependencies
        const setupResearch = () => {
          renderResearchTree();
          const tree = document.querySelector('.research-tree');
          if (!tree) return;
          setupResearchQueueActions();
          updateResearchDepsPanel(null);

          tree.addEventListener('click', (event) => {
            const node = event.target.closest('.research-node');
            if (!node) return;
            const titleEl = node.querySelector('.node-title');
            const title = titleEl?.textContent?.trim();
            const research = getResearchByTitle(title);
            if (!research || research.unlocked) return;

            if (canAffordResearch(research.id)) {
              unlockResearch(research.id);
              processResearchQueue();
              return;
            }

            if (!canQueueResearch(research.id)) {
              toast({ type: 'warning', title: 'Voraussetzungen fehlen', message: 'Schalte zuerst andere Technologien frei.' });
              return;
            }

            if (researchQueue.includes(research.id)) {
              toast({ type: 'info', title: 'Bereits geplant', message: `${title} steht in der Warteschlange.` });
              return;
            }

            researchQueue.push(research.id);
            toast({ type: 'info', title: 'Forschung eingeplant', message: `${title} wird ausgeführt sobald Punkte vorhanden sind.` });
            updateResearchQueueUI();
          });

          tree.addEventListener('pointerover', (event) => {
            const node = event.target.closest('.research-node');
            if (!node) return;
            const title = node.querySelector('.node-title')?.textContent?.trim();
            const research = getResearchByTitle(title);
            updateResearchDepsPanel(research);
          });

          tree.addEventListener('pointerout', (event) => {
            if (!tree.contains(event.relatedTarget)) {
              updateResearchDepsPanel(null);
            }
          });

          updateResearchUI();
        };

        // ===== PHASE 3: EVENTS & DYNAMIK =====
        
        // 3.1 Katastrophen-System funktional
        let pendingEvent = null;

        const catastropheTypes = {
          meteor: {
            name: 'Meteoriteneinschlag',
            icon: '☄️',
            effects: {
              population: -0.3,
              buildings: -0.2,
              resources: { regolith: 0.2, metal: 0.1 }
            },
            duration: 1,
            description: 'Zerstört Infrastruktur, neue Erzvorkommen'
          },
          volcano: {
            name: 'Supervulkan',
            icon: '🌋',
            effects: {
              emissions: 0.4,
              temperature: 0.15,
              resources: { regolith: 0.3 }
            },
            duration: 3,
            description: 'CO₂-Anstieg, Temperaturänderung, Asche'
          },
          storm: {
            name: 'Megasturm',
            icon: '🌪️',
            effects: {
              supply: -0.25,
              buildings: -0.15,
              energy: -0.2
            },
            duration: 2,
            description: 'Logistik unterbrochen, Gebäudeschäden'
          },
          solar: {
            name: 'Sonneneruption',
            icon: '☀️',
            effects: {
              energy: -0.5,
              buildings: -0.1
            },
            duration: 1,
            description: 'Elektronik ausgefallen, Strahlung'
          }
        };

        const addActiveEffect = (label, effects, durationDays) => {
          if (!durationDays || durationDays <= 0) return;
          activeEffects.push({
            id: `${label}-${Date.now()}`,
            label,
            effects,
            remainingDays: durationDays
          });
          updateEffectsPanel();
        };

        const triggerCatastrophe = (type, sector = 'Nordkuppe 07') => {
          const catastrophe = catastropheTypes[type];
          if (!catastrophe) return false;
          
          toast({ type: 'danger', title: `⚠️ ${catastrophe.name}`, message: `Katastrophe in ${sector}!` });
          
          applyCatastropheEffects(catastrophe);
          
          return true;
        };

        const applyCatastropheEffects = (catastrophe) => {
          // Effekte auf Ressourcen
          if (catastrophe.effects.resources) {
            Object.entries(catastrophe.effects.resources).forEach(([resource, multiplier]) => {
              const current = getResource(resource);
              const change = Math.round(current * multiplier);
              addResource(resource, change);
            });
          }
          
          // Effekte auf KPIs (zeitlich begrenzt)
          const kpiEffects = {};
          ['population', 'supply', 'energy', 'water', 'emissions'].forEach((key) => {
            if (typeof catastrophe.effects[key] === 'number') {
              kpiEffects[key] = catastrophe.effects[key];
            }
          });
          if (Object.keys(kpiEffects).length) {
            addActiveEffect(catastrophe.name, kpiEffects, catastrophe.duration);
          }
          
          // Gebäude-Schäden
          if (catastrophe.effects.buildings) {
            const buildGrid = document.getElementById('build-grid');
            if (buildGrid) {
              const buildings = buildGrid.querySelectorAll('.build-cell[data-building]');
              const damageCount = Math.max(1, Math.floor(buildings.length * Math.abs(catastrophe.effects.buildings)));
              
              for (let i = 0; i < damageCount && i < buildings.length; i++) {
                const randomIndex = Math.floor(Math.random() * buildings.length);
                const building = buildings[randomIndex];
                if (building && building.dataset.building) {
                  building.removeAttribute('data-building');
                  building.classList.remove('occupied');
                  building.innerHTML = '';
                }
              }
              
                toast({ type: 'warning', title: 'Gebäudeschäden', message: `${damageCount} Gebäude wurden beschädigt.` });
            }
          }
        };

        const simulateCatastrophe = (type) => {
          const catastrophe = catastropheTypes[type];
          if (!catastrophe) return;
          
          const preview = document.querySelector('.catastrophe-preview');
          if (preview) {
            preview.querySelector('h3').textContent = `Vorschau: ${catastrophe.name}`;
            preview.querySelector('.lead').textContent = 'Sektor Nordkuppe 07';
            
            // Update preview comparison
            const beforeState = preview.querySelector('.preview-state:first-child');
            const afterState = preview.querySelector('.preview-state:last-child');
            
            if (beforeState && afterState) {
              // Simuliere Effekte
              const currentPop = 24500;
              const newPop = Math.round(currentPop * (1 + (catastrophe.effects.population || 0)));
              
              afterState.innerHTML = `
                <h5>Nachher</h5>
                <div class="stat ${catastrophe.effects.population < 0 ? 'negative' : ''}">
                  <span>Bevölkerung</span>
                  <span>${catastrophe.effects.population < 0 ? '-' : '+'}${Math.abs(newPop - currentPop)} ${catastrophe.effects.population < 0 ? '⚠️' : '📈'}</span>
                </div>
                <div class="stat ${catastrophe.effects.buildings < 0 ? 'negative' : ''}">
                  <span>Gebäude</span>
                  <span>${catastrophe.effects.buildings < 0 ? '-' : '+'}${Math.round(12 * Math.abs(catastrophe.effects.buildings || 0))}</span>
                </div>
                ${catastrophe.effects.resources ? Object.entries(catastrophe.effects.resources).map(([res, mult]) => `
                  <div class="stat positive">
                    <span>${res}</span>
                    <span>+${Math.round(mult * 100)}% 📈</span>
                  </div>
                `).join('') : ''}
              `;
            }
          }
        };

        // 3.2 Zufällige Events-System
        const eventTypes = {
          resourceBoom: {
            name: 'Ressourcen-Boom',
            icon: '💎',
            effects: { resources: { metal: 500, regolith: 300 } },
            message: 'Neue Erzvorkommen entdeckt!',
            duration: 0
          },
          weatherStorm: {
            name: 'Staubsturm',
            icon: '🌪️',
            effects: { energy: -0.2, supply: -0.15 },
            message: 'Staubsturm beeinträchtigt Produktion.',
            duration: 3
          },
          weatherDrought: {
            name: 'Dürre',
            icon: '☀️',
            effects: { water: -0.3, food: -0.2 },
            message: 'Wassermangel durch Dürre.',
            duration: 4
          },
          techBreakthrough: {
            name: 'Technologie-Durchbruch',
            icon: '🔬',
            effects: { researchPoints: 500 },
            message: 'Bonus-Forschungspunkte erhalten!',
            duration: 0
          },
          tradeOffer: {
            name: 'Handelsangebot',
            icon: '🤝',
            effects: { trade: { metal: 100, cost: { food: 50 } } },
            message: 'NPC-Fraktion bietet Handel an.',
            duration: 0,
            choices: [
              { label: 'Annehmen (+Metall, -Nahrung)', tooltip: '+100 Metall, -50 Nahrung', effects: { trade: { metal: 100, cost: { food: 50 } } } },
              { label: 'Ablehnen (Relation -)', tooltip: '-5 Beziehung Handel', effects: { factions: { trade: -5 } } }
            ]
          },
          meteorShower: {
            name: 'Meteorschauer',
            icon: '☄️',
            effects: { resources: { regolith: 200 }, buildings: -0.1 },
            message: 'Meteorschauer bringt neue Ressourcen.',
            duration: 2
          },
          diplomaticOffer: {
            name: 'Diplomatische Anfrage',
            icon: '🕊️',
            message: 'Eine Fraktion bietet ein Forschungsabkommen an.',
            duration: 0,
            choices: [
              { label: 'Annehmen (+Beziehung, +Forschung)', tooltip: '+10 Tech, +300 FP', effects: { factions: { tech: 10 }, researchPoints: 300 } },
              { label: 'Ablehnen (Beziehung -)', tooltip: '-10 Tech', effects: { factions: { tech: -10 } } }
            ]
          }
        };

        const generateRandomEvent = () => {
          const rng = mulberry32(hashSeed(getGameState().seed + simState.day));
          const eventKeys = Object.keys(eventTypes);
          const randomKey = eventKeys[Math.floor(rng() * eventKeys.length)];
          return { ...eventTypes[randomKey], id: randomKey };
        };

        const applyEventEffects = (effects = {}, name = 'Ereignis', duration = 0) => {
          if (effects.resources) {
            Object.entries(effects.resources).forEach(([resource, amount]) => {
              addResource(resource, amount);
            });
          }
          
          if (effects.researchPoints) {
            researchPoints += effects.researchPoints;
          }

          if (effects.trade) {
            const { metal, cost } = effects.trade;
            const canPay = Object.entries(cost || {}).every(([res, amount]) => getResource(res) >= amount);
            if (canPay) {
              Object.entries(cost || {}).forEach(([res, amount]) => consumeResource(res, amount));
              addResource('metal', metal || 0);
              tradeState.totalExported += metal || 0;
            }
          }

          if (effects.factions) {
            Object.entries(effects.factions).forEach(([faction, delta]) => {
              updateFactionRelations(faction, delta);
            });
          }

          const kpiEffects = {};
          if (typeof effects.energy === 'number') kpiEffects.energy = effects.energy;
          if (typeof effects.water === 'number') kpiEffects.water = effects.water;
          if (typeof effects.supply === 'number') kpiEffects.supply = effects.supply;
          if (typeof effects.food === 'number') kpiEffects.supply = (kpiEffects.supply || 0) + effects.food;
          if (Object.keys(kpiEffects).length && (duration > 0 || effects.duration > 0)) {
            addActiveEffect(name, kpiEffects, duration || effects.duration);
          }
          
          if (effects.buildings) {
            const buildGrid = document.getElementById('build-grid');
            if (buildGrid) {
              const buildings = buildGrid.querySelectorAll('.build-cell[data-building]');
              const damageCount = Math.max(1, Math.floor(buildings.length * Math.abs(effects.buildings)));
              
              for (let i = 0; i < damageCount && i < buildings.length; i++) {
                const randomIndex = Math.floor(Math.random() * buildings.length);
                const building = buildings[randomIndex];
                if (building && building.dataset.building) {
                  building.removeAttribute('data-building');
                  building.classList.remove('occupied');
                  building.innerHTML = '';
                }
              }
            }
          }
        };

        const showEventOverlay = (event) => {
          const overlay = document.getElementById('event-overlay');
          const titleEl = document.getElementById('event-title');
          const bodyEl = document.getElementById('event-body');
          const choicesEl = document.getElementById('event-choices');
          if (!overlay || !titleEl || !bodyEl || !choicesEl) return;
          overlay.classList.add('is-open');
          titleEl.textContent = `${event.icon || ''} ${event.name}`;
          bodyEl.textContent = event.message || 'Ereignis';
          choicesEl.innerHTML = (event.choices || [])
            .map((choice, idx) => `<button type="button" class="event-choice" data-choice-index="${idx}"><span>${choice.label}</span><span>${choice.tooltip || ''}</span></button>`)
            .join('');
        };

        const closeEventOverlay = () => {
          const overlay = document.getElementById('event-overlay');
          if (overlay) overlay.classList.remove('is-open');
        };

        const handleEventChoice = (choice, baseEvent) => {
          if (!choice) return;
          applyEventEffects(choice.effects || {}, choice.label || baseEvent.name, choice.duration || baseEvent.duration || 0);
          showEventNotification(baseEvent);
          closeEventOverlay();
          pendingEvent = null;
          updateResourcePanel();
          updateEffectsPanel();
          refreshColonyUI();
        };

        const processEvent = (event) => {
          if (event.choices && event.choices.length) {
            pendingEvent = event;
            showEventOverlay(event);
            return;
          }
          applyEventEffects(event.effects || {}, event.name, event.duration);
          showEventNotification(event);
          updateResourcePanel();
          updateEffectsPanel();
          refreshColonyUI();
        };

        const showEventNotification = (event) => {
          toast({ 
            type: event.effects.resources && Object.values(event.effects.resources).some(v => v > 0) ? 'success' : 'warning',
            title: `${event.icon} ${event.name}`,
            message: event.message,
            timeout: 5000
          });
        };

        // 3.3 Handelsrouten-Funktionalität
        const routeState = {
          routes: [],
          nextRouteId: 1,
          initialized: false
        };

        const parseRouteMeta = (text) => {
          const match = text.match(/(\d+)\s*d\s*\/\s*(\d+)\s*t/i);
          if (!match) return { distance: null, capacity: null };
          return {
            distance: parseInt(match[1], 10),
            capacity: parseInt(match[2], 10)
          };
        };

        const initRouteStateFromDOM = () => {
          if (routeState.initialized) return;
          const list = document.querySelector("#panel-handel .route-list");
          if (!list) return;

          const items = Array.from(list.querySelectorAll(".route"));
          if (!items.length) return;

          items.forEach((routeEl) => {
            const spans = routeEl.querySelectorAll("span");
            const routeText = spans[0]?.textContent || "";
            const routeMeta = spans[1]?.textContent || "";
            const [fromRaw, toRaw] = routeText.split("→");
            const from = (fromRaw || "").trim();
            const to = (toRaw || "").trim();
            if (!from || !to) return;

            const { distance, capacity } = parseRouteMeta(routeMeta);
            const fallbackCapacity = capacity || 80;
            createRoute(from, to, {
              distance,
              capacity,
              cargoType: "metal",
              cargoAmount: Math.min(80, fallbackCapacity)
            });
          });

          routeState.initialized = true;
        };

        const createRoute = (from, to, options = {}) => {
          const { distance = null, capacity = null, cargoType = 'metal', cargoAmount = null } = options;
          const seedInput = document.getElementById('seed-input');
          const seed = seedInput?.value || 'DEFAULT';
          const planet = generatePlanet(seed);
          const colony = deriveColonyFromPlanet(planet);
          
          // Berechne Distanz und Kapazität wenn nicht angegeben
          let finalDistance = distance;
          let finalCapacity = capacity;
          if (finalDistance === null) {
            const grav = parseFloat(String(planet.gravity).replace(" g", "")) || 1.0;
            const hazardSlow = planet.hazard.includes("Sturm") ? 1.15 : planet.hazard.includes("Magnet") ? 1.08 : 1.0;
            finalDistance = Math.round((4 + Math.random() * 5) * grav * hazardSlow);
          }
          
          if (finalCapacity === null) {
            finalCapacity = Math.round(60 + colony.tradeVolume / 10);
          }

          finalCapacity = Math.round(finalCapacity * getTradeBonus());
          const finalCargoAmount = Math.min(finalCapacity, cargoAmount || finalCapacity);
          
          const route = {
            id: routeState.nextRouteId++,
            from,
            to,
            distance: finalDistance,
            capacity: finalCapacity,
            cargoType,
            cargoAmount: finalCargoAmount,
            cargo: null,
            inTransit: false,
            progress: 0
          };

          route.editorOpen = false;
          
          routeState.routes.push(route);
          return route;
        };

        const calculateRouteTime = (route) => {
          return route.distance; // In Tagen
        };

        const processRouteTransport = (route, days = 1) => {
          const routeDistance = Math.max(1, route.distance || 1);
          route.distance = routeDistance;
          const tryLoadCargo = () => {
            const available = getResource(route.cargoType);
            const amount = Math.min(route.cargoAmount || route.capacity, available);
            if (amount <= 0) return false;
            route.cargo = { type: route.cargoType, amount };
            consumeResource(route.cargoType, amount);
            route.inTransit = true;
            route.progress = 0;
            return true;
          };

          let remainingDays = days;

          if (!route.inTransit) {
            tryLoadCargo();
          }

          while (route.inTransit && remainingDays > 0) {
            route.progress += remainingDays;
            if (route.progress < route.distance) {
              remainingDays = 0;
              break;
            }

            const overflow = route.progress - route.distance;
            route.inTransit = false;
            route.progress = 0;
            if (route.cargo) {
              addResource(route.cargo.type, route.cargo.amount);
              tradeState.totalExported += route.cargo.amount;
              tradeState.completedRoutes += 1;
            }
            route.cargo = null;
            toast({ type: 'success', title: 'Transport abgeschlossen', message: `Route ${route.from} → ${route.to} geliefert.` });

            remainingDays = overflow;
            if (remainingDays > 0) {
              tryLoadCargo();
            }
          }
        };

        const renderRouteEditorFields = (route) => {
          const cargoOptions = Object.entries(resourceDefinitions)
            .map(([key, info]) => {
              const selected = key === (route.cargoType || "metal") ? "selected" : "";
              return `<option value="${key}" ${selected}>${info.icon} ${info.label}</option>`;
            })
            .join("");

          const distance = Math.max(1, route.distance || 1);
          const capacity = Math.max(1, route.capacity || route.cargoAmount || 80);

          return `
            <div class="route-editor-grid">
              <label>
                Von
                <input type="text" name="route-from" value="${escapeHTML(route.from || "")}" />
              </label>
              <label>
                Nach
                <input type="text" name="route-to" value="${escapeHTML(route.to || "")}" />
              </label>
              <label>
                Ladung
                <select name="route-cargo">
                  ${cargoOptions}
                </select>
              </label>
              <label>
                Menge
                <input type="number" name="route-cargo-amount" min="10" max="${capacity}" value="${route.cargoAmount || 10}" />
              </label>
              <label>
                Distanz (Tage)
                <input type="number" name="route-distance" min="1" max="30" value="${distance}" />
              </label>
              <label>
                Kapazität
                <input type="number" name="route-capacity" min="10" max="800" value="${capacity}" />
              </label>
            </div>
            <div class="route-editor-actions">
              <button type="button" class="seed-button" data-action="save-edit">Speichern</button>
              <button type="button" class="seed-button secondary" data-action="cancel-edit">Abbrechen</button>
            </div>
          `;
        };

        const updateRouteUI = () => {
          const list = document.querySelector("#panel-handel .route-list");
          if (!list) return;
          if (!routeState.initialized) {
            initRouteStateFromDOM();
          }

          list.innerHTML = routeState.routes
            .map((route) => {
              if (!route.cargoType) route.cargoType = "metal";
              if (!route.cargoAmount) route.cargoAmount = Math.min(80, route.capacity || 80);
              const distance = Math.max(1, route.distance || 1);
              const capacity = Math.max(1, route.capacity || route.cargoAmount || 80);
              const progressPct = Math.min(100, Math.round(((route.progress || 0) / distance) * 100));
              const status = route.inTransit ? "Unterwegs" : "Bereit";
              const cargoLabel = resourceDefinitions[route.cargoType]?.label || route.cargoType;
              const cargoUnit = resourceDefinitions[route.cargoType]?.unit || "t";
              const cargoIcon = resourceDefinitions[route.cargoType]?.icon || "";
              const cargoInfo = `${cargoIcon} ${cargoLabel} ${route.cargoAmount}${cargoUnit}`;

              return `
                <div class="route editable ${route.inTransit ? "in-transit" : ""}" data-route-id="${route.id}">
                  <div class="route-main">
                    <div class="route-title">
                      ${escapeHTML(route.from || "Unbenannt")} → ${escapeHTML(route.to || "Ziel")}
                    </div>
                    <div class="route-meta">
                      <div class="route-progress" role="progressbar" aria-valuemin="0" aria-valuemax="${distance}" aria-valuenow="${Math.min(route.progress || 0, distance)}">
                        <span style="width:${progressPct}%"></span>
                      </div>
                      <span class="route-cargo">${escapeHTML(cargoInfo)}</span>
                      <span class="route-status">${status}</span>
                    </div>
                  </div>
                  <div class="route-actions">
                    <button type="button" class="route-action" data-action="edit-toggle">${route.editorOpen ? "Schließen" : "✏️ Bearbeiten"}</button>
                    <button type="button" class="route-action delete" data-action="delete">🗑️</button>
                  </div>
                  <div class="route-inline-editor ${route.editorOpen ? "" : "is-hidden"}">
                    ${renderRouteEditorFields(route)}
                  </div>
                </div>
              `;
            })
            .join("");
          
          setupRouteActions();
        };

        // 3.4 Diplomatie-Effekte
        const updateFactionRelations = (faction, change) => {
          if (!factionState[faction]) return;
          
          factionState[faction].relation = Math.max(0, Math.min(100, factionState[faction].relation + change));
          
          // Update UI
          const factionCard = document.querySelector(`[data-faction="${faction}"]`);
          if (factionCard) {
            const relationValue = factionCard.querySelector('.relation-value');
            const relationFill = factionCard.querySelector('.relation-fill');
            if (relationValue) relationValue.textContent = `${factionState[faction].relation}%`;
            if (relationFill) {
              relationFill.style.width = `${factionState[faction].relation}%`;
              const status = factionState[faction].relation >= 70 ? 'friendly' : factionState[faction].relation >= 40 ? 'neutral' : 'hostile';
              relationFill.className = `relation-fill ${status}`;
              const statusEl = factionCard.querySelector('.relation-status');
              if (statusEl) {
                statusEl.textContent = status === 'friendly' ? 'Freundlich' : status === 'neutral' ? 'Neutral' : 'Feindlich';
              }
            }
          }
        };

        const applyFactionEffects = () => {
          // Research-Bonus von Technokraten
          if (factionState.tech.relation >= 70 && factionState.tech.treaties.includes('Forschungsabkommen')) {
            // Bonus wird in generateResearchPoints angewendet
          }
          
          // Trade-Bonus von Handelsgilde
          if (factionState.trade.relation >= 60) {
            // Bonus wird in Route-Transport angewendet
          }
          
          // Emissions-Reduktion von Öko-Kollektiv
          if (factionState.eco.relation >= 50) {
            // Bonus wird in calculateColonyKPIs angewendet
          }
        };

        const negotiateTreaty = (faction, treatyType) => {
          if (!factionState[faction]) return false;
          
          if (factionState[faction].relation < 60) {
            toast({ type: 'warning', title: 'Beziehung zu niedrig', message: 'Mindestens 60% Beziehung erforderlich.' });
            return false;
          }
          
          if (!factionState[faction].treaties.includes(treatyType)) {
            factionState[faction].treaties.push(treatyType);
            toast({ type: 'success', title: 'Vertrag abgeschlossen', message: `${treatyType} mit ${factionState[faction].name}` });
            return true;
          }
          
          return false;
        };

        // setupDiplomacy ist bereits weiter unten definiert (Zeile 9056)

        // Settings
        const getSettings = () => ({
          volume: parseInt(document.getElementById('setting-volume')?.value || 70),
          music: document.getElementById('setting-music')?.checked ?? true,
          scale: parseFloat(document.getElementById('setting-scale')?.value || 1),
          reducedMotion: document.getElementById('setting-reduced-motion')?.checked ?? false,
          autoDark: document.getElementById('setting-auto-dark')?.checked ?? false,
          autoPause: document.getElementById('setting-auto-pause')?.checked ?? true,
          notifications: document.getElementById('setting-notifications')?.checked ?? true
        });

        const saveSettings = () => {
          try {
            localStorage.setItem(saveKeyForUser(authState.user, 'settings'), JSON.stringify(getSettings()));
          } catch (e) {
            console.warn('Failed to save settings:', e);
          }
        };

        const applySettings = (s) => {
          if (!s) return;
          const volumeInput = document.getElementById('setting-volume');
          if (volumeInput) {
            volumeInput.value = s.volume || 70;
            volumeInput.dispatchEvent(new Event('input', { bubbles: true }));
          }
          if (document.getElementById('setting-music')) document.getElementById('setting-music').checked = s.music ?? true;
          if (document.getElementById('setting-scale')) document.getElementById('setting-scale').value = s.scale || 1;
          if (document.getElementById('setting-reduced-motion')) document.getElementById('setting-reduced-motion').checked = s.reducedMotion ?? false;
          if (document.getElementById('setting-auto-dark')) document.getElementById('setting-auto-dark').checked = s.autoDark ?? false;
          if (document.getElementById('setting-auto-pause')) document.getElementById('setting-auto-pause').checked = s.autoPause ?? true;
          if (document.getElementById('setting-notifications')) document.getElementById('setting-notifications').checked = s.notifications ?? true;
          
          document.body.style.fontSize = (s.scale || 1) + 'rem';
          if (s.reducedMotion) document.documentElement.style.setProperty('--transition-speed', '0s');
          if (s.autoDark) {
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            applyTheme(prefersDark ? 'dark' : 'light', false);
          }
        };

        const setupSettings = () => {
          const overlay = document.getElementById('settings-overlay');
          const toggle = document.getElementById('settings-toggle');
          const close = document.getElementById('settings-close');
          const clearData = document.getElementById('setting-clear-data');
          const scaleSelect = document.getElementById('setting-scale');
          const reducedMotion = document.getElementById('setting-reduced-motion');
          const autoDark = document.getElementById('setting-auto-dark');
          const autoPause = document.getElementById('setting-auto-pause');
          const volume = document.getElementById('setting-volume');
          const music = document.getElementById('setting-music');
          const notifications = document.getElementById('setting-notifications');

          if (toggle && overlay) {
            toggle.addEventListener('click', () => overlay.classList.add('is-open'));
          }
          if (close && overlay) {
            close.addEventListener('click', () => overlay.classList.remove('is-open'));
          }
          
          if (scaleSelect) {
            scaleSelect.addEventListener('change', () => {
              document.body.style.fontSize = scaleSelect.value + 'rem';
              saveSettings();
            });
          }
          
          if (reducedMotion) {
            reducedMotion.addEventListener('change', () => {
              if (reducedMotion.checked) {
                document.documentElement.style.setProperty('--transition-speed', '0s');
              } else {
                document.documentElement.style.removeProperty('--transition-speed');
              }
              saveSettings();
            });
          }
          
          if (autoDark) {
            autoDark.addEventListener('change', () => {
              if (autoDark.checked) {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                applyTheme(prefersDark ? 'dark' : 'light', false);
              } else {
                const savedTheme = localStorage.getItem('planetTheme') || 'light';
                applyTheme(savedTheme, false);
              }
              saveSettings();
            });
          }
          
          if (autoPause) {
            document.addEventListener('visibilitychange', () => {
              if (autoPause.checked && document.hidden) {
                simState.paused = true;
                const pauseBtn = document.getElementById('sim-pause');
                if (pauseBtn) {
                  pauseBtn.setAttribute('aria-pressed', 'true');
                  pauseBtn.textContent = 'Weiter';
                }
              }
            });
            autoPause.addEventListener('change', saveSettings);
          }

          volume?.addEventListener('input', saveSettings);
          music?.addEventListener('change', saveSettings);
          notifications?.addEventListener('change', saveSettings);
          
          if (clearData) {
            clearData.addEventListener('click', () => {
              if (confirm('Alle Daten für diesen Nutzer löschen? (Spielstände, Einstellungen)')) {
                clearUserData(authState.user);
                toast({ type: 'warning', title: 'Daten gelöscht', message: 'Alle Spielstände für diesen Nutzer wurden entfernt.' });
              }
            });
          }

          try {
            const saved = localStorage.getItem(saveKeyForUser(authState.user, 'settings'));
            if (saved) {
              applySettings(JSON.parse(saved));
            }
          } catch (e) {
            console.warn('Failed to load settings:', e);
          }
        };

        // Command Palette
        const commands = [
          { id: 'new-seed', icon: '🎲', label: 'Neuen Seed generieren', shortcut: 'N', action: () => document.getElementById('seed-random')?.click() },
          { id: 'toggle-theme', icon: '🌓', label: 'Theme wechseln', shortcut: 'T', action: () => document.getElementById('theme-toggle')?.click() },
          { id: 'open-glossary', icon: '📖', label: 'Glossar öffnen', shortcut: 'G', action: () => document.getElementById('glossary-modal')?.classList.add('is-open') },
          { id: 'start-tutorial', icon: '📚', label: 'Tutorial starten', shortcut: 'H', action: () => document.getElementById('tutorial-start')?.click() },
          { id: 'toggle-pause', icon: '⏸️', label: 'Pause/Weiter', shortcut: 'Space', action: () => document.getElementById('sim-pause')?.click() },
          { id: 'speed-1x', icon: '▶️', label: 'Geschwindigkeit 1×', shortcut: '1', action: () => document.getElementById('sim-1x')?.click() },
          { id: 'speed-4x', icon: '⏩', label: 'Geschwindigkeit 4×', shortcut: '2', action: () => document.getElementById('sim-4x')?.click() },
          { id: 'speed-10x', icon: '⏭️', label: 'Geschwindigkeit 10×', shortcut: '3', action: () => document.getElementById('sim-10x')?.click() },
          { id: 'save-game', icon: '💾', label: 'Spielstand speichern', shortcut: 'S', action: () => document.getElementById('save-game')?.click() },
          { id: 'load-game', icon: '📂', label: 'Spielstand laden', shortcut: 'L', action: () => document.getElementById('load-game')?.click() },
          { id: 'export-json', icon: '📄', label: 'Als JSON exportieren', shortcut: 'E', action: () => document.getElementById('export-json')?.click() },
          { id: 'settings', icon: '⚙️', label: 'Einstellungen', shortcut: ',', action: () => document.getElementById('settings-overlay')?.classList.add('is-open') },
          { id: 'go-status', icon: '📊', label: 'Zum Status', action: () => document.getElementById('status')?.scrollIntoView({ behavior: 'smooth' }) },
          { id: 'go-research', icon: '🔬', label: 'Zur Forschung', action: () => document.getElementById('research')?.scrollIntoView({ behavior: 'smooth' }) },
          { id: 'go-biomes', icon: '🌍', label: 'Zu den Biomen', action: () => document.getElementById('biomes')?.scrollIntoView({ behavior: 'smooth' }) },
          { id: 'print', icon: '🖨️', label: 'Drucken / PDF', shortcut: 'P', action: () => window.print() }
        ];

        const setupCommandPalette = () => {
          const overlay = document.getElementById('command-palette');
          const input = document.getElementById('command-input');
          const list = document.getElementById('command-list');
          let selectedIndex = 0;

          const renderCommands = (filter = '') => {
            const filtered = commands.filter(c => 
              c.label.toLowerCase().includes(filter.toLowerCase()) || 
              c.shortcut?.toLowerCase().includes(filter.toLowerCase())
            );
            list.innerHTML = filtered.map((c, i) => `
              <div class="command-item ${i === selectedIndex ? 'is-selected' : ''}" data-cmd="${c.id}" role="option">
                <span class="cmd-icon">${c.icon}</span>
                <span class="cmd-label">${c.label}</span>
                ${c.shortcut ? `<span class="cmd-shortcut">${c.shortcut}</span>` : ''}
              </div>
            `).join('');
            
            list.querySelectorAll('.command-item').forEach((item, i) => {
              item.addEventListener('click', () => executeCommand(filtered[i]));
              item.addEventListener('mouseenter', () => {
                selectedIndex = i;
                renderCommands(filter);
              });
            });
          };

          const executeCommand = (cmd) => {
            overlay.classList.remove('is-open');
            input.value = '';
            cmd.action();
          };

          const openPalette = () => {
            overlay.classList.add('is-open');
            input.focus();
            selectedIndex = 0;
            renderCommands();
          };

          const closePalette = () => {
            overlay.classList.remove('is-open');
            input.value = '';
          };

          if (input) {
            input.addEventListener('input', (e) => {
              selectedIndex = 0;
              renderCommands(e.target.value);
            });
            
            input.addEventListener('keydown', (e) => {
              const items = list.querySelectorAll('.command-item');
              if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = (selectedIndex + 1) % items.length;
                renderCommands(input.value);
              } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = (selectedIndex - 1 + items.length) % items.length;
                renderCommands(input.value);
              } else if (e.key === 'Enter') {
                e.preventDefault();
                const filtered = commands.filter(c => c.label.toLowerCase().includes(input.value.toLowerCase()));
                if (filtered[selectedIndex]) executeCommand(filtered[selectedIndex]);
              }
            });
          }

          if (overlay) {
            overlay.addEventListener('click', (e) => {
              if (e.target === overlay) closePalette();
            });
          }

          // Global shortcut
          window.cmdPaletteOpen = openPalette;
          window.cmdPaletteClose = closePalette;
        };

        // Keyboard Shortcuts
        const setupKeyboardShortcuts = () => {
          const hint = document.getElementById('keyboard-hint');
          let hintTimeout;

          const showHint = () => {
            if (hint) {
              hint.classList.add('is-visible');
              clearTimeout(hintTimeout);
              hintTimeout = setTimeout(() => hint.classList.remove('is-visible'), 3000);
            }
          };

          // Show hint on first visit
          if (!localStorage.getItem('planet-sandbox-hint-seen')) {
            setTimeout(showHint, 2000);
            localStorage.setItem('planet-sandbox-hint-seen', 'true');
          }

          document.addEventListener('keydown', (e) => {
            // Skip if typing in input
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) return;
            
            // Command palette
            if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
              e.preventDefault();
              window.cmdPaletteOpen?.();
              return;
            }
            
            // ESC closes modals
            if (e.key === 'Escape') {
              document.querySelectorAll('.is-open').forEach(el => el.classList.remove('is-open'));
              document.querySelectorAll('.is-active').forEach(el => el.classList.remove('is-active'));
              window.cmdPaletteClose?.();
              return;
            }
            
            // Single key shortcuts
            const keyMap = {
              't': () => document.getElementById('theme-toggle')?.click(),
              'g': () => document.getElementById('glossary-modal')?.classList.add('is-open'),
              'h': () => document.getElementById('tutorial-start')?.click(),
              ' ': () => document.getElementById('sim-pause')?.click(),
              '1': () => document.getElementById('sim-1x')?.click(),
              '2': () => document.getElementById('sim-4x')?.click(),
              '3': () => document.getElementById('sim-10x')?.click(),
              'n': () => document.getElementById('seed-random')?.click(),
              '?': showHint
            };

            if (keyMap[e.key.toLowerCase()]) {
              e.preventDefault();
              keyMap[e.key.toLowerCase()]();
            }
          });
        };

        // Overlay System
        const setupOverlays = () => {
          const controls = document.querySelectorAll('.overlay-controls');
          controls.forEach(control => {
            const buttons = control.querySelectorAll('.overlay-btn');
            const map = control.nextElementSibling;
            const layers = map?.querySelectorAll('.overlay-layer');
            
            buttons.forEach(btn => {
              btn.addEventListener('click', () => {
                buttons.forEach(b => b.setAttribute('aria-pressed', 'false'));
                btn.setAttribute('aria-pressed', 'true');
                
                const overlay = btn.dataset.overlay;
                layers?.forEach(layer => {
                  layer.classList.toggle('is-active', layer.classList.contains(overlay));
                });
              });
            });
          });
        };

        // Flow Diagram Interactivity
        const setupFlowInteractivity = () => {
          const nodes = document.querySelectorAll('.flow-node');
          nodes.forEach(node => {
            const index = node.dataset.flowIndex;
            node.addEventListener('mouseenter', () => {
              node.classList.add('is-highlighted');
              document.querySelectorAll(`.flow-path[data-flow-index="${index}"]`).forEach(path => {
                path.classList.add('is-highlighted');
              });
            });
            node.addEventListener('mouseleave', () => {
              node.classList.remove('is-highlighted');
              document.querySelectorAll(`.flow-path[data-flow-index="${index}"]`).forEach(path => {
                path.classList.remove('is-highlighted');
              });
            });
          });
        };

        // Diplomacy Interactions (erweitert mit factionState)
        const setupDiplomacy = () => {
          const factionCards = document.querySelectorAll('.faction-card');
          factionCards.forEach(card => {
            const faction = card.dataset.faction;
            if (!faction) return;
            
            // Update initial state
            updateFactionRelations(faction, 0);
            
            const btns = card.querySelectorAll('.faction-btn, button[data-action]');
            const relationValue = card.querySelector('.relation-value');
            const relationFill = card.querySelector('.relation-fill');
            const relationStatus = card.querySelector('.relation-status');
            
            btns.forEach(btn => {
              btn.addEventListener('click', () => {
                const action = btn.dataset.action;
                let delta = 0;
                let msg = '';
                
                switch (action) {
                  case 'gift':
                  case 'improve':
                    delta = 5;
                    msg = 'Geschenk gesendet! +5 Beziehung';
                    break;
                  case 'trade':
                    delta = 2;
                    msg = 'Handel eröffnet! +2 Beziehung';
                    break;
                  case 'treaty':
                    const current = factionState[faction]?.relation || parseInt(relationValue?.textContent || 0);
                    if (current >= 60) {
                      const treatyType = btn.dataset.treaty || 'Forschungsabkommen';
                      if (negotiateTreaty(faction, treatyType)) {
                        return; // negotiateTreaty zeigt bereits Toast
                      }
                    } else {
                      toast({ type: 'warning', title: 'Vertrag abgelehnt', message: 'Mindestens 60% Beziehung erforderlich.' });
                      return;
                    }
                    break;
                  case 'deteriorate':
                    delta = -5;
                    msg = 'Beziehung verschlechtert! -5 Beziehung';
                    break;
                }
                
                if (delta !== 0 && faction) {
                  updateFactionRelations(faction, delta);
                  toast({ type: delta > 0 ? 'success' : 'warning', title: msg.split('!')[0] + '!', message: msg.split('!')[1] || '' });
                }
              });
            });
          });
          
          // Apply faction effects
          applyFactionEffects();
        };

        // Route Editor (CRUD)
        // setupRouteEditor ist bereits oben definiert (Zeile 7185)


        // Multi-Planet System
        const multiPlanetState = {
          planets: [],
          activePlanetId: null,
          nextId: 1
        };

        const loadPlanetsFromStorage = () => {
          multiPlanetState.planets = [];
          multiPlanetState.activePlanetId = null;
          multiPlanetState.nextId = 1;
          try {
            const saved = localStorage.getItem(saveKeyForUser(authState.user, 'planets'));
            if (saved) {
              const data = JSON.parse(saved);
              multiPlanetState.planets = (data.planets || []).map((planet) => ({
                resources: planet.resources || { ...resourceState.storage },
                resourceCapacity: planet.resourceCapacity || { ...resourceState.storageCapacity },
                researchPoints: planet.researchPoints || 0,
                researchQueue: planet.researchQueue || [],
                unlockedResearch: planet.unlockedResearch || [...unlockedResearch],
                tradeState: planet.tradeState || { totalExported: 0, completedRoutes: 0 },
                activeEffects: planet.activeEffects || [],
                ...planet
              }));
              multiPlanetState.activePlanetId = data.activePlanetId || null;
              multiPlanetState.nextId = data.nextId || 1;
            }
          } catch (e) {
            console.warn('Failed to load planets:', e);
          }
          
          // Ensure at least one planet exists
          if (multiPlanetState.planets.length === 0) {
            const seedInput = document.getElementById('seed-input');
            const initialSeed = seedInput?.value || 'DEFAULT';
            const newPlanet = {
              id: `planet-${multiPlanetState.nextId++}`,
              name: `Planet ${multiPlanetState.nextId - 1}`,
              seed: initialSeed,
              simulation: { day: 1, year: 1, speed: 1, paused: false },
              buildings: [],
              research: [],
              routes: [],
              researchQueue: [],
              createdAt: new Date().toISOString()
            };
            multiPlanetState.planets.push(newPlanet);
            multiPlanetState.activePlanetId = newPlanet.id;
          }
          
          if (!multiPlanetState.activePlanetId && multiPlanetState.planets.length > 0) {
            multiPlanetState.activePlanetId = multiPlanetState.planets[0].id;
          }
        };

        const savePlanetsToStorage = () => {
          try {
            localStorage.setItem(saveKeyForUser(authState.user, 'planets'), JSON.stringify({
              planets: multiPlanetState.planets,
              activePlanetId: multiPlanetState.activePlanetId,
              nextId: multiPlanetState.nextId
            }));
          } catch (e) {
            console.warn('Failed to save planets:', e);
          }
        };

        const getActivePlanet = () => {
          return multiPlanetState.planets.find(p => p.id === multiPlanetState.activePlanetId);
        };

        const switchToPlanet = (planetId) => {
          const planet = multiPlanetState.planets.find(p => p.id === planetId);
          if (!planet) return;
          
          // Save current planet state
          const current = getActivePlanet();
          if (current) {
            const state = getGameState();
            Object.assign(current, {
              seed: state.seed,
              simulation: state.simulation,
              buildings: state.buildings,
              research: state.research,
              routes: state.routes,
              resources: state.resources,
              resourceCapacity: state.resourceCapacity,
              researchPoints: state.researchPoints,
              unlockedResearch: state.unlockedResearch,
              researchQueue: state.researchQueue,
              tradeState: state.tradeState,
              activeEffects: state.activeEffects
            });
          }
          
          // Switch to new planet
          multiPlanetState.activePlanetId = planetId;
          savePlanetsToStorage();
          
          // Load planet state
          const seedInput = document.getElementById('seed-input');
          if (seedInput) seedInput.value = planet.seed;
          
          simState.day = planet.simulation.day || 1;
          simState.year = planet.simulation.year || 1;
          simState.speed = planet.simulation.speed || 1;
          simState.paused = planet.simulation.paused || false;
          updateTimeDisplay();
          
          // Apply seed
          if (typeof applySeedToUI === 'function') {
            applySeedToUI(planet.seed, { save: false });
          } else {
            // Fallback: render planet directly
            renderPixelPlanet(planet.seed);
          }
          
          // Restore buildings, research, routes
          loadGameState({
            seed: planet.seed,
            simulation: planet.simulation,
            buildings: planet.buildings,
            research: planet.research,
            routes: planet.routes,
            resources: planet.resources,
            resourceCapacity: planet.resourceCapacity,
            researchPoints: planet.researchPoints,
            unlockedResearch: planet.unlockedResearch,
            researchQueue: planet.researchQueue || [],
            tradeState: planet.tradeState,
            activeEffects: planet.activeEffects
          });
          
          updatePlanetUI();
          renderStatsDashboard();
        };

        const addNewPlanet = () => {
          const seedInput = document.getElementById('seed-input');
          const newSeed = seedInput?.value || randomSeed();
          const newPlanet = {
            id: `planet-${multiPlanetState.nextId++}`,
            name: `Planet ${multiPlanetState.planets.length + 1}`,
            seed: newSeed,
            simulation: { day: 1, year: 1, speed: 1, paused: false },
            buildings: [],
            research: [],
            routes: [],
            resources: { ...resourceState.storage },
            resourceCapacity: { ...resourceState.storageCapacity },
            researchPoints: 0,
            unlockedResearch: [...unlockedResearch],
            researchQueue: [],
            tradeState: { totalExported: 0, completedRoutes: 0 },
            activeEffects: [],
            createdAt: new Date().toISOString()
          };
          multiPlanetState.planets.push(newPlanet);
          savePlanetsToStorage();
          switchToPlanet(newPlanet.id);
          renderPlanetList();
        };

        const updatePlanetUI = () => {
          const active = getActivePlanet();
          const nameEl = document.getElementById('current-planet-name');
          if (nameEl && active) {
            nameEl.textContent = active.name;
          }
        };

        const renderPlanetList = () => {
          const body = document.getElementById('planet-list-body');
          if (!body) return;
          
          body.innerHTML = multiPlanetState.planets.map(planet => {
            const isActive = planet.id === multiPlanetState.activePlanetId;
            return `
              <div class="planet-item ${isActive ? 'is-active' : ''}" data-planet-id="${planet.id}">
                <div style="font-size: 1.5rem;">🌍</div>
                <div>
                  <strong>${planet.name}</strong>
                  <div style="font-size: 0.8rem; color: var(--muted); margin-top: 4px;">
                    Seed: ${planet.seed} | Jahr ${planet.simulation.year}, Tag ${planet.simulation.day}
                  </div>
                </div>
                <div class="planet-item-actions">
                  <button class="planet-item-btn" data-action="switch">Wechseln</button>
                  <button class="planet-item-btn" data-action="duplicate">Duplizieren</button>
                  ${multiPlanetState.planets.length > 1 ? '<button class="planet-item-btn" data-action="delete">Löschen</button>' : ''}
                </div>
              </div>
            `;
          }).join('');
          
          // Attach event listeners
          body.querySelectorAll('.planet-item').forEach(item => {
            const planetId = item.dataset.planetId;
            item.addEventListener('click', (e) => {
              if (!e.target.closest('.planet-item-actions')) {
                switchToPlanet(planetId);
                document.getElementById('planet-list-overlay')?.classList.remove('is-open');
              }
            });
            
            item.querySelectorAll('[data-action]').forEach(btn => {
              btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const action = btn.dataset.action;
                if (action === 'switch') {
                  switchToPlanet(planetId);
                  document.getElementById('planet-list-overlay')?.classList.remove('is-open');
                } else if (action === 'duplicate') {
                  const planet = multiPlanetState.planets.find(p => p.id === planetId);
                  if (planet) {
                    const dup = {
                      ...planet,
                      id: `planet-${multiPlanetState.nextId++}`,
                      name: `${planet.name} (Kopie)`,
                      createdAt: new Date().toISOString()
                    };
                    multiPlanetState.planets.push(dup);
                    savePlanetsToStorage();
                    renderPlanetList();
                  }
                } else if (action === 'delete' && multiPlanetState.planets.length > 1) {
                  multiPlanetState.planets = multiPlanetState.planets.filter(p => p.id !== planetId);
                  if (multiPlanetState.activePlanetId === planetId) {
                    multiPlanetState.activePlanetId = multiPlanetState.planets[0].id;
                    switchToPlanet(multiPlanetState.activePlanetId);
                  }
                  savePlanetsToStorage();
                  renderPlanetList();
                }
              });
            });
          });
        };

        // Planet Compare Functions
        const renderPlanetCompare = (planet1Id, planet2Id) => {
          const planet1 = multiPlanetState.planets.find(p => p.id === planet1Id);
          const planet2 = multiPlanetState.planets.find(p => p.id === planet2Id);
          
          if (!planet1 || !planet2) return;
          
          const planet1Data = generatePlanet(planet1.seed);
          const planet2Data = generatePlanet(planet2.seed);
          const colony1 = calculateColonyKPIs(planet1Data, planet1.buildings || []);
          const colony2 = calculateColonyKPIs(planet2Data, planet2.buildings || []);
          
          const content = document.getElementById('planet-compare-content');
          if (!content) return;
          
          const renderPlanetCard = (planet, planetData, colony, isLeft) => {
            const canvasId = `compare-canvas-${isLeft ? '1' : '2'}`;
            return `
              <div class="compare-planet-card">
                <div class="compare-planet-visual">
                  <canvas class="compare-planet-canvas" id="${canvasId}" width="150" height="150"></canvas>
                  <div class="compare-planet-name">${planet.name}</div>
                  <div class="compare-planet-seed">Seed: ${planet.seed}</div>
                </div>
                <div class="compare-kpi-grid">
                  <div class="compare-kpi-item">
                    <div class="compare-kpi-label">Bevölkerung</div>
                    <div class="compare-kpi-value">${formatNumberShort(colony.population)}</div>
                  </div>
                  <div class="compare-kpi-item">
                    <div class="compare-kpi-label">Zufriedenheit</div>
                    <div class="compare-kpi-value">${colony.satisfaction}%</div>
                  </div>
                  <div class="compare-kpi-item">
                    <div class="compare-kpi-label">Emissionen</div>
                    <div class="compare-kpi-value">${colony.emissions}%</div>
                  </div>
                  <div class="compare-kpi-item">
                    <div class="compare-kpi-label">Energie</div>
                    <div class="compare-kpi-value">${colony.energy}%</div>
                  </div>
                  <div class="compare-kpi-item">
                    <div class="compare-kpi-label">Wasser</div>
                    <div class="compare-kpi-value">${colony.water}%</div>
                  </div>
                  <div class="compare-kpi-item">
                    <div class="compare-kpi-label">Versorgung</div>
                    <div class="compare-kpi-value">${colony.supply}%</div>
                  </div>
                </div>
                <div class="compare-planet-info">
                  <div class="compare-info-row">
                    <span class="compare-info-label">Größe</span>
                    <span class="compare-info-value">${planetData.size}</span>
                  </div>
                  <div class="compare-info-row">
                    <span class="compare-info-label">Klima</span>
                    <span class="compare-info-value">${planetData.climate}</span>
                  </div>
                  <div class="compare-info-row">
                    <span class="compare-info-label">Ozean</span>
                    <span class="compare-info-value">${planetData.ocean}</span>
                  </div>
                  <div class="compare-info-row">
                    <span class="compare-info-label">Gravitation</span>
                    <span class="compare-info-value">${planetData.gravity}</span>
                  </div>
                  <div class="compare-info-row">
                    <span class="compare-info-label">Gefahr</span>
                    <span class="compare-info-value">${planetData.hazard}</span>
                  </div>
                  <div class="compare-info-row">
                    <span class="compare-info-label">Ressourcen</span>
                    <span class="compare-info-value">${planetData.resources}</span>
                  </div>
                  <div class="compare-info-row">
                    <span class="compare-info-label">Sektoren</span>
                    <span class="compare-info-value">${planetData.sectors}</span>
                  </div>
                  <div class="compare-info-row">
                    <span class="compare-info-label">Stadium</span>
                    <span class="compare-info-value">${colony.stage}</span>
                  </div>
                  <div class="compare-info-row">
                    <span class="compare-info-label">Engpass</span>
                    <span class="compare-info-value">${colony.bottleneck}</span>
                  </div>
                  <div class="compare-info-row">
                    <span class="compare-info-label">Simulation</span>
                    <span class="compare-info-value">Jahr ${planet.simulation.year}, Tag ${planet.simulation.day}</span>
                  </div>
                </div>
              </div>
            `;
          };
          
          content.innerHTML = renderPlanetCard(planet1, planet1Data, colony1, true) + 
                            renderPlanetCard(planet2, planet2Data, colony2, false);
          
          // Render planet canvases
          setTimeout(() => {
            renderPixelPlanet(planet1.seed, 'compare-canvas-1');
            renderPixelPlanet(planet2.seed, 'compare-canvas-2');
          }, 100);
        };
        
        const setupPlanetCompare = () => {
          const compareBtn = document.getElementById('planet-compare');
          const compareOverlay = document.getElementById('planet-compare-overlay');
          const compareClose = document.getElementById('planet-compare-close');
          const select1 = document.getElementById('compare-planet-1');
          const select2 = document.getElementById('compare-planet-2');
          
          if (!compareBtn || !compareOverlay) return;
          
          const updateCompareSelects = () => {
            if (!select1 || !select2) return;
            select1.innerHTML = '';
            select2.innerHTML = '';
            
            multiPlanetState.planets.forEach(planet => {
              const opt1 = document.createElement('option');
              opt1.value = planet.id;
              opt1.textContent = planet.name;
              opt1.selected = planet.id === multiPlanetState.activePlanetId;
              select1.appendChild(opt1);
              
              const opt2 = document.createElement('option');
              opt2.value = planet.id;
              opt2.textContent = planet.name;
              select2.appendChild(opt2);
            });

            // Wähle für Vergleich automatisch einen anderen Planeten
            const firstOther = multiPlanetState.planets.find(p => p.id !== multiPlanetState.activePlanetId);
            if (firstOther) {
              select2.value = firstOther.id;
            } else if (multiPlanetState.planets[0]) {
              select2.value = multiPlanetState.planets[0].id;
            }
          };
          
          const updateCompare = () => {
            if (!select1 || !select2) return;
            const planet1Id = select1.value;
            const planet2Id = select2.value;
            if (planet1Id && planet2Id && planet1Id !== planet2Id) {
              renderPlanetCompare(planet1Id, planet2Id);
            }
          };
          
          compareBtn.addEventListener('click', () => {
            if (multiPlanetState.planets.length < 2) {
              toast({ type: 'warning', title: 'Nicht genug Planeten', message: 'Du brauchst mindestens 2 Planeten zum Vergleichen.' });
              return;
            }
            updateCompareSelects();
            updateCompare();
            compareOverlay.classList.add('is-open');
          });
          
          if (compareClose) {
            compareClose.addEventListener('click', () => {
              compareOverlay.classList.remove('is-open');
            });
          }
          
          compareOverlay?.addEventListener('click', (e) => {
            if (e.target === compareOverlay) {
              compareOverlay.classList.remove('is-open');
            }
          });
          
          if (select1) {
            select1.addEventListener('change', updateCompare);
          }
          
          if (select2) {
            select2.addEventListener('change', updateCompare);
          }
        };

        const setupMultiPlanet = () => {
          loadPlanetsFromStorage();
          updatePlanetUI();
          if (multiPlanetState.activePlanetId) {
            switchToPlanet(multiPlanetState.activePlanetId);
          }
          renderPlanetList();
          
          const switcher = document.getElementById('planet-switcher');
          const addBtn = document.getElementById('planet-add');
          const overlay = document.getElementById('planet-list-overlay');
          const closeBtn = document.getElementById('planet-list-close');
          
          if (switcher && overlay) {
            switcher.addEventListener('click', () => {
              renderPlanetList();
              overlay.classList.add('is-open');
            });
          }
          
          if (addBtn) {
            addBtn.addEventListener('click', () => {
              addNewPlanet();
            });
          }
          
          if (closeBtn && overlay) {
            closeBtn.addEventListener('click', () => {
              overlay.classList.remove('is-open');
            });
          }
          
          overlay?.addEventListener('click', (e) => {
            if (e.target === overlay) {
              overlay.classList.remove('is-open');
            }
          });
          
          setupPlanetCompare();
          
          // Auto-save planet state periodically
          setInterval(() => {
            const active = getActivePlanet();
            if (active) {
              const state = getGameState();
              Object.assign(active, {
                seed: state.seed,
                simulation: state.simulation,
                buildings: state.buildings,
                research: state.research,
                routes: state.routes,
                resources: state.resources,
                resourceCapacity: state.resourceCapacity,
                researchPoints: state.researchPoints,
                unlockedResearch: state.unlockedResearch,
                tradeState: state.tradeState,
                activeEffects: state.activeEffects
              });
              savePlanetsToStorage();
            }
          }, 5000);
        };

        // Pixel Art Planet Rendering
        const renderPixelPlanet = (seed, canvasId = 'main-planet-canvas') => {
          const canvas = document.getElementById(canvasId);
          if (!canvas) return;
          
          const ctx = canvas.getContext('2d');
          const size = canvas.width || 200;
          const center = size / 2;
          const radius = (size * 0.45);
          
          // Clear
          ctx.fillStyle = '#0d1117';
          ctx.fillRect(0, 0, size, size);
          
          // Generate deterministic noise from seed
          const hash = hashSeed(seed);
          const rng = mulberry32(hash);
          
          // Planet base color (seed-dependent)
          const hue = (hash % 360);
          const planetColor = `hsl(${hue}, 60%, 45%)`;
          const oceanColor = `hsl(${hue + 30}, 70%, 35%)`;
          const landColor = `hsl(${hue - 20}, 50%, 55%)`;
          
          // Draw planet circle
          ctx.beginPath();
          ctx.arc(center, center, radius, 0, Math.PI * 2);
          ctx.fillStyle = planetColor;
          ctx.fill();
          
          // Sektoren mit Besitzer-Farben zeichnen (wenn Territorium initialisiert)
          if (Object.keys(sectorOwnership).length > 0) {
            const totalSectors = Object.keys(sectorOwnership).length;
            const sectorAngle = (Math.PI * 2) / totalSectors;
            
            Object.entries(sectorOwnership).forEach(([sectorId, ownership], index) => {
              const startAngle = index * sectorAngle - Math.PI / 2;
              const endAngle = (index + 1) * sectorAngle - Math.PI / 2;
              
              // Besitzer-Farbe
              let ownerColor = '#888'; // Neutral
              if (ownership.owner === 'player') {
                ownerColor = '#4ade80'; // Grün
              } else if (ownership.owner === 'ai1') {
                ownerColor = '#ff4444'; // Rot
              } else if (ownership.owner === 'ai2') {
                ownerColor = '#ff8844'; // Orange
              } else if (ownership.owner === 'ai3') {
                ownerColor = '#8844ff'; // Lila
              }
              
              // Sektor-Segment zeichnen
              ctx.beginPath();
              ctx.moveTo(center, center);
              ctx.arc(center, center, radius, startAngle, endAngle);
              ctx.closePath();
              ctx.fillStyle = ownerColor + '40'; // 40 = 25% Opacity
              ctx.fill();
              ctx.strokeStyle = ownerColor;
              ctx.lineWidth = 2;
              ctx.stroke();
            });
          }
          
          // Generate continents (simplified pixel art)
          const numContinents = Math.floor(rng() * 4) + 3;
          for (let i = 0; i < numContinents; i++) {
            const angle = rng() * Math.PI * 2;
            const dist = (rng() * 0.4 + 0.1) * radius;
            const contX = center + Math.cos(angle) * dist;
            const contY = center + Math.sin(angle) * dist;
            const contSize = rng() * 25 + 15;
            
            // Draw continent blob (pixelated)
            ctx.fillStyle = landColor;
            for (let x = -contSize; x < contSize; x += 2) {
              for (let y = -contSize; y < contSize; y += 2) {
                const distFromCenter = Math.sqrt(x * x + y * y);
                if (distFromCenter < contSize && distFromCenter > contSize * 0.3) {
                  const px = Math.floor(contX + x);
                  const py = Math.floor(contY + y);
                  const distFromPlanet = Math.sqrt((px - center) ** 2 + (py - center) ** 2);
                  if (distFromPlanet < radius) {
                    ctx.fillRect(px, py, 2, 2);
                  }
                }
              }
            }
          }
          
          // Draw terminator (day/night line)
          ctx.save();
          const terminatorX = center + Math.cos(Date.now() / 10000) * radius * 0.3;
          ctx.beginPath();
          ctx.arc(center, center, radius, Math.PI / 2, Math.PI * 1.5);
          ctx.clip();
          ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
          ctx.fillRect(0, 0, terminatorX, size);
          ctx.restore();
          
          // Draw clouds (pixelated)
          ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
          for (let i = 0; i < 5; i++) {
            const cloudX = center + (rng() - 0.5) * radius * 1.2;
            const cloudY = center + (rng() - 0.5) * radius * 1.2;
            const distFromCenter = Math.sqrt((cloudX - center) ** 2 + (cloudY - center) ** 2);
            if (distFromCenter < radius) {
              for (let x = -8; x < 8; x += 2) {
                for (let y = -4; y < 4; y += 2) {
                  if (rng() > 0.3) {
                    ctx.fillRect(Math.floor(cloudX + x), Math.floor(cloudY + y), 2, 2);
                  }
                }
              }
            }
          }
        };

        // Achievements System
        const achievementDefinitions = [
          { id: 'first-colony', name: 'Erste Siedlung', description: 'Gründe deine erste Kolonie', icon: '🚀', rarity: 'common', check: (state) => state.buildings.length > 0 },
          { id: 'population-10k', name: 'Wachstum', description: 'Erreiche 10.000 Einwohner', icon: '👥', rarity: 'common', check: (state) => {
            const planet = generatePlanet(state.seed);
            const colony = calculateColonyKPIs(planet, collectBuildings());
            return colony.population >= 10000;
          }},
          { id: 'population-100k', name: 'Metropole', description: 'Erreiche 100.000 Einwohner', icon: '🏙️', rarity: 'rare', check: (state) => {
            const planet = generatePlanet(state.seed);
            const colony = calculateColonyKPIs(planet, collectBuildings());
            return colony.population >= 100000;
          }},
          { id: 'climate-control', name: 'Klimakontrolle', description: 'Stabilisiere die Temperatur für 30 Tage', icon: '🌡️', rarity: 'rare', check: (state) => state.simulation.day >= 30 },
          { id: 'trade-magnate', name: 'Handelsmagnat', description: 'Exportiere 10.000t Waren', icon: '💰', rarity: 'rare', check: (state) => {
            return tradeState.totalExported >= 10000;
          }},
          { id: 'terraformer', name: 'Terraformer', description: 'Schaffe ein bewohnbares Biom', icon: '🌍', rarity: 'epic', check: (state) => {
            const planet = generatePlanet(state.seed);
            const colony = calculateColonyKPIs(planet, collectBuildings());
            return colony.satisfaction >= 80 && colony.water >= 60;
          }},
          { id: 'diplomat', name: 'Diplomat', description: 'Schließe Allianzen mit 3 Fraktionen', icon: '🤝', rarity: 'epic', check: (state) => {
            const alliances = Object.values(factionState).filter(f => (f.treaties || []).length > 0).length;
            return alliances >= 2;
          }},
          { id: 'utopia', name: 'Utopia', description: '100% Zufriedenheit bei 1M Einwohnern', icon: '🌟', rarity: 'legendary', check: (state) => {
            const planet = generatePlanet(state.seed);
            const colony = calculateColonyKPIs(planet, collectBuildings());
            return colony.population >= 500000 && colony.satisfaction >= 90;
          }},
          { id: 'zero-emission', name: 'Null-Emission', description: 'Industrie ohne CO₂-Ausstoß', icon: '♻️', rarity: 'legendary', check: (state) => {
            const planet = generatePlanet(state.seed);
            const colony = calculateColonyKPIs(planet, collectBuildings());
            return colony.emissions <= 5;
          }},
          { id: 'multi-planet', name: 'Multi-Planet', description: 'Verwalte 5 Planeten gleichzeitig', icon: '🌌', rarity: 'epic', check: (state) => multiPlanetState.planets.length >= 5 }
        ];

        let achievementState = {
          unlocked: [],
          progress: {}
        };

        const loadAchievements = () => {
          try {
            const saved = localStorage.getItem(saveKeyForUser(authState.user, 'achievements'));
            if (saved) {
              achievementState = JSON.parse(saved);
            }
          } catch (e) {
            console.warn('Failed to load achievements:', e);
          }
        };

        const saveAchievements = () => {
          try {
            localStorage.setItem(saveKeyForUser(authState.user, 'achievements'), JSON.stringify(achievementState));
          } catch (e) {
            console.warn('Failed to save achievements:', e);
          }
        };

        const checkAchievements = (gameState) => {
          achievementDefinitions.forEach(achievement => {
            if (achievementState.unlocked.includes(achievement.id)) return;
            
            const progress = achievement.check(gameState);
            if (progress) {
              achievementState.unlocked.push(achievement.id);
              saveAchievements();
              toast({ 
                type: 'success', 
                title: '🏆 Achievement freigeschaltet!', 
                message: `${achievement.name}: ${achievement.description}` 
              });
              renderAchievements();
            } else {
              // Calculate progress for progress bars
              if (achievement.id === 'population-10k' || achievement.id === 'population-100k') {
                const planet = generatePlanet(gameState.seed);
                const colony = calculateColonyKPIs(planet, collectBuildings());
                const target = achievement.id === 'population-10k' ? 10000 : 100000;
                achievementState.progress[achievement.id] = Math.min(100, (colony.population / target) * 100);
              } else if (achievement.id === 'climate-control') {
                achievementState.progress[achievement.id] = Math.min(100, (gameState.simulation.day / 30) * 100);
              } else if (achievement.id === 'trade-magnate') {
                achievementState.progress[achievement.id] = Math.min(100, (tradeState.totalExported / 10000) * 100);
              } else if (achievement.id === 'multi-planet') {
                achievementState.progress[achievement.id] = Math.min(100, (multiPlanetState.planets.length / 5) * 100);
              }
            }
          });
        };

        const renderAchievements = () => {
          const grid = document.getElementById('achievement-grid');
          if (!grid) return;
          
          grid.innerHTML = achievementDefinitions.map(achievement => {
            const isUnlocked = achievementState.unlocked.includes(achievement.id);
            const progress = achievementState.progress[achievement.id] || 0;
            
            return `
              <div class="achievement-card ${isUnlocked ? 'unlocked' : 'locked'}" data-achievement-id="${achievement.id}">
                <span class="achievement-rarity ${achievement.rarity}">${achievement.rarity === 'common' ? 'Häufig' : achievement.rarity === 'rare' ? 'Selten' : achievement.rarity === 'epic' ? 'Episch' : 'Legendär'}</span>
                <div class="achievement-icon">${achievement.icon}</div>
                <h4>${achievement.name}</h4>
                <p>${achievement.description}</p>
                ${!isUnlocked && progress > 0 ? `
                  <div class="achievement-progress">
                    <div class="achievement-progress-bar" style="width: ${progress}%"></div>
                  </div>
                  <div class="achievement-progress-text">${Math.round(progress)}%</div>
                ` : ''}
              </div>
            `;
          }).join('');
        };

        const setupAchievements = () => {
          loadAchievements();
          renderAchievements();
          
          // Check achievements periodically
          setInterval(() => {
            const gameState = getGameState();
            checkAchievements(gameState);
          }, 5000);
          
          // Check on simulation update
          const originalUpdateTime = updateTimeDisplay;
          if (typeof originalUpdateTime === 'function') {
            // Hook into simulation updates
          }
        };

        // Initialize all features
        initAuth();
        setupTheme();
        setupNotifications();
        setupTopbarNav();
        setupGlossary();
        setupTutorial();
        setupBuildEditor();
        setupCatastrophe();
        setupSoundtrack();
        setupExport();
        setupResearch();
        setupSimulationControls();
        setupSettings();
        setupCommandPalette();
        setupKeyboardShortcuts();
        setupOverlays();
        setupFlowInteractivity();
        window.addEventListener('resize', renderFlowPaths);
        setupAchievements();
        setupEventOverlay();
        setupKPIActions();
        setupQuickActions();
        setupDiplomacyActions();
        setupResourceActions();
        
        // Enhanced Statistics Dashboard
        let statsHistory = {
          byPlanet: {},
          lastPlanetId: null
        };

        const loadStatsHistory = () => {
          try {
            const saved = localStorage.getItem(saveKeyForUser(authState.user, 'stats-history'));
            if (saved) {
              const parsed = JSON.parse(saved);
              if (parsed.byPlanet) {
                statsHistory = parsed;
              } else {
                // Legacy migration
                statsHistory = { byPlanet: { default: parsed }, lastPlanetId: 'default' };
              }
            }
          } catch (e) {
            console.warn('Failed to load stats history:', e);
          }
        };

        const saveStatsHistory = () => {
          try {
            localStorage.setItem(saveKeyForUser(authState.user, 'stats-history'), JSON.stringify(statsHistory));
          } catch (e) {
            console.warn('Failed to save stats history:', e);
          }
        };

        const getCurrentStatsBucket = () => {
          const planetId = getActivePlanetId();
          if (!statsHistory.byPlanet[planetId]) {
            statsHistory.byPlanet[planetId] = {
              population: [],
              satisfaction: [],
              emissions: [],
              energy: [],
              water: [],
              supply: [],
              tradeVolume: [],
              timestamps: []
            };
          }
          statsHistory.lastPlanetId = planetId;
          return statsHistory.byPlanet[planetId];
        };

        const addStatsSnapshot = () => {
          const gameState = getGameState();
          const planet = generatePlanet(gameState.seed);
          const colony = calculateColonyKPIs(planet, collectBuildings());
          
          const bucket = getCurrentStatsBucket();
          const timestamp = Date.now();
          bucket.population.push(colony.population);
          bucket.satisfaction.push(colony.satisfaction);
          bucket.emissions.push(colony.emissions);
          bucket.energy.push(colony.energy);
          bucket.water.push(colony.water);
          bucket.supply.push(colony.supply);
          bucket.tradeVolume.push(tradeState.totalExported);
          bucket.timestamps.push(timestamp);
          
          // Keep only last 100 data points
          const maxPoints = 100;
          if (bucket.population.length > maxPoints) {
            bucket.population = bucket.population.slice(-maxPoints);
            bucket.satisfaction = bucket.satisfaction.slice(-maxPoints);
            bucket.emissions = bucket.emissions.slice(-maxPoints);
            bucket.energy = bucket.energy.slice(-maxPoints);
            bucket.water = bucket.water.slice(-maxPoints);
            bucket.supply = bucket.supply.slice(-maxPoints);
            bucket.tradeVolume = bucket.tradeVolume.slice(-maxPoints);
            bucket.timestamps = bucket.timestamps.slice(-maxPoints);
          }
          
          saveStatsHistory();
        };

        const renderStatsDashboard = () => {
          const dashboard = document.getElementById('stats-dashboard');
          if (!dashboard) return;
          const bucket = getCurrentStatsBucket();
          
          if (!bucket || bucket.population.length === 0) {
            dashboard.innerHTML = '<p style="text-align: center; color: var(--muted);">Keine Daten vorhanden. Starte die Simulation, um Statistiken zu sammeln.</p>';
            return;
          }
          
          const history = bucket;
          const renderChart = (title, data, maxValue, color, unit = '') => {
            const max = Math.max(...data, maxValue || 1);
            const bars = data.map((value, i) => {
              const height = (value / max) * 100;
              return `<div class="chart-bar" style="height: ${height}%; background: linear-gradient(to top, ${color}, ${color}dd);" data-value="${formatNumberShort(value)}${unit}"></div>`;
            }).join('');
            
            return `
              <div class="stat-chart">
                <h4>${title}</h4>
                <div class="chart-area">${bars}</div>
                <div class="chart-labels">
                  <span>Start</span>
                  <span>Jetzt</span>
                </div>
                <div style="margin-top: 8px; font-size: 0.75rem; color: var(--muted);">
                  Trend: ${calculateTrend(data) > 0 ? '📈' : calculateTrend(data) < 0 ? '📉' : '➡️'} 
                  ${calculateTrend(data) > 0 ? '+' : ''}${calculateTrend(data).toFixed(1)}%
                </div>
              </div>
            `;
          };
          
          dashboard.innerHTML = `
            ${renderChart('Bevölkerungswachstum', history.population, 200000, 'var(--brass)', '')}
            ${renderChart('Zufriedenheit', history.satisfaction, 100, 'var(--success)', '%')}
            ${renderChart('CO₂-Emissionen', history.emissions, 100, 'var(--warning)', '%')}
            ${renderChart('Energie', history.energy, 100, 'var(--ocean)', '%')}
            ${renderChart('Wasser', history.water, 100, 'var(--navy)', '%')}
            ${renderChart('Versorgung', history.supply, 100, 'var(--copper)', '%')}
            ${renderChart('Handelsvolumen', history.tradeVolume, 2000, 'var(--brass)', 't')}
          `;
        };

        const calculateTrend = (data) => {
          if (data.length < 2) return 0;
          const recent = data.slice(-10);
          const older = data.slice(0, 10);
          if (older.length === 0) return 0;
          const recentAvg = recent.reduce((a, b) => a + b, 0) / recent.length;
          const olderAvg = older.reduce((a, b) => a + b, 0) / older.length;
          if (olderAvg === 0) return 0;
          return ((recentAvg - olderAvg) / olderAvg) * 100;
        };

        const exportStatsCSV = () => {
          const bucket = getCurrentStatsBucket();
          if (!bucket || bucket.population.length === 0) {
            toast({ type: 'warning', title: 'Keine Daten', message: 'Es gibt keine Statistiken zum Exportieren.' });
            return;
          }
          
          const headers = ['Zeitpunkt', 'Bevölkerung', 'Zufriedenheit', 'Emissionen', 'Energie', 'Wasser', 'Versorgung', 'Handelsvolumen'];
          const rows = bucket.timestamps.map((ts, i) => {
            const date = new Date(ts).toISOString();
            return [date, bucket.population[i], bucket.satisfaction[i], bucket.emissions[i], 
                    bucket.energy[i], bucket.water[i], bucket.supply[i], bucket.tradeVolume[i]].join(',');
          });
          
          const csv = [headers.join(','), ...rows].join('\n');
          const blob = new Blob([csv], { type: 'text/csv' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `planet-sandbox-stats-${new Date().toISOString().split('T')[0]}.csv`;
          a.click();
          URL.revokeObjectURL(url);
          toast({ type: 'success', title: 'Export erfolgreich', message: 'CSV-Datei wurde heruntergeladen.' });
        };

        const exportStatsPNG = () => {
          const dashboard = document.getElementById('stats-dashboard');
          const bucket = getCurrentStatsBucket();
          if (!dashboard || !bucket || bucket.population.length === 0) {
            toast({ type: 'warning', title: 'Keine Daten', message: 'Es gibt keine Statistiken zum Exportieren.' });
            return;
          }

          const charts = [
            { title: 'Bevölkerung', data: bucket.population, color: '#b18a55', unit: '' },
            { title: 'Zufriedenheit', data: bucket.satisfaction, color: '#2f7a4b', unit: '%' },
            { title: 'Emissionen', data: bucket.emissions, color: '#c58f2a', unit: '%' },
            { title: 'Energie', data: bucket.energy, color: '#234b5c', unit: '%' },
            { title: 'Wasser', data: bucket.water, color: '#1b2b3a', unit: '%' },
            { title: 'Versorgung', data: bucket.supply, color: '#c86b3c', unit: '%' },
            { title: 'Handelsvolumen', data: bucket.tradeVolume, color: '#b18a55', unit: 't' }
          ];

          const cols = 2;
          const rows = Math.ceil(charts.length / cols);
          const chartWidth = 520;
          const chartHeight = 240;
          const padding = 40;
          const canvas = document.createElement('canvas');
          canvas.width = cols * chartWidth + padding * 2;
          canvas.height = rows * chartHeight + padding * 2;
          const ctx = canvas.getContext('2d');

          const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
          ctx.fillStyle = isDark ? '#0d1117' : '#f8efe0';
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          ctx.fillStyle = isDark ? '#e6edf3' : '#1d1a16';
          ctx.font = '18px Work Sans, sans-serif';
          ctx.fillText('Planet Sandbox – Statistiken', padding, 26);

          charts.forEach((chart, index) => {
            const col = index % cols;
            const row = Math.floor(index / cols);
            const x = padding + col * chartWidth;
            const y = padding + row * chartHeight;
            const width = chartWidth - 40;
            const height = chartHeight - 60;

            ctx.fillStyle = isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.04)';
            ctx.fillRect(x, y + 10, width, height);

            ctx.fillStyle = isDark ? '#e6edf3' : '#1d1a16';
            ctx.font = '14px Work Sans, sans-serif';
            ctx.fillText(chart.title, x, y);

            const max = Math.max(...chart.data, 1);
            ctx.strokeStyle = chart.color;
            ctx.lineWidth = 2;
            ctx.beginPath();
            chart.data.forEach((value, i) => {
              const px = x + (i / (chart.data.length - 1 || 1)) * width;
              const py = y + 10 + height - (value / max) * height;
              if (i === 0) ctx.moveTo(px, py);
              else ctx.lineTo(px, py);
            });
            ctx.stroke();

            ctx.fillStyle = isDark ? '#9da7b1' : '#5a4e44';
            ctx.font = '11px Work Sans, sans-serif';
            const latest = chart.data[chart.data.length - 1] || 0;
            ctx.fillText(`Aktuell: ${formatNumberShort(latest)}${chart.unit}`, x, y + height + 30);
          });

          canvas.toBlob((blob) => {
            if (!blob) return;
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `planet-sandbox-stats-${new Date().toISOString().split('T')[0]}.png`;
            a.click();
            URL.revokeObjectURL(url);
            toast({ type: 'success', title: 'Export erfolgreich', message: 'PNG-Datei wurde heruntergeladen.' });
          });
        };

        const clearStatsHistory = () => {
          const planetId = getActivePlanetId();
          if (confirm('Möchtest du wirklich den Statistiken-Verlauf für diesen Planeten löschen?')) {
            statsHistory.byPlanet[planetId] = {
              population: [],
              satisfaction: [],
              emissions: [],
              energy: [],
              water: [],
              supply: [],
              tradeVolume: [],
              timestamps: []
            };
            saveStatsHistory();
            renderStatsDashboard();
            toast({ type: 'success', title: 'Verlauf gelöscht', message: 'Statistiken für den aktiven Planeten wurden zurückgesetzt.' });
          }
        };

        const setupStatsDashboard = () => {
          loadStatsHistory();
          renderStatsDashboard();
          
          const exportCSV = document.getElementById('stats-export-csv');
          const exportPNG = document.getElementById('stats-export-png');
          const clearBtn = document.getElementById('stats-clear-history');
          
          if (exportCSV) exportCSV.addEventListener('click', exportStatsCSV);
          if (exportPNG) exportPNG.addEventListener('click', exportStatsPNG);
          if (clearBtn) clearBtn.addEventListener('click', clearStatsHistory);
          
          // Add snapshot every 10 seconds
          setInterval(() => {
            if (!simState.paused) {
              addStatsSnapshot();
              renderStatsDashboard();
            }
          }, 10000);
          
          // Initial snapshot
          addStatsSnapshot();
        };

        setupStatsDashboard();
        setupDiplomacy();
        setupRouteEditor();
        setupMultiPlanet();
        
        // Initial planet render
        const seedInput = document.getElementById('seed-input');
        if (seedInput) {
          renderPixelPlanet(seedInput.value || 'DEFAULT');
        }
        
        // Animate planet rotation
        let planetAnimationTimer = null;
        const animatePlanet = () => {
          const seedInput = document.getElementById('seed-input');
          if (seedInput) {
            renderPixelPlanet(seedInput.value || 'DEFAULT');
          }
        };
        const startPlanetAnimation = () => {
          if (planetAnimationTimer) clearInterval(planetAnimationTimer);
          const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
          const reducedSetting = document.getElementById('setting-reduced-motion')?.checked;
          const interval = prefersReduced || reducedSetting ? 800 : 120;
          planetAnimationTimer = setInterval(() => {
            if (!document.hidden) {
              animatePlanet();
            }
          }, interval);
        };
        startPlanetAnimation();

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('./sw.js')
            .then(() => console.log('PWA: Service Worker registriert'))
            .catch(err => console.warn('PWA: Registrierung fehlgeschlagen', err));
        }
      })();
    </script>
  </body>
</html>
